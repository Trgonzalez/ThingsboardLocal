{
  "entityType" : "DASHBOARD",
  "entity" : {
    "title" : "Main TEST",
    "image" : null,
    "mobileHide" : false,
    "mobileOrder" : null,
    "configuration" : {
      "description" : "",
      "widgets" : {
        "e9b44a17-a4e8-a720-9552-36e4cbdd0863" : {
          "typeFullFqn" : "system.map",
          "type" : "latest",
          "sizeX" : 8.5,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1741884755143,
                  "endTimeMs" : 1741971155143
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "mapType" : "geoMap",
              "layers" : [ {
                "label" : "{i18n:widgets.maps.layer.hybrid}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery",
                "referenceLayer" : "openstreetmap_hybrid"
              }, {
                "label" : "{i18n:widgets.maps.layer.satellite}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery"
              }, {
                "label" : "{i18n:widgets.maps.layer.roadmap}",
                "provider" : "openstreet",
                "layerType" : "OpenStreetMap.Mapnik"
              } ],
              "imageSource" : null,
              "markers" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : [ {
                  "name" : "temperature",
                  "type" : "timeseries",
                  "label" : "temperature",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.570889787682481,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "humidity",
                  "type" : "timeseries",
                  "label" : "humidity",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13597394595782442,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "active",
                  "type" : "attribute",
                  "label" : "active",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21080919932756603
                }, {
                  "name" : "type",
                  "type" : "entityField",
                  "label" : "Tipo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.1357587191053956
                }, {
                  "name" : "pozo",
                  "type" : "timeseries",
                  "label" : "pozo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6817815369277647,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : false,
                  "postFuncBody" : null
                }, {
                  "name" : "nivelAguada",
                  "type" : "timeseries",
                  "label" : "nivelAguada",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.41051360922605606,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "nivelTanque",
                  "type" : "timeseries",
                  "label" : "nivelTanque",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.10653271737889158,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "windDir",
                  "type" : "timeseries",
                  "label" : "windDir",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7494149641343646
                }, {
                  "name" : "windSpeed",
                  "type" : "timeseries",
                  "label" : "windSpeed",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6909522833646339
                }, {
                  "name" : "rain",
                  "type" : "timeseries",
                  "label" : "rain",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.3165646978758382
                }, {
                  "name" : "comedero1",
                  "type" : "timeseries",
                  "label" : "comedero1",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5447639875242816
                }, {
                  "name" : "comedero2",
                  "type" : "timeseries",
                  "label" : "comedero2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13120470438313603
                }, {
                  "name" : "comedero3",
                  "type" : "timeseries",
                  "label" : "comedero3",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21122955934647059
                }, {
                  "name" : "pressure",
                  "type" : "timeseries",
                  "label" : "pressure",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6357233440039781
                }, {
                  "name" : "nivelNapa",
                  "type" : "timeseries",
                  "label" : "nivelNapa",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5158796826873344
                }, {
                  "name" : "waterVolume",
                  "type" : "timeseries",
                  "label" : "waterVolume",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8649181166822368
                }, {
                  "name" : "waterLevelPerc",
                  "type" : "timeseries",
                  "label" : "waterLevelPerc",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8782297497321601
                }, {
                  "name" : "data_temperature_2",
                  "type" : "timeseries",
                  "label" : "data_temperature_2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7747460584745568
                } ],
                "label" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "${entityName}",
                  "patternFunction" : "\nvar color;\nif(data.active !== \"true\"){\n    color = 'rgb(255, 0, 0)';\n} else {\n    color = 'rgb(39, 134, 34)';\n}\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \n           '${entityLabel}' + \n        '</span>'"
                },
                "tooltip" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Temperature:</b> ${temperature:1} Â°C<br/><b>Humidity:</b> ${humidity:0} %<br/><br/><link-act name=\"navigate_to_details\">Detalles</link-act><br/>",
                  "patternFunction" : "var deviceType = data.Tipo;\r\n\r\nfunction buildRow(label, value) {\r\n    return `\r\n        <div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">\r\n            <div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:120px\">${label}</div>\r\n            <div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px;color:#29313C\">${value}</div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nif (typeof deviceType !== 'undefined') {\r\n    let content = `\r\n    <div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:'Roboto';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">\r\n        <div>${data.entityLabel ?? 'Sin nombre'}</div>\r\n        <div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>\r\n    `;\r\n\r\n    if (deviceType === \"lanza\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`);\r\n    } else if (deviceType === \"estMeteo\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Viento\", `${data.windSpeed?.toFixed(1) ?? 'N/A'} m/s`) +\r\n            buildRow(\"DirecciÃ³n\", `${data.windDir?.toFixed(0) ?? 'N/A'}Â°`) +\r\n            buildRow(\"Lluvia\", `${data.rain?.toFixed(1) ?? 'N/A'} mm`) +\r\n            buildRow(\"PresiÃ³n\", `${data.pressure?.toFixed(1) ?? 'N/A'} hPa`);\r\n    } else if (deviceType === \"pozo\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Aguada\", `${data.nivelAguada?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Nivel de Tanque\", `${data.nivelTanque?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Pozo\", estadoPozo);\r\n    } else if (deviceType === \"Ultrasonico\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Tanque\", `${data.waterLevelPerc?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Volumen de Tanque\", `${data.waterVolume?.toFixed(0) ?? 'N/A'} L`) +\r\n            buildRow(\"Temperatura\", `${data.data_temperature_2?.toFixed(1) ?? 'N/A'} Â°C`)\r\n    } else if (deviceType === \"Freatimetro\") {\r\n        content +=\r\n            buildRow(\"Nivel Napa\", `${data.nivelNapa?.toFixed(1) ?? 'N/A'} m`);\r\n    } else if (deviceType === \"comedero\") {\r\n        content +=\r\n            buildRow(\"Comedero 1\", `${data.comedero1?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 2\", `${data.comedero2?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 3\", `${data.comedero3?.toFixed(0) ?? 'N/A'} %`);\r\n    } else {\r\n        content += buildRow(\"Tipo\", \"Desconocido\");\r\n    }\r\n\r\n    content += `\r\n    <div style=\"text-align:center; margin-top:16px;\">\r\n        <link-act name=\"navigate_to_details\">Detalles</link-act>\r\n    </div>\r\n</div>`;\r\n\r\n\r\n\r\n    return content;\r\n}\r\n\r\nreturn `<b>${data.entityName ?? 'Dispositivo'}</b><br/>Tipo desconocido<br/>`;\r\n",
                  "trigger" : "click",
                  "autoclose" : true,
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "tagActions" : [ {
                    "name" : "navigate_to_details",
                    "type" : "custom",
                    "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.updateState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                    "openInSeparateDialog" : false,
                    "openInPopover" : false
                  } ]
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "sensors",
                  "size" : 48,
                  "color" : {
                    "type" : "function",
                    "color" : "rgb(255, 0, 0)",
                    "range" : null,
                    "colorFunction" : "if (data.active !== \"true\"){\n   return 'rgb(255, 0, 0)';\n} else {\n   return 'rgb(39, 134, 34)';\n}"
                  }
                },
                "markerImage" : {
                  "type" : "function",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34,
                  "imageFunction" : "return {};",
                  "images" : [ ]
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : true,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : true,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              }, {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "4db0de46-9963-11ff-d3dc-63bf8867bbd7",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : null,
                "label" : {
                  "show" : false,
                  "type" : "pattern",
                  "pattern" : "Casco",
                  "patternFunction" : null
                },
                "tooltip" : {
                  "show" : false,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "pattern",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} Â°C<br/><small>See tooltip settings for details</small>",
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "patternFunction" : null,
                  "tagActions" : null
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "home",
                  "size" : 48,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerImage" : {
                  "type" : "image",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : false,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : false,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              } ],
              "polygons" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "4db0de46-9963-11ff-d3dc-63bf8867bbd7",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : null,
                "label" : {
                  "show" : false,
                  "type" : "pattern",
                  "pattern" : "${entityName}"
                },
                "tooltip" : {
                  "show" : false,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "pattern",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
                  "offsetX" : 0,
                  "offsetY" : -1
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "fillType" : "color",
                "fillColor" : {
                  "type" : "constant",
                  "color" : "rgba(51, 136, 255, 0)",
                  "rangeKey" : null,
                  "range" : null,
                  "colorFunction" : null
                },
                "fillStripe" : {
                  "weight" : 3,
                  "color" : {
                    "type" : "constant",
                    "color" : "#8f8f8f"
                  },
                  "spaceWeight" : 9,
                  "spaceColor" : {
                    "type" : "constant",
                    "color" : "rgba(143,143,143,0)"
                  },
                  "angle" : 45
                },
                "fillImage" : {
                  "type" : "image",
                  "image" : "/assets/widget-preview-empty.svg",
                  "preserveAspectRatio" : true,
                  "opacity" : 1,
                  "angle" : 0,
                  "scale" : 1
                },
                "strokeColor" : {
                  "type" : "constant",
                  "color" : "#3388ff"
                },
                "strokeWeight" : 3,
                "polygonKey" : {
                  "name" : "fieldPerimeter",
                  "label" : "Perimetro",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3",
                  "aggregationType" : null,
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : null,
                  "postFuncBody" : null
                }
              } ],
              "circles" : [ ],
              "additionalDataSources" : [ ],
              "controlsPosition" : "topleft",
              "zoomActions" : [ "scroll", "doubleClick", "controlButtons" ],
              "scales" : [ "metric" ],
              "dragModeButton" : false,
              "fitMapBounds" : true,
              "useDefaultCenterPosition" : false,
              "defaultCenterPosition" : "0,0",
              "defaultZoomLevel" : 14,
              "mapPageSize" : 16384,
              "mapActionButtons" : [ ],
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "0"
            },
            "title" : "Map",
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "/* Oculta la barra de attribution */\r\n.leaflet-control-attribution { \r\n  display: none !important; \r\n}\r\n\r\n/* Por si tu tema pone contenedores extra */\r\n.leaflet-bottom.leaflet-right .leaflet-control-attribution {\r\n  display: none !important;\r\n}\r\n",
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "configMode" : "advanced",
            "titleFont" : null,
            "titleColor" : null,
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px",
            "titleIcon" : "map",
            "iconColor" : "#1F6BDD",
            "actions" : {
              "headerButton" : [ {
                "name" : "Editar ubicaciones",
                "buttonType" : "miniFab",
                "icon" : "edit",
                "buttonColor" : "#ffffff",
                "buttonFillColor" : "#305680",
                "customButtonStyle" : { },
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "openDashboardState",
                "targetDashboardStateId" : "edit_location_all",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "dialogTitle" : "",
                "dialogHideDashboardToolbar" : true,
                "dialogWidth" : null,
                "dialogHeight" : null,
                "openInSeparateDialog" : true,
                "openInPopover" : false,
                "id" : "5495e891-66e1-e6c8-4928-d5a1bd66a60f"
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "e9b44a17-a4e8-a720-9552-36e4cbdd0863"
        },
        "bde68678-7e78-3712-8d2b-627b5b8e8b11" : {
          "typeFullFqn" : "system.cards.entities_table",
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 6.5,
          "config" : {
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 86400000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1748637797991,
                  "endTimeMs" : 1748724197991
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "NONE",
                "limit" : 200
              }
            },
            "showTitle" : true,
            "backgroundColor" : "rgb(255, 255, 255)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "4px",
            "settings" : {
              "entitiesTitle" : "Dispositivos",
              "enableSearch" : true,
              "enableSelectColumnDisplay" : true,
              "enableStickyHeader" : false,
              "enableStickyAction" : true,
              "showCellActionsMenu" : true,
              "reserveSpaceForHiddenAction" : "true",
              "displayEntityName" : false,
              "entityNameColumnTitle" : "",
              "displayEntityLabel" : false,
              "entityLabelColumnTitle" : "",
              "displayEntityType" : false,
              "displayPagination" : false,
              "defaultPageSize" : 10,
              "pageStepCount" : 3,
              "pageStepIncrement" : 10,
              "defaultSortOrder" : "name",
              "useRowStyleFunction" : false,
              "rowStyleFunction" : ""
            },
            "title" : "Entities table",
            "dropShadow" : true,
            "enableFullscreen" : true,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400,
              "padding" : "5px 10px 5px 10px"
            },
            "useDashboardTimewindow" : false,
            "showLegend" : false,
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
              "filterId" : null,
              "dataKeys" : [ {
                "name" : "label",
                "type" : "entityField",
                "label" : "Nombre",
                "color" : "#f44336",
                "settings" : { },
                "_hash" : 0.010070857757604412,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "active",
                "type" : "attribute",
                "label" : "Estado",
                "color" : "#4caf50",
                "settings" : {
                  "customTitle" : "",
                  "columnWidth" : "0px",
                  "useCellStyleFunction" : true,
                  "cellStyleFunction" : "var color;\nif (value === \"true\") {\n    color = 'rgb(39, 134, 34)';\n} else {\n    color = 'rgb(255, 0, 0)';\n}\nreturn {\n    color: color,\n    fontSize: '18px'\n};",
                  "useCellContentFunction" : true,
                  "cellContentFunction" : "value = '&#11044;';\nreturn value;",
                  "defaultColumnVisibility" : "visible",
                  "columnSelectionToDisplay" : "enabled",
                  "disableSorting" : false
                },
                "_hash" : 0.3661306593657292,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "battVal",
                "type" : "attribute",
                "label" : "BaterÃ­a",
                "color" : "#f44336",
                "settings" : {
                  "customTitle" : "",
                  "columnWidth" : "0px",
                  "useCellStyleFunction" : false,
                  "cellStyleFunction" : "",
                  "useCellContentFunction" : true,
                  "cellContentFunction" : "if (value || value === 0) {\r\n    let progress = '39, 134, 34, 1'; // verde\r\n    let background = '234, 235, 255, 1';\r\n    let background2 = '240, 235, 255, 1';\r\n    let textColor = '#ffffff';\r\n\r\n    if (value < 25) {\r\n        progress = '209, 39, 48, 1'; // rojo\r\n        textColor = '#000000';\r\n    } else if (value < 70) {\r\n        progress = '255, 213, 102, 1'; // amarillo\r\n        textColor = '#000000';\r\n    }\r\n\r\n    const percent = value + '%';\r\n    const barHeight = '28px';\r\n    const barWidth = '60px';\r\n    const borderRadius = '6px';\r\n\r\n    return `\r\n    <div style=\"display: flex; align-items: center; gap: 6px;\">\r\n        <div style=\"position: relative; display: flex; align-items: center;\">\r\n            <!-- BaterÃ­a -->\r\n            <div style=\"position: relative; width: ${barWidth}; height: ${barHeight}; background: rgba(${background}); border-radius: ${borderRadius}; overflow: hidden; box-shadow: inset 0 0 2px rgba(0,0,0,0.2);\">\r\n                <div style=\"position: absolute; top: 0; left: 0; width: ${value}%; height: 100%; background: rgba(${progress}); border-radius: ${borderRadius};\"></div>\r\n                <div style=\"position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${textColor};\">\r\n                    ${parseFloat(value).toFixed(0)}%\r\n                </div>\r\n            </div>\r\n             <!-- Polo positivo (pegado) -->\r\n            <div style=\"width: 6px; height: 9px; background-color: rgba(${background2}); margin-left: 1px; border-radius: 2px;\"></div>\r\n        \r\n    </div>\r\n    `;\r\n} else {\r\n    return 'N/A';\r\n}\r\n",
                  "defaultColumnVisibility" : "visible",
                  "columnSelectionToDisplay" : "enabled",
                  "disableSorting" : false
                },
                "_hash" : 0.4036150317729671,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "displayTimewindow" : false,
            "configMode" : "advanced",
            "actions" : {
              "rowClick" : [ {
                "name" : "nav_devDetails",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\"; \n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.updateState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "f69d6e48-030f-98cf-7c5d-2917e9f3dc66"
              } ],
              "actionCellButton" : [ {
                "name" : "Reporte CSV",
                "icon" : "mdi:file-download",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "customPretty",
                "customHtml" : "<form #reportForm=\"ngForm\" [formGroup]=\"reportFormGroup\"\r\n      (ngSubmit)=\"generateReport()\" class=\"edit-entity-form\">\r\n\r\n  <mat-toolbar color=\"primary\">\r\n    <h2>Generar reporte CSV</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" [disabled]=\"(loading$ | async)\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <!-- Contenedor fijo para no mover layout -->\r\n  <div style=\"height: 4px;\">\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\"\r\n                      *ngIf=\"loading$ | async\"></mat-progress-bar>\r\n  </div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-form-field fxFlex class=\"mat-block\">\r\n      <mat-label>Fecha inicio</mat-label>\r\n      <input matInput [matDatepicker]=\"startPicker\" formControlName=\"startDate\" required>\r\n      <mat-datepicker-toggle matSuffix [for]=\"startPicker\"></mat-datepicker-toggle>\r\n      <mat-datepicker #startPicker></mat-datepicker>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field fxFlex class=\"mat-block\">\r\n      <mat-label>Fecha fin</mat-label>\r\n      <input matInput [matDatepicker]=\"endPicker\" formControlName=\"endDate\" required>\r\n      <mat-datepicker-toggle matSuffix [for]=\"endPicker\"></mat-datepicker-toggle>\r\n      <mat-datepicker #endPicker></mat-datepicker>\r\n    </mat-form-field>\r\n\r\n    <!-- Estado / Mensajes -->\r\n    <div style=\"min-height:24px;\">\r\n      <span *ngIf=\"status\" style=\"color:#d32f2f;\">{{status}}</span>\r\n      <span *ngIf=\"!status && success\" style=\"color:#2e7d32;\">\r\n        <mat-icon inline style=\"font-size:18px;vertical-align:middle;\">check_circle</mat-icon>\r\n        Reporte generado\r\n      </span>\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(loading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      Cancelar\r\n    </button>\r\n    <button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(loading$ | async) || reportForm.invalid\">\r\n      <span *ngIf=\"!(loading$ | async)\">Generar reporte</span>\r\n      <span *ngIf=\"loading$ | async\">Generandoâ¦</span>\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss" : ".edit-entity-form {\r\n    width: 320px;\r\n}",
                "customFunction" : "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nopenReportDialog();\r\n\r\nfunction openReportDialog() {\r\n  customDialog.customDialog(htmlTemplate, ReportDialogController).subscribe();\r\n}\r\n\r\n/* ============ Config ============ */\r\nconst BUCKET_MS = 60_000;   // agrupar por minuto\r\nconst KEY_BATCH_SIZE = 10;  // cuÃ¡ntas keys por request (evita URLs gigantes)\r\nconst PER_KEY_LIMIT = 200_000; // puntos mÃ¡ximos por key (sobra para 1 aÃ±o a 1/h)\r\n\r\n/* ============ Auth helpers ============ */\r\nfunction readLocalJwt() {\r\n  try {\r\n    for (const k of ['jwt_token','tb.auth_token','token']) {\r\n      const v = localStorage.getItem(k);\r\n      if (v && typeof v === 'string') return v.replace(/^Bearer\\s+/i,'');\r\n    }\r\n  } catch(_) {}\r\n  return null;\r\n}\r\nfunction isJwtExpired(jwt) {\r\n  try {\r\n    const p = JSON.parse(atob(jwt.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));\r\n    if (!p?.exp) return false;\r\n    return Math.floor(Date.now()/1000) >= p.exp;\r\n  } catch(_) { return false; }\r\n}\r\nasync function refreshJwtIfPossible() {\r\n  try {\r\n    const res = await fetch('/api/auth/token', { method:'POST', credentials:'include' });\r\n    if (!res.ok) return null;\r\n    const data = await res.json();\r\n    const t = data?.token || data?.jwtToken || null;\r\n    if (t) { try { localStorage.setItem('jwt_token', t); } catch(_) {} }\r\n    return t;\r\n  } catch(_) { return null; }\r\n}\r\nasync function getJwtToken() {\r\n  let t = readLocalJwt();\r\n  if (t && !isJwtExpired(t)) return t;\r\n  const r = await refreshJwtIfPossible();\r\n  return r || t || null;\r\n}\r\nasync function fetchWithAuth(url, options = {}) {\r\n  let jwt = await getJwtToken();\r\n  const headers = new Headers(options.headers || {});\r\n  if (jwt) headers.set('X-Authorization', 'Bearer ' + jwt);\r\n  headers.set('accept', headers.get('accept') || 'application/json');\r\n\r\n  let res = await fetch(url, { ...options, headers });\r\n  if (res.status === 401) {\r\n    const newJwt = await refreshJwtIfPossible();\r\n    if (newJwt) {\r\n      headers.set('X-Authorization', 'Bearer ' + newJwt);\r\n      res = await fetch(url, { ...options, headers });\r\n    }\r\n  }\r\n  console.log(jwt)\r\n  console.log(res)\r\n  return res;\r\n}\r\n\r\n/* ============ Device helpers ============ */\r\nfunction getDeviceId() {\r\n  try {\r\n    if (typeof entityId !== 'undefined' && entityId?.id) return entityId.id;\r\n    const a = widgetContext?.ctx?.stateController?.getEntityId?.();\r\n    if (a?.id) return a.id;\r\n    const b = widgetContext?.ctx?.defaultSubscription?.targetEntity?.id?.id;\r\n    if (b) return b;\r\n    const c = widgetContext?.ctx?.datasources?.[0]?.entity?.id?.id;\r\n    if (c) return c;\r\n  } catch(_) {}\r\n  return null;\r\n}\r\nasync function getDeviceLabelOrName(deviceId) {\r\n  try {\r\n    const res = await fetchWithAuth(`/api/device/${deviceId}`);\r\n    if (!res.ok) return 'dispositivo';\r\n    const dev = await res.json();\r\n    return (dev?.label && String(dev.label).trim()) || dev?.name || 'dispositivo';\r\n  } catch(_) { return 'dispositivo'; }\r\n}\r\n\r\n/* ============ Fechas ============ */\r\nfunction getDateString(v) {\r\n  if (typeof v === 'string') return v;\r\n  if (v instanceof Date) return v.toISOString().slice(0,10);\r\n  return '';\r\n}\r\nfunction normalizeDateString(input) {\r\n  if (!input) return '';\r\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(input)) return input; // YYYY-MM-DD\r\n  const m = String(input).match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/); // DD/MM/YYYY\r\n  if (m) return `${m[3]}-${m[2]}-${m[1]}`;\r\n  const d = new Date(input);\r\n  return isNaN(d) ? '' : d.toISOString().slice(0,10);\r\n}\r\nfunction toDDMMYYYY(iso) { // 'YYYY-MM-DD' -> 'dd-mm-aaaa'\r\n  const [y,m,d] = iso.split('-');\r\n  return `${d}-${m}-${y}`;\r\n}\r\nfunction pad2(n){ return String(n).padStart(2,'0'); }\r\nfunction fmtIsoLocalMinute(ts) { // 'YYYY-MM-DD HH:mm'\r\n  const d = new Date(ts);\r\n  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} `\r\n       + `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;\r\n}\r\n\r\n/* ============ visibleKeys SOLO SERVER_SCOPE ============ */\r\nasync function getServerVisibleKeys(deviceId) {\r\n  const url = `/api/plugins/telemetry/DEVICE/${deviceId}/values/attributes?serverKeys=visibleKeys`;\r\n  const res = await fetchWithAuth(url);\r\n  if (!res.ok) throw new Error('No se pudo leer visibleKeys (SERVER_SCOPE)');\r\n  const data = await res.json();\r\n\r\n  let items = [];\r\n  if (Array.isArray(data)) items = data;\r\n  else if (Array.isArray(data.server)) items = data.server;\r\n\r\n  const it = items.find(x => x?.key === 'visibleKeys' && x?.value);\r\n  if (!it) throw new Error('visibleKeys no existe en SERVER_SCOPE');\r\n  let vk = typeof it.value === 'string' ? JSON.parse(it.value) : it.value;\r\n  if (!vk || typeof vk !== 'object' || !Object.keys(vk).length) {\r\n    throw new Error('visibleKeys (SERVER_SCOPE) estÃ¡ vacÃ­o');\r\n  }\r\n\r\n  const keys = Object.keys(vk);\r\n  const meta = {};\r\n  keys.forEach(k => {\r\n    const o = vk[k] || {};\r\n    meta[k] = { label: o.label || k, unit: o.unit || '' };\r\n  });\r\n  return { keys, meta };\r\n}\r\n\r\n/* ============ Fetch Ãºnico por key (o lote), SIN interval ni agg ============ */\r\n/**\r\n * Devuelve series crudas dentro del rango, en lotes de keys, con limit alto.\r\n * { key1:[{ts,value},...], key2:[...], ... }\r\n */\r\nasync function fetchTimeseriesRaw(deviceId, keys, startTs, endTs, keyBatchSize = KEY_BATCH_SIZE, perKeyLimit = PER_KEY_LIMIT) {\r\n  const out = {};\r\n  keys.forEach(k => out[k] = []);\r\n\r\n  for (let i = 0; i < keys.length; i += keyBatchSize) {\r\n    const group = keys.slice(i, i + keyBatchSize);\r\n\r\n    const url = `/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries`\r\n      + `?keys=${encodeURIComponent(group.join(','))}`\r\n      + `&startTs=${startTs}&endTs=${endTs}`\r\n      + `&limit=${perKeyLimit}`   // trae TODO en un solo tiro por key\r\n      + `&useStrictDataTypes=false`;\r\n\r\n    const res = await fetchWithAuth(url);\r\n   \r\n    if (!res.ok) {\r\n      const txt = await res.text();\r\n      throw new Error(txt || `Error ${res.status} en Telemetry`);\r\n    }\r\n    const chunk = await res.json();\r\n\r\n    for (const k of group) {\r\n      const arr = Array.isArray(chunk?.[k]) ? chunk[k] : [];\r\n      if (arr.length) out[k] = out[k].concat(arr);\r\n    }\r\n  }\r\n\r\n  // ordenar por ts\r\n  for (const k of keys) out[k].sort((a,b)=>a.ts - b.ts);\r\n  return out;\r\n}\r\n\r\n/* ============ Bucket por minuto y CSV ============ */\r\nfunction bucketTsMin(ts) {\r\n  return Math.floor(ts / BUCKET_MS) * BUCKET_MS;\r\n}\r\n\r\nfunction buildCsvBucketed(seriesByKey, keys, meta) {\r\n  const headers = [\r\n    'fecha',\r\n    'hora',\r\n    'fecha hora', // YYYY-MM-DD HH:mm\r\n    ...keys.map(k => {\r\n      const {label, unit} = meta[k] || {label:k, unit:''};\r\n      return unit ? `${label} (${unit})` : label;\r\n    })\r\n  ];\r\n\r\n  // mapear Ãºltimo valor por minuto\r\n  const maps = {};\r\n  const bucketSet = new Set();\r\n\r\n  for (const k of keys) {\r\n    const m = new Map();\r\n    for (const p of (seriesByKey[k] || [])) {\r\n      const b = bucketTsMin(p.ts);\r\n      m.set(b, p.value);      // queda el Ãºltimo del minuto\r\n      bucketSet.add(b);\r\n    }\r\n    maps[k] = m;\r\n  }\r\n\r\n  const buckets = Array.from(bucketSet).sort((a,b)=>a-b);\r\n\r\n  let csv = headers.join(',') + '\\n';\r\n  for (const b of buckets) {\r\n    const d = new Date(b);\r\n    const fecha = d.toLocaleDateString();\r\n    const hora  = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; // estable para grÃ¡ficos\r\n    const fh    = fmtIsoLocalMinute(b);\r\n    const row = [\r\n      fecha,\r\n      hora,\r\n      fh,\r\n      ...keys.map(k => maps[k].has(b) ? maps[k].get(b) : '')\r\n    ];\r\n    csv += row.join(',') + '\\n';\r\n  }\r\n  return csv;\r\n}\r\n\r\n/* ============ Dialog Controller ============ */\r\nfunction ReportDialogController(instance) {\r\n  const vm = instance;\r\n\r\n  // Loading reactivo y flags de UI\r\n  vm.loading$ = new widgetContext.rxjs.BehaviorSubject(false);\r\n  vm.status = '';\r\n  vm.success = false;\r\n\r\n  vm.reportFormGroup = vm.fb.group({\r\n    startDate: [null, vm.validators.required],\r\n    endDate:   [null, vm.validators.required]\r\n  });\r\n\r\n  vm.cancel = () => vm.dialogRef.close(null);\r\n\r\n  vm.generateReport = async function () {\r\n    vm.status = '';\r\n    vm.success = false;\r\n    vm.loading$.next(true);\r\n\r\n    try {\r\n      if (vm.reportFormGroup.invalid) {\r\n        vm.status = 'Selecciona ambas fechas.';\r\n        return;\r\n      }\r\n\r\n      // === Fechas ===\r\n      const startRaw  = vm.reportFormGroup.get('startDate').value;\r\n      const endRaw    = vm.reportFormGroup.get('endDate').value;\r\n      const startDate = getDateString(startRaw) || normalizeDateString(String(startRaw||''));\r\n      const endDate   = getDateString(endRaw)   || normalizeDateString(String(endRaw||''));\r\n      if (!startDate || !endDate) {\r\n        vm.status = 'Selecciona ambas fechas.';\r\n        return;\r\n      }\r\n      const startTs = new Date(`${startDate}T00:00:00`).getTime();\r\n      const endTs   = new Date(`${endDate}T23:59:59`).getTime();\r\n      if (isNaN(startTs) || isNaN(endTs)) {\r\n        vm.status = 'Formato de fecha invÃ¡lido.';\r\n        return;\r\n      }\r\n\r\n      // === Device & visibleKeys (SERVER_SCOPE) ===\r\n      const deviceId    = getDeviceId();\r\n      if (!deviceId) { vm.status = 'No se pudo resolver el Device ID.'; return; }\r\n      const deviceLabel = await getDeviceLabelOrName(deviceId);\r\n      const { keys, meta } = await getServerVisibleKeys(deviceId);\r\n\r\n      // === TelemetrÃ­a cruda en lotes (rÃ¡pido) ===\r\n      const seriesByKey = await fetchTimeseriesRaw(deviceId, keys, startTs, endTs, KEY_BATCH_SIZE, PER_KEY_LIMIT);\r\n      const hasAny = keys.some(k => (seriesByKey[k]||[]).length > 0);\r\n      if (!hasAny) { vm.status = 'No hay datos en ese rango.'; return; }\r\n\r\n      // === CSV bucketizado por minuto + columna \"fecha hora\" ===\r\n      const csvCore = buildCsvBucketed(seriesByKey, keys, meta);\r\n\r\n      // === Blob y nombre de archivo (Â¡definidos acÃ¡!)\r\n      const BOM = '\\uFEFF';\r\n      const blob = new Blob([BOM + csvCore], { type: 'text/csv;charset=utf-8' });\r\n      const prettyStart = toDDMMYYYY(startDate); // dd-mm-aaaa\r\n      const prettyEnd   = toDDMMYYYY(endDate);\r\n      const safeLabel   = String(deviceLabel).trim().replace(/[^\\w\\s\\-\\.]/g, '').replace(/\\s+/g,'_');\r\n      const fileName    = `${safeLabel}_reporte_${prettyStart}_a_${prettyEnd}.csv`;\r\n\r\n      // === Apagar loading ANTES del click, mostrar Ã©xito y refrescar UI ===\r\n      vm.loading$.next(false);\r\n      vm.success = true;\r\n      instance.$scope?.$applyAsync?.();\r\n      await Promise.resolve(); // yieldea 1 tick para que Angular pinte\r\n\r\n      // === Disparar descarga ===\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = fileName;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n\r\n      // Limpieza y cierre (deja que el click salga primero)\r\n      setTimeout(() => {\r\n        try { URL.revokeObjectURL(url); } catch(_) {}\r\n        try { document.body.removeChild(a); } catch(_) {}\r\n        // cerrar el diÃ¡logo automÃ¡ticamente\r\n        vm.dialogRef.close({ ok: true, fileName });\r\n      }, 2000);\r\n\r\n    } catch (err) {\r\n      vm.status = 'Error: ' + (err?.message || err);\r\n    } finally {\r\n      // asegurar que quede apagado si hubo early return con error\r\n      if (vm.loading$.getValue()) vm.loading$.next(false);\r\n      instance.$scope?.$applyAsync?.();\r\n    }\r\n  };\r\n}\r\n\r\n",
                "customResources" : [ ],
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "6cb03410-b1ae-35bc-1273-9f0836c96bf3"
              } ]
            },
            "showTitleIcon" : false,
            "titleIcon" : "list",
            "iconColor" : null,
            "titleFont" : null,
            "titleColor" : null
          },
          "row" : 0,
          "col" : 0,
          "id" : "bde68678-7e78-3712-8d2b-627b5b8e8b11"
        },
        "ec20cec1-99ac-8c09-a11c-c1d2a049e756" : {
          "typeFullFqn" : "system.alarm_widgets.alarms_table",
          "type" : "alarm",
          "sizeX" : 10.5,
          "sizeY" : 6.5,
          "config" : {
            "timewindow" : {
              "hideAggregation" : false,
              "hideAggInterval" : false,
              "hideTimezone" : false,
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 0,
                "interval" : 1000,
                "timewindowMs" : 604800000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : null,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "NONE",
                "limit" : 200
              },
              "timezone" : null
            },
            "showTitle" : true,
            "backgroundColor" : "#FFFFFF",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "4px",
            "settings" : {
              "alarmsTitle" : "Alarmas",
              "enableSelection" : true,
              "enableSearch" : true,
              "enableSelectColumnDisplay" : true,
              "enableFilter" : true,
              "enableStickyHeader" : true,
              "enableStickyAction" : false,
              "showCellActionsMenu" : true,
              "reserveSpaceForHiddenAction" : "true",
              "displayDetails" : true,
              "allowAcknowledgment" : true,
              "allowClear" : true,
              "allowAssign" : true,
              "displayActivity" : true,
              "displayPagination" : false,
              "defaultPageSize" : 10,
              "pageStepCount" : 3,
              "pageStepIncrement" : 10,
              "defaultSortOrder" : "-createdTime",
              "useRowStyleFunction" : false,
              "rowStyleFunction" : ""
            },
            "title" : "Tabla de alarmas",
            "dropShadow" : false,
            "enableFullscreen" : true,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400,
              "padding" : "5px 10px 5px 10px"
            },
            "useDashboardTimewindow" : false,
            "showLegend" : false,
            "alarmSource" : {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
              "dataKeys" : [ {
                "name" : "createdTime",
                "type" : "alarm",
                "label" : "Fecha",
                "color" : "#2196f3",
                "settings" : {
                  "customTitle" : "",
                  "columnWidth" : "10%",
                  "useCellStyleFunction" : false,
                  "cellStyleFunction" : "",
                  "useCellContentFunction" : true,
                  "cellContentFunction" : "var startTime = value;\r\nreturn startTime ? ctx.date.transform(startTime, 'dd/MM/yy HH:mm') : '';\r\n",
                  "defaultColumnVisibility" : "visible",
                  "columnSelectionToDisplay" : "enabled",
                  "disableSorting" : false
                },
                "_hash" : 0.021092237451093787,
                "funcBody" : null,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "originatorLabel",
                "type" : "alarm",
                "label" : "Dispositivo",
                "color" : "#4caf50",
                "settings" : {
                  "customTitle" : "",
                  "columnWidth" : "10%",
                  "useCellStyleFunction" : false,
                  "cellStyleFunction" : "",
                  "useCellContentFunction" : false,
                  "cellContentFunction" : "",
                  "defaultColumnVisibility" : "visible",
                  "columnSelectionToDisplay" : "enabled",
                  "disableSorting" : false
                },
                "_hash" : 0.2780007688856758,
                "funcBody" : null,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "type",
                "type" : "alarm",
                "label" : "RazÃ³n",
                "color" : "#f44336",
                "settings" : {
                  "useCellStyleFunction" : false,
                  "cellStyleFunction" : "",
                  "useCellContentFunction" : false,
                  "cellContentFunction" : ""
                },
                "_hash" : 0.7323586880398418,
                "funcBody" : null,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "status",
                "type" : "alarm",
                "label" : "Estado",
                "color" : "#ffc107",
                "settings" : {
                  "customTitle" : "",
                  "columnWidth" : "0px",
                  "useCellStyleFunction" : true,
                  "cellStyleFunction" : "var color='black';\nif (value==\"CLEARED_UNACK\") {\n    \n}else if(value==\"ACTIVE_UNACK\"){\n    color='red'\n}\nelse if(value==\"CLEARED_ACK\"){\n    \n}\nelse if(value==\"ACTIVE_ACK\"){\n    color='red'\n}\nreturn {\n  \n  color: color\n};",
                  "useCellContentFunction" : true,
                  "cellContentFunction" : "\nif (value==\"CLEARED_UNACK\") {\n    return \"Finalizada sin reconocer\"\n}else if(value==\"ACTIVE_UNACK\"){\n    return \"Activa sin reconocer\"\n}\nelse if(value==\"CLEARED_ACK\"){\n    return \"Finalizada reconocida\"\n}\nelse if(value==\"ACTIVE_ACK\"){\n    return \"Activa reconocida\"\n}",
                  "defaultColumnVisibility" : "visible",
                  "columnSelectionToDisplay" : "enabled",
                  "disableSorting" : false
                },
                "_hash" : 0.8434022160523846,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            },
            "alarmsPollingInterval" : 5,
            "showTitleIcon" : false,
            "titleIcon" : "warning",
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "widgetStyle" : { },
            "displayTimewindow" : false,
            "actions" : {
              "actionCellButton" : [ ]
            },
            "configMode" : "advanced",
            "alarmFilterConfig" : {
              "statusList" : [ "ACTIVE", "CLEARED" ],
              "severityList" : [ ],
              "typeList" : [ ],
              "searchPropagatedAlarms" : false,
              "assignedToCurrentUser" : false,
              "assigneeId" : null
            },
            "datasources" : [ ],
            "titleFont" : null,
            "titleColor" : null,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "ec20cec1-99ac-8c09-a11c-c1d2a049e756"
        },
        "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
          "typeFullFqn" : "system.cards.markdown_card",
          "type" : "latest",
          "sizeX" : 5,
          "sizeY" : 3.5,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "e2c3a2c3-e8dc-e950-2715-6bf0c6bf0d57",
              "dataKeys" : [ {
                "name" : "title",
                "type" : "entityField",
                "label" : "Title",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.23278673876621192
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1724146213845,
                  "endTimeMs" : 1724232613845
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#FFFFFF",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "",
            "settings" : {
              "useMarkdownTextFunction" : false,
              "markdownTextPattern" : "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Sidebar Menu</title>\r\n    <link href=\"https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap\" rel=\"stylesheet\">\r\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css\">\r\n</head>\r\n\r\n<body>\r\n    <div class=\"logo-container\">\r\n        <img src=\"/api/images/public/eccgkajobndCxIy5sq6CzrRsqVljRfM\" alt=\"Logo\" class=\"logo\">\r\n    </div>\r\n    <div id=\"customerTitle\" style=\"display:none;\" >${entityName}</div>\r\n    <div class=\"sidebar\">\r\n        <a class=\"menu-item\" id=\"liveApp\">\r\n            <i class=\"fa-solid fa-map\"></i> Mapa\r\n        </a>\r\n        <div class=\"menu-item\" id=\"Devices\">\r\n            <i class=\"fas fa-wifi\"></i> Dispositivos\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Reports\" data-action=\"click\">\r\n            <i class=\"fas fa-book\"></i> Reports\r\n            <i class=\"fas fa-chevron-down\" id=\"reportsArrow\" style=\"margin-left:auto;\"></i>\r\n        </div>\r\n        <div class=\"submenu\" id=\"reportsSubmenu\">\r\n            <a id=\"WaterReport\"><i class=\"fa-solid fa-droplet\"></i>Water Salinity Reports</a>\r\n            <a id=\"EnergyReport\"><i class=\"fa-solid fa-bolt\"></i>Energy Reports</a>\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Automated\">\r\n            <i class=\"fa-solid fa-file\"></i> Automated Reports\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Alerts\">\r\n            <i class=\"fas fa-bell\"></i> Alertas\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Settings\">\r\n            <i class=\"fas fa-gear\"></i> Ajustes\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Contact\">\r\n            <i class=\"fas fa-question-circle\"></i> Contacto\r\n        </div>\r\n    </div>\r\n</body>\r\n</html>\r\n",
              "markdownTextFunction" : "// === Mapeo itemId â stateId (AJUSTAR A TU DASHBOARD) ===\r\nconst stateMap = {\r\n  liveApp:     'default',\r\n  Devices:     'devices',\r\n  Reports:     null, // solo expande submenÃº\r\n  WaterReport: 'water_report_state',\r\n  EnergyReport:'energy_report_state',\r\n  Automated:   'automated_reports_state',\r\n  Alerts:      'alarms',\r\n  Contact:     'contact_state'\r\n};\r\n\r\n// ID Ãºnico para este render (evita choques si hay varios widgets)\r\nconst uid = 'sb_' + Math.random().toString(36).slice(2);\r\n\r\n// HTML (sin <script> y sin href que cambie la URL)\r\nconst html =\r\n  '<div id=\"'+uid+'\" class=\"sidebar\">' +\r\n\r\n    '<a class=\"menu-item\" data-item=\"liveApp\">' +\r\n      '<i class=\"fa-solid fa-map\"></i> Mapa' +\r\n    '</a>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Devices\">' +\r\n      '<i class=\"fas fa-wifi\"></i> Devices' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Reports\" data-expand=\"reportsSubmenu\">' +\r\n      '<i class=\"fas fa-book\"></i> Reports' +\r\n      '<i class=\"fas fa-chevron-down\" style=\"margin-left:auto;\"></i>' +\r\n    '</div>' +\r\n\r\n    '<div class=\"submenu\" id=\"reportsSubmenu\">' +\r\n      '<a data-item=\"WaterReport\"><i class=\"fa-solid fa-droplet\"></i> Water Salinity Reports</a>' +\r\n      '<a data-item=\"EnergyReport\"><i class=\"fa-solid fa-bolt\"></i> Energy Reports</a>' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Automated\">' +\r\n      '<i class=\"fa-solid fa-file\"></i> Automated Reports' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Alerts\">' +\r\n      '<i class=\"fas fa-bell\"></i> Alerts' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Contact\">' +\r\n      '<i class=\"fas fa-question-circle\"></i> Contact' +\r\n    '</div>' +\r\n\r\n  '</div>';\r\n\r\n// Bind de eventos despuÃ©s de que TB inserta el HTML\r\nsetTimeout(function () {\r\n  const root = document.getElementById(uid);\r\n  if (!root || root.__bound) return;\r\n  root.__bound = true;\r\n\r\n  const submenu = root.querySelector('#reportsSubmenu');\r\n\r\n  function clearActive() {\r\n    root.querySelectorAll('.active').forEach(n => {\r\n      n.classList.remove('active');\r\n      n.setAttribute('aria-disabled', 'false');\r\n    });\r\n  }\r\n  function setActive(el) {\r\n    clearActive();\r\n    el.classList.add('active');\r\n    el.setAttribute('aria-disabled', 'true');\r\n  }\r\n  function openStateFor(itemId) {\r\n    const stateId = stateMap[itemId];\r\n    if (!stateId) return; // p.ej. Reports\r\n    try {\r\n      // usa ctx del scope de la funciÃ³n de valor\r\n      if (ctx && ctx.stateController && typeof ctx.stateController.openState === 'function') {\r\n        ctx.stateController.openState(stateId);\r\n        return;\r\n      }\r\n      if (ctx && ctx.actionsApi && typeof ctx.actionsApi.openDashboard === 'function') {\r\n        ctx.actionsApi.openDashboard(null, { stateId }, { openInDialog: false });\r\n      }\r\n    } catch (e) { /* silencioso */ }\r\n  }\r\n\r\n  // DelegaciÃ³n de clicks (sin cambiar la URL)\r\n  root.addEventListener('click', function (e) {\r\n    const item = e.target.closest('[data-item]');\r\n    if (!item || !root.contains(item)) return;\r\n    const id = item.getAttribute('data-item');\r\n\r\n    // Toggle Reports (expansor)\r\n    if (id === 'Reports') {\r\n      e.preventDefault();\r\n      submenu && submenu.classList.toggle('open');\r\n      setActive(item);\r\n      return;\r\n    }\r\n\r\n    e.preventDefault();\r\n    setActive(item);\r\n    openStateFor(id);\r\n  });\r\n\r\n  // Activo inicial (opcional)\r\n  const initial = root.querySelector('[data-item=\"Devices\"]');\r\n  if (initial) {\r\n    setActive(initial);\r\n    // openStateFor('Devices'); // descomentÃ¡ si querÃ©s abrir al cargar\r\n  }\r\n}, 0);\r\n\r\n// devolver el HTML al widget\r\nreturn html;\r\n",
              "applyDefaultMarkdownStyle" : false,
              "markdownCss" : "/* Mantener oculto el logo */\r\n.logo-container { display:none !important; margin:0 !important; padding:0 !important; }\r\n\r\n/* Base */\r\nbody {\r\n    font-family: 'Roboto', sans-serif;\r\n    margin: 0;\r\n    padding: 0;\r\n    background-color: #fff;\r\n}\r\n\r\n/* (Tu bloque extra de logo no es necesario si estÃ¡ oculto) */\r\n/* .logo-container { ... }  â eliminado */\r\n\r\n/* .logo { ... } â innecesario si no se muestra el logo */\r\n/* .logo { width:auto; max-width:100%; } */\r\n\r\n.sidebar {\r\n    width: 100%;\r\n    height: 100vh;\r\n    background-color: #ffffff;\r\n    padding: 0;\r\n}\r\n\r\n/* Ãtems de menÃº */\r\n.menu-item, .submenu a {\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: flex-start;\r\n    height: 60px;              /* 50px en submenÃº abajo */\r\n    padding: 0 20px;\r\n    width: 100%;\r\n    color: #333;\r\n    text-decoration: none;\r\n    font-size: 16px;           /* 14px en submenÃº abajo */\r\n    cursor: pointer;\r\n    transition: background-color 0.3s ease, color .2s ease;\r\n    box-sizing: border-box;\r\n}\r\n\r\n.menu-item:hover,\r\n.submenu a:hover {\r\n    background-color: rgba(235, 235, 235, 0.5); /* 50% opacity */\r\n}\r\n\r\n.menu-item i,\r\n.submenu a i {\r\n    margin-right: 10px;\r\n}\r\n\r\n/* SubmenÃº */\r\n.submenu {\r\n    padding-left: 0;\r\n    display: none;             /* oculto por defecto */\r\n    user-select: none;\r\n    flex-direction: column;\r\n}\r\n\r\n.submenu a {\r\n    height: 50px;\r\n    font-size: 14px;\r\n    background-color: #eee;\r\n    transition: background-color 0.3s ease, color .2s ease;\r\n}\r\n\r\n.submenu a:hover {\r\n    background-color: rgba(235, 96, 96, 0.7); /* 70% opacity */\r\n}\r\n\r\n/* Flecha rotada cuando Reports estÃ¡ activo (si usÃ¡s el Ã­cono con ese id) */\r\n#Reports:target + #reportsSubmenu + .menu-item .fa-chevron-down,\r\n#Reports:target .fa-chevron-down {\r\n    transform: rotate(180deg);\r\n}\r\n\r\n/* Abrir submenÃº cuando \"Reports\" es el :target */\r\n#Reports:target + #reportsSubmenu {\r\n    display: flex;\r\n}\r\n\r\n/* Estado ACTIVO usando :target (hash) */\r\n.menu-item:target,\r\n.submenu a:target {\r\n    background: #1f6feb;\r\n    color: #fff;\r\n}\r\n\r\n/* Deshabilitado visual mientras estÃ¡ activo */\r\n.menu-item:target,\r\n.submenu a:target {\r\n    pointer-events: none;      /* no clickeable mientras activo */\r\n    cursor: default;\r\n}\r\n\r\n/* Borde superior en Contact (lo mantenemos) */\r\n#Settings{\r\n    border-top: solid #b8bfd4 1px;\r\n}\r\n"
            },
            "title" : "Markdown/HTML Card",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "actions" : {
              "elementClick" : [ {
                "name" : "liveApp",
                "icon" : "map",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "default",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "7ae4f14c-e248-b709-2194-e251d4fb4def"
              }, {
                "name" : "Devices",
                "icon" : "wifi",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "devices",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "d1499cfd-7409-e619-b835-ff1edac50622"
              }, {
                "name" : "Automated",
                "icon" : "description",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "deviceSummary",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "011cac58-e56e-b396-d969-94361e3d8f5a"
              }, {
                "name" : "Alerts",
                "icon" : "notifications",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "alarms",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "24e6e7a0-0adc-b860-7c12-6be7d528142e"
              }, {
                "name" : "Contact",
                "icon" : "help",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "openURL",
                "openNewBrowserTab" : true,
                "url" : "https://www.google.com",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "52b5652f-de35-1ce5-b83e-63bde7f86f51"
              }, {
                "name" : "Reports",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "// Arrays for categorizing customers\r\nvar OnlyWater = [\"Customer A\",];\r\nvar OnlyEnergy = [\"Customer B\", \"Customer C\"];\r\nvar AllReports = [\"Customer D\"];\r\n\r\n// Retrieve the customer_title from the hidden div\r\nvar customerTitle = widgetContext.$container.find('#customerTitle').text().trim();\r\n\r\n// Find the submenu elements\r\nvar waterReport = widgetContext.$container.find('#WaterReport');\r\nvar energyReport = widgetContext.$container.find('#EnergyReport');\r\n\r\n// Find the Reports submenu and arrow\r\nvar reportsSubmenu = widgetContext.$container.find('#reportsSubmenu');\r\nvar reportsArrow = widgetContext.$container.find('#reportsArrow');\r\n\r\n// Toggle the visibility of the submenu directly based on the current state\r\nif (reportsSubmenu.is(':visible')) {\r\n    reportsSubmenu.hide();\r\n    reportsArrow.removeClass('rotate');\r\n} else {\r\n    reportsSubmenu.show();\r\n    reportsArrow.addClass('rotate');\r\n}\r\n\r\n// Determine which report options to show based on the customer title\r\nif (OnlyWater.includes(customerTitle)) {\r\n    waterReport.show();\r\n    energyReport.hide();\r\n} else if (OnlyEnergy.includes(customerTitle)) {\r\n    waterReport.hide();\r\n    energyReport.show();\r\n} else if (AllReports.includes(customerTitle)) {\r\n    waterReport.show();\r\n    energyReport.show();\r\n} else {\r\n    // Default behavior: Show all reports if the customer is not listed in any array\r\n    waterReport.show();\r\n    energyReport.show();\r\n}\r\n",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "d5c95e9f-c076-8c41-6b8a-edd6a750070a"
              }, {
                "name" : "WaterReport",
                "icon" : "water_drop",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "reports",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "f9505310-c43c-e0e0-4706-497157b80574"
              }, {
                "name" : "EnergyReport",
                "icon" : "bolt",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "Energy Reports",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "7c95a652-62a4-f26e-3631-5477d63c6c3b"
              }, {
                "name" : "Settings",
                "icon" : "settings",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "settings",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "e2df470d-2e7b-2607-6316-9159a05bc1fd"
              } ]
            },
            "enableDataExport" : false,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "margin" : "0px"
          },
          "row" : 0,
          "col" : 0,
          "id" : "35346681-a6d0-f40e-e68f-4998d0978a2e"
        },
        "db950ff4-5a07-3715-4cac-723c6f3ddc97" : {
          "typeFullFqn" : "system.action_button",
          "type" : "latest",
          "sizeX" : 3,
          "sizeY" : 1,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1758663761812,
                  "endTimeMs" : 1758750161812
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#FFFFFF01",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "activatedState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : false,
                "getAttribute" : {
                  "key" : "state",
                  "scope" : null
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "compareToValue" : true,
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;"
                }
              },
              "disabledState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : true,
                "executeRpc" : {
                  "method" : null,
                  "requestTimeout" : null,
                  "requestPersistent" : null,
                  "persistentPollingInterval" : null
                },
                "getAttribute" : {
                  "scope" : null,
                  "key" : "state"
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;",
                  "compareToValue" : true
                }
              },
              "appearance" : {
                "type" : "underlined",
                "showLabel" : true,
                "label" : "Alarmas",
                "showIcon" : true,
                "icon" : "notifications_active",
                "iconSize" : 24,
                "iconSizeUnit" : "px",
                "mainColor" : "#3F52DD",
                "backgroundColor" : "#FFFFFF",
                "autoScale" : true,
                "customStyle" : {
                  "enabled" : null,
                  "hovered" : null,
                  "pressed" : null,
                  "activated" : null,
                  "disabled" : null
                }
              }
            },
            "title" : "Action button",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "borderRadius" : "4px",
            "configMode" : "basic",
            "actions" : {
              "click" : [ {
                "id" : "19ca82dd-f1ca-186a-ff3a-ad9591b4442c",
                "name" : "onClick",
                "icon" : "more_horiz",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "alarms",
                "openRightLayout" : false,
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openInSeparateDialog" : false,
                "openInPopover" : false
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "db950ff4-5a07-3715-4cac-723c6f3ddc97"
        },
        "194b430a-d590-85f8-e70e-b994c1ff8713" : {
          "typeFullFqn" : "system.action_button",
          "type" : "latest",
          "sizeX" : 3,
          "sizeY" : 1,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1758663761812,
                  "endTimeMs" : 1758750161812
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#FFFFFF01",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "activatedState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : false,
                "getAttribute" : {
                  "key" : "state",
                  "scope" : null
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "compareToValue" : true,
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;"
                }
              },
              "disabledState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : false,
                "getAttribute" : {
                  "key" : "state",
                  "scope" : null
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "compareToValue" : true,
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;"
                }
              },
              "appearance" : {
                "type" : "underlined",
                "showLabel" : true,
                "label" : "Dispositivos",
                "showIcon" : true,
                "icon" : "sensors",
                "iconSize" : 24,
                "iconSizeUnit" : "px",
                "mainColor" : "#3F52DD",
                "backgroundColor" : "#FFFFFF",
                "autoScale" : true,
                "customStyle" : {
                  "enabled" : null,
                  "hovered" : null,
                  "pressed" : null,
                  "activated" : null,
                  "disabled" : null
                }
              }
            },
            "title" : "Action button",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "borderRadius" : "4px",
            "configMode" : "basic",
            "actions" : {
              "click" : [ {
                "id" : "19ca82dd-f1ca-186a-ff3a-ad9591b4442c",
                "name" : "onClick",
                "icon" : "more_horiz",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "devices",
                "openRightLayout" : false,
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openInSeparateDialog" : false,
                "openInPopover" : false
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "194b430a-d590-85f8-e70e-b994c1ff8713"
        },
        "9d7e46d2-1a47-ab6c-6dcf-510dee09671c" : {
          "typeFullFqn" : "system.action_button",
          "type" : "latest",
          "sizeX" : 3,
          "sizeY" : 1,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1758663761812,
                  "endTimeMs" : 1758750161812
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#FFFFFF01",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "activatedState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : false,
                "getAttribute" : {
                  "key" : "state",
                  "scope" : null
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "compareToValue" : true,
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;"
                }
              },
              "disabledState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : false,
                "getAttribute" : {
                  "key" : "state",
                  "scope" : null
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "compareToValue" : true,
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;"
                }
              },
              "appearance" : {
                "type" : "underlined",
                "showLabel" : true,
                "label" : "Home",
                "showIcon" : true,
                "icon" : "home",
                "iconSize" : 24,
                "iconSizeUnit" : "px",
                "mainColor" : "#3F52DD",
                "backgroundColor" : "#FFFFFF",
                "autoScale" : true,
                "customStyle" : {
                  "enabled" : null,
                  "hovered" : null,
                  "pressed" : null,
                  "activated" : null,
                  "disabled" : null
                }
              }
            },
            "title" : "Action button",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "borderRadius" : "4px",
            "configMode" : "basic",
            "actions" : {
              "click" : [ {
                "id" : "19ca82dd-f1ca-186a-ff3a-ad9591b4442c",
                "name" : "onClick",
                "icon" : "more_horiz",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "default",
                "openRightLayout" : false,
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openInSeparateDialog" : false,
                "openInPopover" : false
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "9d7e46d2-1a47-ab6c-6dcf-510dee09671c"
        },
        "61b8a4c1-a6f1-6281-442d-3f7106a11bb0" : {
          "typeFullFqn" : "system.alarm_count",
          "type" : "latest",
          "sizeX" : 3.5,
          "sizeY" : 1.5,
          "config" : {
            "datasources" : [ {
              "type" : "alarmCount",
              "name" : "",
              "entityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
              "dataKeys" : [ {
                "name" : "count",
                "type" : "count",
                "label" : "count",
                "settings" : { },
                "_hash" : 0.9181540205118637
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ],
                "severityList" : [ ],
                "assignedToCurrentUser" : false,
                "assigneeId" : null
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1758840516424,
                  "endTimeMs" : 1758926916424
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgb(255, 255, 255)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "layout" : "column",
              "autoScale" : true,
              "showLabel" : true,
              "label" : "Alarmas Activas",
              "labelFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "16px"
              },
              "labelColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.54)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIcon" : true,
              "iconSize" : 20,
              "iconSizeUnit" : "px",
              "icon" : "warning",
              "iconColor" : {
                "type" : "constant",
                "color" : "rgba(255, 255, 255, 1)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIconBackground" : true,
              "iconBackgroundSize" : 36,
              "iconBackgroundSizeUnit" : "px",
              "iconBackgroundColor" : {
                "color" : "rgba(0, 105, 92, 1)",
                "type" : "range",
                "rangeList" : {
                  "range" : [ {
                    "from" : 0,
                    "to" : 0,
                    "color" : "rgba(0, 105, 92, 1)"
                  }, {
                    "from" : 1,
                    "to" : null,
                    "color" : "rgba(209, 39, 48, 1)"
                  } ],
                  "advancedMode" : false
                },
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "valueFont" : {
                "family" : "Roboto",
                "size" : 20,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "24px"
              },
              "valueColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showChevron" : true,
              "chevronSize" : 24,
              "chevronSizeUnit" : "px",
              "chevronColor" : "rgba(0, 0, 0, 0.38)"
            },
            "title" : "Alarmas activas",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "units" : "",
            "decimals" : null,
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "widgetStyle" : { },
            "actions" : {
              "cardClick" : [ {
                "name" : "navigate-alarms",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "alarms",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "197e0df7-5be0-263a-2fac-7c0d049273ad"
              } ]
            },
            "configMode" : "advanced",
            "displayTimewindow" : true,
            "margin" : "0px",
            "borderRadius" : "0px",
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "titleFont" : {
              "size" : 12,
              "sizeUnit" : "px",
              "family" : null,
              "weight" : null,
              "style" : null,
              "lineHeight" : "1"
            },
            "titleIcon" : "",
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "14px",
            "timewindowStyle" : {
              "showIcon" : true,
              "iconSize" : "14px",
              "icon" : "query_builder",
              "iconPosition" : "left",
              "font" : {
                "size" : 12,
                "sizeUnit" : "px",
                "family" : null,
                "weight" : null,
                "style" : null,
                "lineHeight" : "1"
              },
              "color" : null
            },
            "titleColor" : "rgba(0, 0, 0, 0.54)"
          },
          "row" : 0,
          "col" : 0,
          "id" : "61b8a4c1-a6f1-6281-442d-3f7106a11bb0"
        },
        "a04df291-ae01-490d-3608-b1fb5639ae0e" : {
          "typeFullFqn" : "system.entity_count",
          "type" : "latest",
          "sizeX" : 3.5,
          "sizeY" : 1.5,
          "config" : {
            "datasources" : [ {
              "type" : "entityCount",
              "name" : "",
              "entityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
              "filterId" : null,
              "dataKeys" : [ {
                "name" : "count",
                "type" : "count",
                "label" : "count",
                "settings" : { },
                "_hash" : 0.7957483904850419
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ],
                "assignedToCurrentUser" : false,
                "assigneeId" : null
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1758840780784,
                  "endTimeMs" : 1758927180784
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgb(255, 255, 255)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "layout" : "column",
              "autoScale" : true,
              "showLabel" : true,
              "label" : "Dispositivos",
              "labelFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "16px"
              },
              "labelColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.54)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIcon" : true,
              "iconSize" : 20,
              "iconSizeUnit" : "px",
              "icon" : "mdi:antenna",
              "iconColor" : {
                "type" : "constant",
                "color" : "rgba(255, 255, 255, 1)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIconBackground" : true,
              "iconBackgroundSize" : 36,
              "iconBackgroundSizeUnit" : "px",
              "iconBackgroundColor" : {
                "type" : "constant",
                "color" : "rgb(241, 141, 23)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';",
                "rangeList" : {
                  "advancedMode" : false,
                  "range" : [ ]
                }
              },
              "valueFont" : {
                "family" : "Roboto",
                "size" : 20,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "24px"
              },
              "valueColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showChevron" : true,
              "chevronSize" : 24,
              "chevronSizeUnit" : "px",
              "chevronColor" : "rgba(0, 0, 0, 0.38)"
            },
            "title" : "Entity count",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "units" : "",
            "decimals" : null,
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "widgetStyle" : { },
            "actions" : {
              "cardClick" : [ {
                "name" : "navigate-devices",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "devices",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "e089759b-fac8-66d6-4b63-439ad1dbca01"
              } ]
            },
            "configMode" : "advanced",
            "displayTimewindow" : true,
            "margin" : "0px",
            "borderRadius" : "0px",
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "titleFont" : {
              "size" : 12,
              "sizeUnit" : "px",
              "family" : null,
              "weight" : null,
              "style" : null,
              "lineHeight" : "1"
            },
            "titleIcon" : "",
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "14px",
            "timewindowStyle" : {
              "showIcon" : true,
              "iconSize" : "14px",
              "icon" : "query_builder",
              "iconPosition" : "left",
              "font" : {
                "size" : 12,
                "sizeUnit" : "px",
                "family" : null,
                "weight" : null,
                "style" : null,
                "lineHeight" : "1"
              },
              "color" : null
            },
            "titleColor" : "rgba(0, 0, 0, 0.54)"
          },
          "row" : 0,
          "col" : 0,
          "id" : "a04df291-ae01-490d-3608-b1fb5639ae0e"
        },
        "cdd2fc91-0d65-de77-ef91-727493e2502f" : {
          "typeFullFqn" : "system.map",
          "type" : "latest",
          "sizeX" : 8.5,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1741884755143,
                  "endTimeMs" : 1741971155143
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "mapType" : "geoMap",
              "layers" : [ {
                "label" : "{i18n:widgets.maps.layer.hybrid}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery",
                "referenceLayer" : "openstreetmap_hybrid"
              }, {
                "label" : "{i18n:widgets.maps.layer.satellite}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery"
              }, {
                "label" : "{i18n:widgets.maps.layer.roadmap}",
                "provider" : "openstreet",
                "layerType" : "OpenStreetMap.Mapnik"
              } ],
              "imageSource" : null,
              "markers" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
                "dsFilterId" : "50be9efa-7b06-c731-f543-aff20c73c420",
                "additionalDataSources" : null,
                "additionalDataKeys" : [ {
                  "name" : "temperature",
                  "type" : "timeseries",
                  "label" : "temperature",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.570889787682481,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "humidity",
                  "type" : "timeseries",
                  "label" : "humidity",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13597394595782442,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "active",
                  "type" : "attribute",
                  "label" : "active",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21080919932756603
                }, {
                  "name" : "type",
                  "type" : "entityField",
                  "label" : "Tipo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.1357587191053956
                }, {
                  "name" : "pozo",
                  "type" : "timeseries",
                  "label" : "pozo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6817815369277647,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : false,
                  "postFuncBody" : null
                }, {
                  "name" : "nivelAguada",
                  "type" : "timeseries",
                  "label" : "nivelAguada",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.41051360922605606,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "nivelTanque",
                  "type" : "timeseries",
                  "label" : "nivelTanque",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.10653271737889158,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "windDir",
                  "type" : "timeseries",
                  "label" : "windDir",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7494149641343646
                }, {
                  "name" : "windSpeed",
                  "type" : "timeseries",
                  "label" : "windSpeed",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6909522833646339
                }, {
                  "name" : "rain",
                  "type" : "timeseries",
                  "label" : "rain",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.3165646978758382
                }, {
                  "name" : "comedero1",
                  "type" : "timeseries",
                  "label" : "comedero1",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5447639875242816
                }, {
                  "name" : "comedero2",
                  "type" : "timeseries",
                  "label" : "comedero2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13120470438313603
                }, {
                  "name" : "comedero3",
                  "type" : "timeseries",
                  "label" : "comedero3",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21122955934647059
                }, {
                  "name" : "pressure",
                  "type" : "timeseries",
                  "label" : "pressure",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6357233440039781
                }, {
                  "name" : "nivelNapa",
                  "type" : "timeseries",
                  "label" : "nivelNapa",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5158796826873344
                }, {
                  "name" : "waterVolume",
                  "type" : "timeseries",
                  "label" : "waterVolume",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8649181166822368
                }, {
                  "name" : "waterLevelPerc",
                  "type" : "timeseries",
                  "label" : "waterLevelPerc",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8782297497321601
                }, {
                  "name" : "data_temperature_2",
                  "type" : "timeseries",
                  "label" : "data_temperature_2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7747460584745568
                } ],
                "label" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "${entityName}",
                  "patternFunction" : "\nvar color;\nif(data.active !== \"true\"){\n    color = 'rgb(255, 0, 0)';\n} else {\n    color = 'rgb(39, 134, 34)';\n}\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \n           '${entityLabel}' + \n        '</span>'"
                },
                "tooltip" : {
                  "show" : true,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "function",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Temperature:</b> ${temperature:1} Â°C<br/><b>Humidity:</b> ${humidity:0} %<br/><br/><link-act name=\"navigate_to_details\">Detalles</link-act><br/>",
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "patternFunction" : "var deviceType = data.Tipo;\r\n\r\nfunction buildRow(label, value) {\r\n    return `\r\n        <div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">\r\n            <div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:120px\">${label}</div>\r\n            <div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px;color:#29313C\">${value}</div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nif (typeof deviceType !== 'undefined') {\r\n    let content = `\r\n    <div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:'Roboto';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">\r\n        <div>${data.entityLabel ?? 'Sin nombre'}</div>\r\n        <div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>\r\n    `;\r\n\r\n    if (deviceType === \"lanza\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`);\r\n    } else if (deviceType === \"estMeteo\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Viento\", `${data.windSpeed?.toFixed(1) ?? 'N/A'} m/s`) +\r\n            buildRow(\"DirecciÃ³n\", `${data.windDir?.toFixed(0) ?? 'N/A'}Â°`) +\r\n            buildRow(\"Lluvia\", `${data.rain?.toFixed(1) ?? 'N/A'} mm`) +\r\n            buildRow(\"PresiÃ³n\", `${data.pressure?.toFixed(1) ?? 'N/A'} hPa`);\r\n    } else if (deviceType === \"pozo\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Aguada\", `${data.nivelAguada?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Nivel de Tanque\", `${data.nivelTanque?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Pozo\", estadoPozo);\r\n    } else if (deviceType === \"Ultrasonico\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Tanque\", `${data.waterLevelPerc?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Volumen de Tanque\", `${data.waterVolume?.toFixed(0) ?? 'N/A'} L`) +\r\n            buildRow(\"Temperatura\", `${data.data_temperature_2?.toFixed(1) ?? 'N/A'} Â°C`)\r\n    } else if (deviceType === \"Freatimetro\") {\r\n        content +=\r\n            buildRow(\"Nivel Napa\", `${data.nivelNapa?.toFixed(1) ?? 'N/A'} m`);\r\n    } else if (deviceType === \"comedero\") {\r\n        content +=\r\n            buildRow(\"Comedero 1\", `${data.comedero1?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 2\", `${data.comedero2?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 3\", `${data.comedero3?.toFixed(0) ?? 'N/A'} %`);\r\n    } else {\r\n        content += buildRow(\"Tipo\", \"Desconocido\");\r\n    }\r\n\r\n    content += `\r\n    <div style=\"text-align:center; margin-top:16px;\">\r\n        <link-act name=\"navigate_to_details\">Detalles</link-act>\r\n    </div>\r\n</div>`;\r\n\r\n\r\n\r\n    return content;\r\n}\r\n\r\nreturn `<b>${data.entityName ?? 'Dispositivo'}</b><br/>Tipo desconocido<br/>`;\r\n",
                  "tagActions" : [ {
                    "name" : "navigate_to_details",
                    "type" : "custom",
                    "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.openState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                    "openInSeparateDialog" : false,
                    "openInPopover" : false
                  } ]
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "sensors",
                  "size" : 48,
                  "color" : {
                    "type" : "function",
                    "color" : "rgb(255, 0, 0)",
                    "range" : null,
                    "colorFunction" : "if (data.active !== \"true\"){\n   return 'rgb(255, 0, 0)';\n} else {\n   return 'rgb(39, 134, 34)';\n}"
                  }
                },
                "markerImage" : {
                  "type" : "function",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34,
                  "imageFunction" : "return {};",
                  "images" : [ ]
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : true,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : true,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              } ],
              "polygons" : [ ],
              "circles" : [ ],
              "additionalDataSources" : [ ],
              "controlsPosition" : "topleft",
              "zoomActions" : [ "scroll", "doubleClick", "controlButtons" ],
              "scales" : [ "metric" ],
              "dragModeButton" : false,
              "fitMapBounds" : true,
              "useDefaultCenterPosition" : false,
              "defaultCenterPosition" : "0,0",
              "defaultZoomLevel" : 14,
              "mapPageSize" : 16384,
              "mapActionButtons" : [ ],
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "0"
            },
            "title" : "Map",
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "/* Oculta la barra de attribution */\r\n.leaflet-control-attribution { \r\n  display: none !important; \r\n}\r\n\r\n/* Por si tu tema pone contenedores extra */\r\n.leaflet-bottom.leaflet-right .leaflet-control-attribution {\r\n  display: none !important;\r\n}\r\n",
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "configMode" : "advanced",
            "titleFont" : null,
            "titleColor" : null,
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px",
            "titleIcon" : "map",
            "iconColor" : "#1F6BDD",
            "actions" : { }
          },
          "row" : 0,
          "col" : 0,
          "id" : "cdd2fc91-0d65-de77-ef91-727493e2502f"
        },
        "a0a086d3-4855-b1eb-8297-540de5147d73" : {
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : null,
              "entityAliasId" : "c5728f69-c11d-5b71-9941-af192de00fbb",
              "filterId" : null,
              "dataKeys" : [ {
                "name" : "Freatimetro",
                "type" : "attribute",
                "label" : "Freatimetro",
                "color" : "#f44336",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanSwitch",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "before",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "mdi:waves-arrow-up",
                  "customIcon" : "tb-image;/api/images/tenant/fuel_level_monitoring_dashboard_widget_filter_custom_icon.svg",
                  "useGetValueFunction" : true,
                  "getValueFunctionBody" : "return !value || value === 'Freatimetro';",
                  "useSetValueFunction" : true,
                  "setValueFunctionBody" : "return value ? 'Freatimetro' : 'unset';"
                },
                "_hash" : 0.05083578452347459,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "Comedero",
                "type" : "attribute",
                "label" : "Comedero",
                "color" : "#2196f3",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanSwitch",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "before",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "mdi:barley",
                  "customIcon" : "tb-image;/api/images/tenant/fuel_level_monitoring_dashboard_widget_filter_custom_icon_(1).svg",
                  "useGetValueFunction" : true,
                  "getValueFunctionBody" : "return !value || value === 'Comedero';",
                  "useSetValueFunction" : true,
                  "setValueFunctionBody" : "return value ? 'Comedero' : 'unset';"
                },
                "_hash" : 0.5184545311042434,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null,
                "aggregationType" : null
              }, {
                "name" : "Ultrasonico",
                "type" : "attribute",
                "label" : "Aguada",
                "color" : "#f44336",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanSwitch",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "before",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "water",
                  "customIcon" : "tb-image;/api/images/tenant/fuel_level_monitoring_dashboard_widget_filter_custom_icon_(2).svg",
                  "useGetValueFunction" : true,
                  "getValueFunctionBody" : "return !value || value === 'Ultrasonico';",
                  "useSetValueFunction" : true,
                  "setValueFunctionBody" : "return value ? 'Ultrasonico' : 'unset';"
                },
                "_hash" : 0.39082762251115444,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null,
                "aggregationType" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1682001930247,
                  "endTimeMs" : 1682088330247
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0,0,0,0.04)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "showResultMessage" : false,
              "showActionButtons" : false,
              "showGroupTitle" : false,
              "fieldsAlignment" : "column",
              "rowGap" : 10,
              "groupTitle" : "${entityName}",
              "fieldsInRow" : 2,
              "columnGap" : 10
            },
            "title" : "Filter",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "enableDataExport" : false,
            "widgetStyle" : {
              "fontWeight" : "bold",
              "fontSize" : "14px"
            },
            "titleStyle" : {
              "fontSize" : "20px",
              "fontWeight" : "bold",
              "paddingBottom" : "30px"
            },
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "actions" : { },
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "noDataDisplayMessage" : "",
            "widgetCss" : "",
            "pageSize" : 1024,
            "displayTimewindow" : true
          },
          "row" : 0,
          "col" : 0,
          "id" : "a0a086d3-4855-b1eb-8297-540de5147d73",
          "typeFullFqn" : "system.input_widgets.update_multiple_attributes"
        },
        "8497c662-0aca-b710-7497-f046bf3cbf56" : {
          "type" : "latest",
          "sizeX" : 5,
          "sizeY" : 3.5,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : null,
              "entityAliasId" : "c5728f69-c11d-5b71-9941-af192de00fbb",
              "filterId" : null,
              "dataKeys" : [ ]
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1682774690137,
                  "endTimeMs" : 1682861090137
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#fff",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "useMarkdownTextFunction" : true,
              "markdownTextPattern" : "# Markdown/HTML card \\n - **Current entity**: **${entityName}**. \\n - **Current value**: **${Random}**.",
              "markdownTextFunction" : "return '<div class=\"panel-buttons flex flex-1 flex-row items-center justify-end gap-1\">' +\n  '<button mat-button color=\"primary\" id=\"disable_all\">' +\n  'Disable all' +\n  '</button>' +\n  '<button mat-stroked-button color=\"primary\" id=\"enable_all\">' +\n  'Enable all' +\n  '</button>' +\n  '</div>';",
              "applyDefaultMarkdownStyle" : true,
              "markdownCss" : ".panel-buttons {\n    padding-left: 0 !important;\n    height: 100%;\n}"
            },
            "title" : "",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "actions" : {
              "elementClick" : [ {
                "name" : "enable_all",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "const $injector = widgetContext.$injector;\nconst attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nlet attributesArray = [\n    {key: \"noAlarms\", value: \"noAlarms\"},\n    {key: \"lowRemaningLevel\", value: \"lowFuel\"},\n    {key: \"lowBattery\", value: \"lowBattery\"},\n    {key: \"lowTemperature\", value: \"lowTemperature\"},\n    {key: \"highTemperature\", value: \"highTemperature\"},\n    {key: \"offline\", value: \"offline\"}\n];\n\nattributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray).subscribe(() => {\n    // widgetContext.updateAliases();\n});",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "a4fdd169-2a9f-2995-c361-8675e78ad5d7"
              }, {
                "name" : "disable_all",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "const $injector = widgetContext.$injector;\nconst attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nlet attributesArray = [\n    {key: \"noAlarms\", value: \"unset\"},\n    {key: \"lowRemaningLevel\", value: \"unset\"},\n    {key: \"lowBattery\", value: \"unset\"},\n    {key: \"lowTemperature\", value: \"unset\"},\n    {key: \"highTemperature\", value: \"unset\"},\n    {key: \"offline\", value: \"unset\"}\n];\n\nattributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray).subscribe(() => {\n    // widgetContext.updateAliases();\n});",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "99c8349f-05c6-0008-537b-d0842e28dca3"
              } ]
            },
            "enableDataExport" : false,
            "widgetCss" : ".widget-type-sys-cards-markdown_card #container tb-markdown-widget .tb-markdown-view {\n    display: flex;\n}",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "useDashboardTimewindow" : true
          },
          "row" : 0,
          "col" : 0,
          "id" : "8497c662-0aca-b710-7497-f046bf3cbf56",
          "typeFullFqn" : "system.cards.markdown_card"
        },
        "dd29a6ca-371e-6cea-2180-fd58601b2988" : {
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : null,
              "entityAliasId" : "c5728f69-c11d-5b71-9941-af192de00fbb",
              "filterId" : null,
              "dataKeys" : [ {
                "name" : "lowTemperature",
                "type" : "attribute",
                "label" : "Low temperature",
                "color" : "#4caf50",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanSwitch",
                  "required" : false,
                  "isEditable" : "editable",
                  "slideToggleLabelPosition" : "before",
                  "useCustomIcon" : true,
                  "customIcon" : "tb-image;/api/images/tenant/fuel_level_monitoring_dashboard_widget_filter_custom_icon_(3).svg",
                  "useGetValueFunction" : true,
                  "getValueFunctionBody" : "return !value || value === 'lowTemperature';",
                  "useSetValueFunction" : true,
                  "setValueFunctionBody" : "return value ? 'lowTemperature' : 'unset';"
                },
                "_hash" : 0.34454051580229117,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null,
                "aggregationType" : null
              }, {
                "name" : "highTemperature",
                "type" : "attribute",
                "label" : "High temperature",
                "color" : "#ffc107",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanSwitch",
                  "required" : false,
                  "isEditable" : "editable",
                  "slideToggleLabelPosition" : "before",
                  "useCustomIcon" : true,
                  "customIcon" : "tb-image;/api/images/tenant/fuel_level_monitoring_dashboard_widget_filter_custom_icon_(4).svg",
                  "useGetValueFunction" : true,
                  "getValueFunctionBody" : "return !value || value === 'highTemperature';",
                  "useSetValueFunction" : true,
                  "setValueFunctionBody" : "return value ? 'highTemperature' : 'unset';"
                },
                "_hash" : 0.49298504090043105,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null,
                "aggregationType" : null
              }, {
                "name" : "offline",
                "type" : "attribute",
                "label" : "Offline",
                "color" : "#9c27b0",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanSwitch",
                  "required" : false,
                  "isEditable" : "editable",
                  "slideToggleLabelPosition" : "before",
                  "useCustomIcon" : true,
                  "customIcon" : "tb-image;/api/images/tenant/fuel_level_monitoring_dashboard_widget_filter_custom_icon_(5).svg",
                  "useGetValueFunction" : true,
                  "getValueFunctionBody" : "return !value || value === 'offline';",
                  "useSetValueFunction" : true,
                  "setValueFunctionBody" : "return value ? 'offline' : 'unset';"
                },
                "_hash" : 0.7203498706691758,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null,
                "aggregationType" : null
              } ]
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1682001930247,
                  "endTimeMs" : 1682088330247
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0,0,0,0.04)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "showResultMessage" : false,
              "showActionButtons" : false,
              "showGroupTitle" : false,
              "fieldsAlignment" : "column",
              "rowGap" : 10,
              "groupTitle" : "${entityName}",
              "fieldsInRow" : 2,
              "columnGap" : 10
            },
            "title" : "Filter",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "enableDataExport" : false,
            "widgetStyle" : {
              "fontWeight" : "bold",
              "fontSize" : "14px"
            },
            "titleStyle" : {
              "fontSize" : "20px",
              "fontWeight" : "bold",
              "paddingBottom" : "30px"
            },
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "actions" : { },
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "noDataDisplayMessage" : "",
            "widgetCss" : "",
            "pageSize" : 1024
          },
          "row" : 0,
          "col" : 0,
          "id" : "dd29a6ca-371e-6cea-2180-fd58601b2988",
          "typeFullFqn" : "system.input_widgets.update_multiple_attributes"
        },
        "26ae7f2d-c634-a13d-ab63-2f67646b9a80" : {
          "type" : "latest",
          "sizeX" : 5,
          "sizeY" : 3.5,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : null,
              "entityAliasId" : "c5728f69-c11d-5b71-9941-af192de00fbb",
              "filterId" : null,
              "dataKeys" : [ {
                "name" : "Ultrasonico",
                "type" : "attribute",
                "label" : "Ultrasonico",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.44281921320875384,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "return value !== 'unset';"
              }, {
                "name" : "Freatimetro",
                "type" : "attribute",
                "label" : "Freatimetro",
                "color" : "#4caf50",
                "settings" : { },
                "_hash" : 0.338713616073099,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "return value !== 'unset';"
              }, {
                "name" : "Comedero",
                "type" : "attribute",
                "label" : "Comedero",
                "color" : "#f44336",
                "settings" : { },
                "_hash" : 0.44652549440453715,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "return value !== 'unset';"
              }, {
                "name" : "lowTemperature",
                "type" : "attribute",
                "label" : "lowTemperature",
                "color" : "#ffc107",
                "settings" : { },
                "_hash" : 0.033350726799084685,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "return value !== 'unset';"
              }, {
                "name" : "noAlarms",
                "type" : "attribute",
                "label" : "noAlarms",
                "color" : "#607d8b",
                "settings" : { },
                "_hash" : 0.05751102627236171,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "return value !== 'unset';"
              }, {
                "name" : "offline",
                "type" : "attribute",
                "label" : "offline",
                "color" : "#9c27b0",
                "settings" : { },
                "_hash" : 0.2892859337116618,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "return value !== 'unset';"
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1682001930247,
                  "endTimeMs" : 1682088330247
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#fff",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "6px",
            "settings" : {
              "useMarkdownTextFunction" : true,
              "markdownTextPattern" : "# Markdown/HTML card \\n - **Current entity**: **${entityName}**. \\n - **Current value**: **${Random}**.",
              "markdownTextFunction" : "\nlet enabledFiltersString = '';\n\nif (data[0].noAlarms) {\n  enabledFiltersString += 'No alarms  ';\n}\n\nif (data[0].lowRemaningLevel) {\n  enabledFiltersString += 'Low remaining level  ';\n}\n\nif (data[0].highTemperature) {\n  enabledFiltersString += 'High temperature  ';\n}\n\nif (data[0].lowTemperature) {\n  enabledFiltersString += 'Low temperature  ';\n}\n\nif (data[0].lowBattery) {\n  enabledFiltersString += 'Low battery  ';\n}\n\nif (data[0].offline) {\n  enabledFiltersString += 'Offline  ';\n}\n\nif (enabledFiltersString.length > 0) {\n  enabledFiltersString = enabledFiltersString.replace(/  /g, ', ');\n  enabledFiltersString = enabledFiltersString.slice(0, -2) + '.';\n}\n\nctx.enabledFiltersString = enabledFiltersString;\n\nif (!ctx.markdownInited) {\n  ctx.markdownInited = true;\n  return '<div class=\"tank-layout flex flex-col\" style=\"width: 100%; height: 100%; padding: 0;\">' +\n    '<tb-dashboard-state class=\"flex-1\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"tanks-location\"></tb-dashboard-state>' +\n    '<mat-expansion-panel hideToggle=\"true\" id=\"arrow_rotate\" [expanded]=\"true\">' +\n    '<mat-expansion-panel-header>' +\n    '<mat-panel-title style=\"min-width: 95px; max-width: 95px; align-items: center;\">' +\n    '<label class=\"tb-panel-title\" style=\"height: min-content;\">Filter alarms</label>' +\n    '</mat-panel-title>' +\n    '<mat-panel-description class=\"panel-icon\">' +\n    '<mat-icon class=\"tb-panel-description\" id=\"tb-rotation-arrow\">keyboard_arrow_down</mat-icon>' +\n    '</mat-panel-description>' +\n    '<mat-panel-description class=\"panel-text\" style=\"min-width: 190px;\">' +\n    '<label style=\"display: none;\" class=\"panel-text-label\">' +\n    enabledFiltersString +\n    '</label>' +\n    '<div class=\"panel-buttons\" (click)=\"$event.stopPropagation()\">' +\n    '<tb-dashboard-state class=\"flex-1\" [ctx]=\"ctx\" style=\"height: 50px;\" stateId=\"device-alarm-filter-buttons\"></tb-dashboard-state>' +\n    '</div>' +\n    '</mat-panel-description>' +\n    '</mat-expansion-panel-header>' +\n    '<div class=\"tank-filter-layout flex flex-row xs:flex-col\">' +\n    '<tb-dashboard-state class=\"tank-filter-toggles\" class=\"flex-1\" [ctx]=\"ctx\" stateId=\"device_alarm_filter_1st_part\"></tb-dashboard-state>' +\n    '<tb-dashboard-state class=\"tank-filter-toggles\" class=\"flex-1\" [ctx]=\"ctx\" stateId=\"device_alarm_filter_2nd_part\"></tb-dashboard-state>' +\n    '</div>' +\n    '</mat-expansion-panel>' +\n    '</div>';\n}",
              "applyDefaultMarkdownStyle" : true,
              "markdownCss" : ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tank-layout .mat-expansion-panel-body {\n    padding: 0;\n}\n\n.tank-layout .mat-expansion-panel-header {\n    padding: 0 8px;\n}\n\n.tank-layout .mat-expansion-panel-header-title, .mat-expansion-panel-header-description {\n    margin: 0;\n    /*justify-content: flex-end;*/\n}\n\n.tank-layout .mat-expansion-panel-header-title {\n    justify-content: flex-start;\n}\n\n.tank-layout .panel-text {\n    justify-content: flex-end;\n    align-items: center;\n}\n\n.tank-layout .panel-icon {\n    justify-content: flex-start;\n    align-items: center;\n    max-width: 90px;\n}\n\n.tank-layout .panel-text-label {\n    height: min-content;\n    font-weight: 400;\n    letter-spacing: 0.2px;\n}\n\n.tank-layout .mat-expansion-panel-header-description label {\n    width: 80%;\n    padding: 0;\n    text-align: right;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    overflow: hidden;\n}\n\n.tank-layout .mat-expansion-panel-header {\n  justify-content: flex-start;\n}\n\n#tb-rotation-arrow {\n  transition: transform 0.5s ease;\n}\n\n#tb-rotation-arrow::after {\n  content: '';\n  display: block;\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  z-index: -1;\n}\n\n#tb-rotation-arrow.clicked {\n  transform: rotate(-180deg);\n}\n\n#tb-rotation-arrow.clicked::after {\n  transform: rotate(180deg);\n}\n\n.mat-content .mat-content-hide-toggle {\n    height: 100%;\n    margin: 0;\n}\n\n.panel-buttons {\n    width: 100%;\n    max-width: 190px;\n}\n\n.tb-panel-title {\n    font-size: 16px;\n    line-height: 24px;\n    letter-spacing: 0.25px;\n}\n\n.tank-layout .tank-filter-toggles {\n    height: 175px;\n}"
            },
            "title" : "New Markdown/HTML Card",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "enableDataExport" : false,
            "widgetCss" : "\n.tank-layout .tb-widget-container .tb-widget .tb-multiple-input {\n    /*background-color: rgba(0, 0, 0, 0.04);*/\n    border-radius: 4px;\n}\n\n.tank-layout .tank-filter-layout .tb-widget-container .tb-widget .tb-multiple-input .tb-multiple-input-container .label-wrapper {\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    overflow: hidden;\n}\n\n/*.tb-widget-container .tb-widget .tb-multiple-input .mdc-form-field > label {*/\n/*    min-width: 160px;*/\n/*}*/\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-form-field > label .mat-icon {\n    margin-left: 0;\n}\n\n/*.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-form-field .label-wrapper {*/\n/*    font-weight: bold;*/\n/*}*/\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch {\n    width: 42px;\n    margin-left: 8px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch .mdc-switch__track {\n    border-radius: 16px;\n    height: 24px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch .mdc-switch__handle-track {\n    width: calc(100% - 24px);\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch .mdc-switch__handle {\n    border-radius: 10px;\n    width: 20px;\n    height: 20px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch .mdc-switch__ripple {\n    width: 40px;\n    height: 40px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch .mdc-switch__icons {\n    display: none;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch.mdc-switch--unselected:enabled .mdc-switch__handle::after {\n    background: #fafafa;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch.mdc-switch--selected:enabled .mdc-switch__handle::after {\n    background: #fafafa;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-mdc-slide-toggle .mdc-switch .mdc-switch__track::after {\n    background: #9699FF !important;\n}\n\n.mat-content.mat-content-hide-toggle {\n    height: 100%;\n    margin: 0;\n}\n\n.tank-layout .mat-expansion-panel-body {\n    padding: 0;\n}\n\n.tank-layout .mdc-button {\n    color: #474BD2 !important;\n}\n\n\n.tank-layout .panel-buttons {\n    width: 100%;\n    padding-right: 1px !important;\n}\n\n.tank-layout .mat-mdc-slide-toggle .mdc-switch {\n    margin-left: 0 !important;\n}\n",
            "noDataDisplayMessage" : "",
            "useDashboardTimewindow" : true,
            "pageSize" : 1024,
            "actions" : {
              "elementClick" : [ {
                "name" : "arrow_rotate",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "\nif ($event.target && \n        ($event.target.className.includes('expansion-panel-header') ||\n        $event.target.className.includes('panel-description') ||\n        $event.target.className.includes('panel-title') || \n        $event.target.className.includes('panel-text') || \n        $event.target.className.includes('panel-buttons'))\n   ) {\n    const arrow = document.querySelector('#tb-rotation-arrow');\n    const panelTextLabel = document.getElementsByClassName('panel-text-label')[0];\n    const panelButtons = document.getElementsByClassName('panel-buttons')[0];\n    \n    widgetContext.panelOpenState = !widgetContext.panelOpenState;\n    arrow.classList.toggle('clicked');\n    panelTextLabel.textContent = widgetContext.enabledFiltersString;\n    \n    if (widgetContext.panelOpenState) {\n        panelTextLabel.style = \"display: block\";\n        panelButtons.style = \"display: none\";\n    } else {\n        panelTextLabel.style = \"display: none\";\n        panelButtons.style = \"display: block\";\n    }\n}",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "d3236ada-e737-f872-1fe0-a3fe5f1fe985"
              } ]
            },
            "displayTimewindow" : true
          },
          "row" : 0,
          "col" : 0,
          "id" : "26ae7f2d-c634-a13d-ab63-2f67646b9a80",
          "typeFullFqn" : "system.cards.markdown_card"
        },
        "1861e9c6-bae1-a8a3-7e94-93d749fe31c9" : {
          "typeFullFqn" : "system.input_widgets.update_multiple_attributes",
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "c5728f69-c11d-5b71-9941-af192de00fbb",
              "dataKeys" : [ {
                "name" : "receiveEmail",
                "type" : "attribute",
                "label" : "Notificaciones por email",
                "color" : "#2196f3",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanSwitch",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "before",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.6675251832187705,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1757696726807,
                  "endTimeMs" : 1757783126807
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : true,
            "backgroundColor" : "#FFFFFF",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "8px",
            "settings" : {
              "widgetTitle" : "",
              "showResultMessage" : true,
              "showActionButtons" : false,
              "updateAllValues" : false,
              "saveButtonLabel" : "",
              "resetButtonLabel" : "",
              "showGroupTitle" : false,
              "groupTitle" : "${entityName}",
              "fieldsAlignment" : "row",
              "fieldsInRow" : 2,
              "rowGap" : 5,
              "columnGap" : 10
            },
            "title" : "Ajustes",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "enableDataExport" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "actions" : { },
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "margin" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "1861e9c6-bae1-a8a3-7e94-93d749fe31c9"
        },
        "469cfc0a-f34d-07b5-e417-97d93dab3d84" : {
          "type" : "latest",
          "sizeX" : 5,
          "sizeY" : 3.5,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : null,
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "filterId" : null,
              "dataKeys" : [ ]
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1682928306473,
                  "endTimeMs" : 1683014706473
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 2500
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#fff",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "useMarkdownTextFunction" : true,
              "markdownTextPattern" : "# Markdown/HTML card \\n - **Current entity**: **${entityName}**. \\n - **Current value**: **${Random}**.",
              "markdownTextFunction" : "// Opcional: si ya no usÃ¡s darkMode, podÃ©s comentar estas dos lÃ­neas\r\n// var darkMode = $('.tb-dashboard-page').hasClass('dark');\r\n// var darkModeExpression = darkMode ? '(darkMode !== false)' : 'darkMode';\r\n\r\nreturn '<div class=\"header flex flex-row items-stretch justify-start gap-2\">' +\r\n        \r\n        '<div class=\"flex flex-1 flex-col items-stretch justify-center\">' +\r\n           '<div class=\"title\">${entityLabel}</div>' +\r\n           '<div class=\"subtitle\">${entityName}</div>' +\r\n        '</div>' +\r\n        \r\n        // ð§ BotÃ³n \"Reporte CSV\" que dispara la AcciÃ³n 'generate-csv'\r\n        '<div class=\"flex flex-col items-stretch justify-center\">' +\r\n          '<button id=\"generate-csv\" tb-action [actionId]=\"\\'generate-csv\\'\" matTooltip=\"Reporte CSV\" type=\"button\" mat-icon-button>' +\r\n            '<mat-icon>description</mat-icon>' +\r\n          '</button>' +\r\n        '</div>' +\r\n\r\n        // ð§ BotÃ³n \"Editar ajustes\" que dispara la AcciÃ³n 'open-ajustes'\r\n        '<div class=\"flex flex-col items-stretch justify-center\">' +\r\n          '<button id=\"open-ajustes\" tb-action [actionId]=\"\\'open-ajustes\\'\" matTooltip=\"Editar ajustes\" type=\"button\" mat-icon-button>' +\r\n            '<mat-icon>tune</mat-icon>' +\r\n          '</button>' +\r\n        '</div>' +\r\n        \r\n        // ð§ BotÃ³n \"mapa\" que dispara la AcciÃ³n 'edit-location'\r\n        '<div class=\"flex flex-col items-stretch justify-center\">' +\r\n          '<button id=\"edit-location\" tb-action [actionId]=\"\\'edit-location\\'\" matTooltip=\"Editar ubicaciÃ³n\" type=\"button\" mat-icon-button>' +\r\n            '<mat-icon>map</mat-icon>' +\r\n          '</button>' +\r\n        '</div>' +\r\n\r\n        // (Dark mode button removido)\r\n        // '<div class=\"flex flex-col items-stretch justify-center\" style=\"padding-right: 24px;\">' +\r\n        //     '<button (click)=\"darkMode = '+darkModeExpression+' ? false : true\" id=\"dark-mode-switch\" mat-icon-button matTooltip=\"{{ '+ darkModeExpression +' ? &quot;Cambiar a modo claro&quot; : &quot;Cambiar a modo oscuro&quot; }}\"><mat-icon>{{ '+ darkModeExpression +' ? &quot;light_mode&quot; : &quot;dark_mode&quot; }}</mat-icon></button>' +\r\n        // '</div>' +\r\n'</div>';\r\n",
              "applyDefaultMarkdownStyle" : false,
              "markdownCss" : ".header {\n    height: 100%;\n    padding: 0 0 0 16px;\n} \n\n.header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n"
            },
            "title" : "New Markdown/HTML Card",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "widgetCss" : "",
            "noDataDisplayMessage" : "",
            "actions" : {
              "elementClick" : [ {
                "name" : "go-back",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "widgetContext.stateController.navigatePrevState(0);",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "fd666ec9-cd5a-af01-47e1-b7e53911f87a"
              }, {
                "name" : "dark-mode-switch",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "var dashboardPage = $('.tb-dashboard-page')[0];\n$(dashboardPage).toggleClass('dark');",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "4431866e-87da-0a87-0fe0-1bd7bd404081"
              }, {
                "name" : "open-ajustes",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "openDashboardState",
                "targetDashboardStateId" : "pozo_settings",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "dialogTitle" : "",
                "dialogHideDashboardToolbar" : true,
                "dialogWidth" : null,
                "dialogHeight" : 100,
                "openInSeparateDialog" : true,
                "openInPopover" : false,
                "id" : "3168d81e-c80f-26ce-a178-7a6190e1243b"
              }, {
                "name" : "edit-location",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "openDashboardState",
                "targetDashboardStateId" : "edit_location",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "dialogTitle" : "",
                "dialogHideDashboardToolbar" : true,
                "dialogWidth" : null,
                "dialogHeight" : 100,
                "openInSeparateDialog" : true,
                "openInPopover" : false,
                "id" : "0d9f86b2-ec64-19b4-a32e-a1487dca5991"
              }, {
                "name" : "generate-csv",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "customPretty",
                "customHtml" : "<form #reportForm=\"ngForm\" [formGroup]=\"reportFormGroup\"\r\n      (ngSubmit)=\"generateReport()\" class=\"edit-entity-form\">\r\n\r\n  <mat-toolbar color=\"primary\">\r\n    <h2>Generar reporte CSV</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" [disabled]=\"(loading$ | async)\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <!-- Contenedor fijo para no mover layout -->\r\n  <div style=\"height: 4px;\">\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\"\r\n                      *ngIf=\"loading$ | async\"></mat-progress-bar>\r\n  </div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-form-field fxFlex class=\"mat-block\">\r\n      <mat-label>Fecha inicio</mat-label>\r\n      <input matInput [matDatepicker]=\"startPicker\" formControlName=\"startDate\" required>\r\n      <mat-datepicker-toggle matSuffix [for]=\"startPicker\"></mat-datepicker-toggle>\r\n      <mat-datepicker #startPicker></mat-datepicker>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field fxFlex class=\"mat-block\">\r\n      <mat-label>Fecha fin</mat-label>\r\n      <input matInput [matDatepicker]=\"endPicker\" formControlName=\"endDate\" required>\r\n      <mat-datepicker-toggle matSuffix [for]=\"endPicker\"></mat-datepicker-toggle>\r\n      <mat-datepicker #endPicker></mat-datepicker>\r\n    </mat-form-field>\r\n\r\n    <!-- Estado / Mensajes -->\r\n    <div style=\"min-height:24px;\">\r\n      <span *ngIf=\"status\" style=\"color:#d32f2f;\">{{status}}</span>\r\n      <span *ngIf=\"!status && success\" style=\"color:#2e7d32;\">\r\n        <mat-icon inline style=\"font-size:18px;vertical-align:middle;\">check_circle</mat-icon>\r\n        Reporte generado\r\n      </span>\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(loading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      Cancelar\r\n    </button>\r\n    <button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(loading$ | async) || reportForm.invalid\">\r\n      <span *ngIf=\"!(loading$ | async)\">Generar reporte</span>\r\n      <span *ngIf=\"loading$ | async\">Generandoâ¦</span>\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss" : ".edit-entity-form {\r\n    width: 320px;\r\n}",
                "customFunction" : "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nopenReportDialog();\r\n\r\nfunction openReportDialog() {\r\n  customDialog.customDialog(htmlTemplate, ReportDialogController).subscribe();\r\n}\r\n\r\n/* ============ Config ============ */\r\nconst BUCKET_MS = 60_000;   // agrupar por minuto\r\nconst KEY_BATCH_SIZE = 10;  // cuÃ¡ntas keys por request (evita URLs gigantes)\r\nconst PER_KEY_LIMIT = 200_000; // puntos mÃ¡ximos por key (sobra para 1 aÃ±o a 1/h)\r\n\r\n/* ============ Auth helpers ============ */\r\nfunction readLocalJwt() {\r\n  try {\r\n    for (const k of ['jwt_token','tb.auth_token','token']) {\r\n      const v = localStorage.getItem(k);\r\n      if (v && typeof v === 'string') return v.replace(/^Bearer\\s+/i,'');\r\n    }\r\n  } catch(_) {}\r\n  return null;\r\n}\r\nfunction isJwtExpired(jwt) {\r\n  try {\r\n    const p = JSON.parse(atob(jwt.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));\r\n    if (!p?.exp) return false;\r\n    return Math.floor(Date.now()/1000) >= p.exp;\r\n  } catch(_) { return false; }\r\n}\r\nasync function refreshJwtIfPossible() {\r\n  try {\r\n    const res = await fetch('/api/auth/token', { method:'POST', credentials:'include' });\r\n    if (!res.ok) return null;\r\n    const data = await res.json();\r\n    const t = data?.token || data?.jwtToken || null;\r\n    if (t) { try { localStorage.setItem('jwt_token', t); } catch(_) {} }\r\n    return t;\r\n  } catch(_) { return null; }\r\n}\r\nasync function getJwtToken() {\r\n  let t = readLocalJwt();\r\n  if (t && !isJwtExpired(t)) return t;\r\n  const r = await refreshJwtIfPossible();\r\n  return r || t || null;\r\n}\r\nasync function fetchWithAuth(url, options = {}) {\r\n  let jwt = await getJwtToken();\r\n  const headers = new Headers(options.headers || {});\r\n  if (jwt) headers.set('X-Authorization', 'Bearer ' + jwt);\r\n  headers.set('accept', headers.get('accept') || 'application/json');\r\n\r\n  let res = await fetch(url, { ...options, headers });\r\n  if (res.status === 401) {\r\n    const newJwt = await refreshJwtIfPossible();\r\n    if (newJwt) {\r\n      headers.set('X-Authorization', 'Bearer ' + newJwt);\r\n      res = await fetch(url, { ...options, headers });\r\n    }\r\n  }\r\n  console.log(jwt)\r\n  console.log(res)\r\n  return res;\r\n}\r\n\r\n/* ============ Device helpers ============ */\r\nfunction getDeviceId() {\r\n  try {\r\n    if (typeof entityId !== 'undefined' && entityId?.id) return entityId.id;\r\n    const a = widgetContext?.ctx?.stateController?.getEntityId?.();\r\n    if (a?.id) return a.id;\r\n    const b = widgetContext?.ctx?.defaultSubscription?.targetEntity?.id?.id;\r\n    if (b) return b;\r\n    const c = widgetContext?.ctx?.datasources?.[0]?.entity?.id?.id;\r\n    if (c) return c;\r\n  } catch(_) {}\r\n  return null;\r\n}\r\nasync function getDeviceLabelOrName(deviceId) {\r\n  try {\r\n    const res = await fetchWithAuth(`/api/device/${deviceId}`);\r\n    if (!res.ok) return 'dispositivo';\r\n    const dev = await res.json();\r\n    return (dev?.label && String(dev.label).trim()) || dev?.name || 'dispositivo';\r\n  } catch(_) { return 'dispositivo'; }\r\n}\r\n\r\n/* ============ Fechas ============ */\r\nfunction getDateString(v) {\r\n  if (typeof v === 'string') return v;\r\n  if (v instanceof Date) return v.toISOString().slice(0,10);\r\n  return '';\r\n}\r\nfunction normalizeDateString(input) {\r\n  if (!input) return '';\r\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(input)) return input; // YYYY-MM-DD\r\n  const m = String(input).match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/); // DD/MM/YYYY\r\n  if (m) return `${m[3]}-${m[2]}-${m[1]}`;\r\n  const d = new Date(input);\r\n  return isNaN(d) ? '' : d.toISOString().slice(0,10);\r\n}\r\nfunction toDDMMYYYY(iso) { // 'YYYY-MM-DD' -> 'dd-mm-aaaa'\r\n  const [y,m,d] = iso.split('-');\r\n  return `${d}-${m}-${y}`;\r\n}\r\nfunction pad2(n){ return String(n).padStart(2,'0'); }\r\nfunction fmtIsoLocalMinute(ts) { // 'YYYY-MM-DD HH:mm'\r\n  const d = new Date(ts);\r\n  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} `\r\n       + `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;\r\n}\r\n\r\n/* ============ visibleKeys SOLO SERVER_SCOPE ============ */\r\nasync function getServerVisibleKeys(deviceId) {\r\n  const url = `/api/plugins/telemetry/DEVICE/${deviceId}/values/attributes?serverKeys=visibleKeys`;\r\n  const res = await fetchWithAuth(url);\r\n  if (!res.ok) throw new Error('No se pudo leer visibleKeys (SERVER_SCOPE)');\r\n  const data = await res.json();\r\n\r\n  let items = [];\r\n  if (Array.isArray(data)) items = data;\r\n  else if (Array.isArray(data.server)) items = data.server;\r\n\r\n  const it = items.find(x => x?.key === 'visibleKeys' && x?.value);\r\n  if (!it) throw new Error('visibleKeys no existe en SERVER_SCOPE');\r\n  let vk = typeof it.value === 'string' ? JSON.parse(it.value) : it.value;\r\n  if (!vk || typeof vk !== 'object' || !Object.keys(vk).length) {\r\n    throw new Error('visibleKeys (SERVER_SCOPE) estÃ¡ vacÃ­o');\r\n  }\r\n\r\n  const keys = Object.keys(vk);\r\n  const meta = {};\r\n  keys.forEach(k => {\r\n    const o = vk[k] || {};\r\n    meta[k] = { label: o.label || k, unit: o.unit || '' };\r\n  });\r\n  return { keys, meta };\r\n}\r\n\r\n/* ============ Fetch Ãºnico por key (o lote), SIN interval ni agg ============ */\r\n/**\r\n * Devuelve series crudas dentro del rango, en lotes de keys, con limit alto.\r\n * { key1:[{ts,value},...], key2:[...], ... }\r\n */\r\nasync function fetchTimeseriesRaw(deviceId, keys, startTs, endTs, keyBatchSize = KEY_BATCH_SIZE, perKeyLimit = PER_KEY_LIMIT) {\r\n  const out = {};\r\n  keys.forEach(k => out[k] = []);\r\n\r\n  for (let i = 0; i < keys.length; i += keyBatchSize) {\r\n    const group = keys.slice(i, i + keyBatchSize);\r\n\r\n    const url = `/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries`\r\n      + `?keys=${encodeURIComponent(group.join(','))}`\r\n      + `&startTs=${startTs}&endTs=${endTs}`\r\n      + `&limit=${perKeyLimit}`   // trae TODO en un solo tiro por key\r\n      + `&useStrictDataTypes=false`;\r\n\r\n    const res = await fetchWithAuth(url);\r\n   \r\n    if (!res.ok) {\r\n      const txt = await res.text();\r\n      throw new Error(txt || `Error ${res.status} en Telemetry`);\r\n    }\r\n    const chunk = await res.json();\r\n\r\n    for (const k of group) {\r\n      const arr = Array.isArray(chunk?.[k]) ? chunk[k] : [];\r\n      if (arr.length) out[k] = out[k].concat(arr);\r\n    }\r\n  }\r\n\r\n  // ordenar por ts\r\n  for (const k of keys) out[k].sort((a,b)=>a.ts - b.ts);\r\n  return out;\r\n}\r\n\r\n/* ============ Bucket por minuto y CSV ============ */\r\nfunction bucketTsMin(ts) {\r\n  return Math.floor(ts / BUCKET_MS) * BUCKET_MS;\r\n}\r\n\r\nfunction buildCsvBucketed(seriesByKey, keys, meta) {\r\n  const headers = [\r\n    'fecha',\r\n    'hora',\r\n    'fecha hora', // YYYY-MM-DD HH:mm\r\n    ...keys.map(k => {\r\n      const {label, unit} = meta[k] || {label:k, unit:''};\r\n      return unit ? `${label} (${unit})` : label;\r\n    })\r\n  ];\r\n\r\n  // mapear Ãºltimo valor por minuto\r\n  const maps = {};\r\n  const bucketSet = new Set();\r\n\r\n  for (const k of keys) {\r\n    const m = new Map();\r\n    for (const p of (seriesByKey[k] || [])) {\r\n      const b = bucketTsMin(p.ts);\r\n      m.set(b, p.value);      // queda el Ãºltimo del minuto\r\n      bucketSet.add(b);\r\n    }\r\n    maps[k] = m;\r\n  }\r\n\r\n  const buckets = Array.from(bucketSet).sort((a,b)=>a-b);\r\n\r\n  let csv = headers.join(',') + '\\n';\r\n  for (const b of buckets) {\r\n    const d = new Date(b);\r\n    const fecha = d.toLocaleDateString();\r\n    const hora  = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; // estable para grÃ¡ficos\r\n    const fh    = fmtIsoLocalMinute(b);\r\n    const row = [\r\n      fecha,\r\n      hora,\r\n      fh,\r\n      ...keys.map(k => maps[k].has(b) ? maps[k].get(b) : '')\r\n    ];\r\n    csv += row.join(',') + '\\n';\r\n  }\r\n  return csv;\r\n}\r\n\r\n/* ============ Dialog Controller ============ */\r\nfunction ReportDialogController(instance) {\r\n  const vm = instance;\r\n\r\n  // Loading reactivo y flags de UI\r\n  vm.loading$ = new widgetContext.rxjs.BehaviorSubject(false);\r\n  vm.status = '';\r\n  vm.success = false;\r\n\r\n  vm.reportFormGroup = vm.fb.group({\r\n    startDate: [null, vm.validators.required],\r\n    endDate:   [null, vm.validators.required]\r\n  });\r\n\r\n  vm.cancel = () => vm.dialogRef.close(null);\r\n\r\n  vm.generateReport = async function () {\r\n    vm.status = '';\r\n    vm.success = false;\r\n    vm.loading$.next(true);\r\n\r\n    try {\r\n      if (vm.reportFormGroup.invalid) {\r\n        vm.status = 'Selecciona ambas fechas.';\r\n        return;\r\n      }\r\n\r\n      // === Fechas ===\r\n      const startRaw  = vm.reportFormGroup.get('startDate').value;\r\n      const endRaw    = vm.reportFormGroup.get('endDate').value;\r\n      const startDate = getDateString(startRaw) || normalizeDateString(String(startRaw||''));\r\n      const endDate   = getDateString(endRaw)   || normalizeDateString(String(endRaw||''));\r\n      if (!startDate || !endDate) {\r\n        vm.status = 'Selecciona ambas fechas.';\r\n        return;\r\n      }\r\n      const startTs = new Date(`${startDate}T00:00:00`).getTime();\r\n      const endTs   = new Date(`${endDate}T23:59:59`).getTime();\r\n      if (isNaN(startTs) || isNaN(endTs)) {\r\n        vm.status = 'Formato de fecha invÃ¡lido.';\r\n        return;\r\n      }\r\n\r\n      // === Device & visibleKeys (SERVER_SCOPE) ===\r\n      const deviceId    = getDeviceId();\r\n      if (!deviceId) { vm.status = 'No se pudo resolver el Device ID.'; return; }\r\n      const deviceLabel = await getDeviceLabelOrName(deviceId);\r\n      const { keys, meta } = await getServerVisibleKeys(deviceId);\r\n\r\n      // === TelemetrÃ­a cruda en lotes (rÃ¡pido) ===\r\n      const seriesByKey = await fetchTimeseriesRaw(deviceId, keys, startTs, endTs, KEY_BATCH_SIZE, PER_KEY_LIMIT);\r\n      const hasAny = keys.some(k => (seriesByKey[k]||[]).length > 0);\r\n      if (!hasAny) { vm.status = 'No hay datos en ese rango.'; return; }\r\n\r\n      // === CSV bucketizado por minuto + columna \"fecha hora\" ===\r\n      const csvCore = buildCsvBucketed(seriesByKey, keys, meta);\r\n\r\n      // === Blob y nombre de archivo (Â¡definidos acÃ¡!)\r\n      const BOM = '\\uFEFF';\r\n      const blob = new Blob([BOM + csvCore], { type: 'text/csv;charset=utf-8' });\r\n      const prettyStart = toDDMMYYYY(startDate); // dd-mm-aaaa\r\n      const prettyEnd   = toDDMMYYYY(endDate);\r\n      const safeLabel   = String(deviceLabel).trim().replace(/[^\\w\\s\\-\\.]/g, '').replace(/\\s+/g,'_');\r\n      const fileName    = `${safeLabel}_reporte_${prettyStart}_a_${prettyEnd}.csv`;\r\n\r\n      // === Apagar loading ANTES del click, mostrar Ã©xito y refrescar UI ===\r\n      vm.loading$.next(false);\r\n      vm.success = true;\r\n      instance.$scope?.$applyAsync?.();\r\n      await Promise.resolve(); // yieldea 1 tick para que Angular pinte\r\n\r\n      // === Disparar descarga ===\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = fileName;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n\r\n      // Limpieza y cierre (deja que el click salga primero)\r\n      setTimeout(() => {\r\n        try { URL.revokeObjectURL(url); } catch(_) {}\r\n        try { document.body.removeChild(a); } catch(_) {}\r\n        // cerrar el diÃ¡logo automÃ¡ticamente\r\n        vm.dialogRef.close({ ok: true, fileName });\r\n      }, 2000);\r\n\r\n    } catch (err) {\r\n      vm.status = 'Error: ' + (err?.message || err);\r\n    } finally {\r\n      // asegurar que quede apagado si hubo early return con error\r\n      if (vm.loading$.getValue()) vm.loading$.next(false);\r\n      instance.$scope?.$applyAsync?.();\r\n    }\r\n  };\r\n}\r\n\r\n",
                "customResources" : [ ],
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "33735a67-2b60-37f7-e6d0-a69cc082b0a0"
              } ],
              "headerButton" : [ ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "469cfc0a-f34d-07b5-e417-97d93dab3d84",
          "typeFullFqn" : "system.cards.markdown_card"
        },
        "11cd269e-acda-5149-8172-fa668b33a6a7" : {
          "typeFullFqn" : "system.input_widgets.update_multiple_attributes",
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "deviceId" : null,
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "interval",
                "type" : "attribute",
                "label" : "Intervalo",
                "color" : "#2196f3",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "select",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ {
                    "value" : "1200",
                    "label" : "20 minutos"
                  }, {
                    "value" : "1800",
                    "label" : "30 minutos"
                  }, {
                    "value" : "3600",
                    "label" : "1 hora"
                  }, {
                    "value" : "300",
                    "label" : "5 min"
                  } ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "schedule",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.3216876039895098,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "return value;"
              }, {
                "name" : "tankVolume",
                "type" : "attribute",
                "label" : "Volumen del tanque",
                "color" : "#4caf50",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "integer",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "mdi:car-coolant-level",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.6704988891850072,
                "aggregationType" : null,
                "units" : "L",
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "lowDist",
                "type" : "attribute",
                "label" : "Distancia vacio",
                "color" : "#f44336",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "integer",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "straighten",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.6653481754911794,
                "aggregationType" : null,
                "units" : "cm",
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "fullDist",
                "type" : "attribute",
                "label" : "Distancia lleno",
                "color" : "#ffc107",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "string",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "straighten",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.3679606168356657,
                "aggregationType" : null,
                "units" : "cm",
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1749684448443,
                  "endTimeMs" : 1749770848443
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : true,
            "backgroundColor" : "#fff",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "8px",
            "settings" : {
              "widgetTitle" : "",
              "showResultMessage" : true,
              "showActionButtons" : true,
              "updateAllValues" : false,
              "saveButtonLabel" : "",
              "resetButtonLabel" : "",
              "showGroupTitle" : false,
              "groupTitle" : "${entityName}",
              "fieldsAlignment" : "column",
              "fieldsInRow" : 1,
              "rowGap" : 5,
              "columnGap" : 10
            },
            "title" : "Ajustes del dispositivo",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "enableDataExport" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "actions" : { },
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "widgetCss" : "",
            "pageSize" : 1024,
            "units" : "s",
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "11cd269e-acda-5149-8172-fa668b33a6a7"
        },
        "6c82e300-6a83-31c4-d952-fdf3bfd9d0af" : {
          "type" : "latest",
          "sizeX" : 6,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "tankHighAlarmFlag",
                "type" : "attribute",
                "label" : "Alarma de nivel de tanque alto",
                "color" : "#4caf50",
                "settings" : {
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanCheckbox",
                  "required" : false,
                  "isEditable" : "editable",
                  "dataKeyHidden" : false,
                  "step" : 1
                },
                "_hash" : 0.8725278440159361,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "tankMaxAlarmThreshold",
                "type" : "attribute",
                "label" : "LÃ­mite mÃ¡ximo de nivel de tanque",
                "color" : "#f44336",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "double",
                  "required" : true,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "tankHighAlarmFlag",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.7316078472857874,
                "aggregationType" : null,
                "units" : "%",
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "tankLowAlarmFlag",
                "type" : "attribute",
                "label" : "Alarma de nivel de tanque bajo",
                "color" : "#ffc107",
                "settings" : {
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "booleanCheckbox",
                  "required" : false,
                  "isEditable" : "editable",
                  "dataKeyHidden" : false,
                  "step" : 1
                },
                "_hash" : 0.5339673667431057,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "tankMinAlarmThreshold",
                "type" : "attribute",
                "label" : "LÃ­mite mÃ­nimo de nivel de tanque",
                "color" : "#607d8b",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "double",
                  "required" : true,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "tankLowAlarmFlag",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.2687091190358901,
                "aggregationType" : null,
                "units" : "%",
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1694085177686,
                  "endTimeMs" : 1694171577686
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : true,
            "backgroundColor" : "#fff",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "8px",
            "settings" : {
              "widgetTitle" : "ConfiguraciÃ³n de alarmas",
              "showResultMessage" : true,
              "showActionButtons" : true,
              "updateAllValues" : false,
              "saveButtonLabel" : "",
              "resetButtonLabel" : "",
              "showGroupTitle" : false,
              "groupTitle" : "${entityName}",
              "fieldsAlignment" : "row",
              "fieldsInRow" : 2,
              "rowGap" : 0,
              "columnGap" : 0
            },
            "title" : "New Update Multiple Attributes",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "enableDataExport" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "actions" : { },
            "showTitleIcon" : false,
            "titleIcon" : null,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "id" : "6c82e300-6a83-31c4-d952-fdf3bfd9d0af",
          "typeFullFqn" : "system.input_widgets.update_multiple_attributes"
        },
        "cde8dc17-56b4-08f2-8a43-c1e53244b986" : {
          "typeFullFqn" : "system.line_chart",
          "type" : "timeseries",
          "sizeX" : 8,
          "sizeY" : 5,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "waterVolume",
                "type" : "timeseries",
                "label" : "Volumen de tanque",
                "color" : "#4CAF50",
                "settings" : {
                  "yAxisId" : "default",
                  "showInLegend" : true,
                  "dataHiddenByDefault" : false,
                  "type" : "line",
                  "lineSettings" : {
                    "showLine" : false,
                    "step" : false,
                    "stepType" : "start",
                    "smooth" : false,
                    "lineType" : "solid",
                    "lineWidth" : 2,
                    "showPoints" : false,
                    "showPointLabel" : false,
                    "pointLabelPosition" : "top",
                    "pointLabelFont" : {
                      "family" : "Roboto",
                      "size" : 11,
                      "sizeUnit" : "px",
                      "style" : "normal",
                      "weight" : "400",
                      "lineHeight" : "1"
                    },
                    "pointLabelColor" : "rgba(0, 0, 0, 0.76)",
                    "enablePointLabelBackground" : false,
                    "pointLabelBackground" : "rgba(255,255,255,0.56)",
                    "pointShape" : "emptyCircle",
                    "pointSize" : 4,
                    "fillAreaSettings" : {
                      "type" : "none",
                      "opacity" : 0.4,
                      "gradient" : {
                        "start" : 100,
                        "end" : 0
                      }
                    }
                  },
                  "barSettings" : {
                    "showBorder" : false,
                    "borderWidth" : 2,
                    "borderRadius" : 0,
                    "showLabel" : false,
                    "labelPosition" : "top",
                    "labelFont" : {
                      "family" : "Roboto",
                      "size" : 11,
                      "sizeUnit" : "px",
                      "style" : "normal",
                      "weight" : "400",
                      "lineHeight" : "1"
                    },
                    "labelColor" : "rgba(0, 0, 0, 0.76)",
                    "enableLabelBackground" : false,
                    "labelBackground" : "rgba(255,255,255,0.56)",
                    "backgroundSettings" : {
                      "type" : "none",
                      "opacity" : 0.4,
                      "gradient" : {
                        "start" : 100,
                        "end" : 0
                      }
                    }
                  },
                  "tooltipValueFormatter" : null,
                  "comparisonSettings" : {
                    "showValuesForComparison" : false,
                    "comparisonValuesLabel" : "",
                    "color" : ""
                  }
                },
                "_hash" : 0.6261094481195465,
                "units" : "L",
                "decimals" : 0,
                "aggregationType" : null,
                "funcBody" : null,
                "usePostProcessing" : false,
                "postFuncBody" : null
              }, {
                "name" : "waterLevelPerc",
                "type" : "timeseries",
                "label" : "Nivel de tanque",
                "color" : "#4caf50",
                "settings" : {
                  "yAxisId" : "default",
                  "showInLegend" : true,
                  "dataHiddenByDefault" : false,
                  "type" : "line",
                  "lineSettings" : {
                    "showLine" : true,
                    "step" : false,
                    "stepType" : "start",
                    "smooth" : false,
                    "lineType" : "solid",
                    "lineWidth" : 2,
                    "showPoints" : false,
                    "showPointLabel" : false,
                    "pointLabelPosition" : "top",
                    "pointLabelFont" : {
                      "family" : "Roboto",
                      "size" : 11,
                      "sizeUnit" : "px",
                      "style" : "normal",
                      "weight" : "400",
                      "lineHeight" : "1"
                    },
                    "pointLabelColor" : "rgba(0, 0, 0, 0.76)",
                    "enablePointLabelBackground" : false,
                    "pointLabelBackground" : "rgba(255,255,255,0.56)",
                    "pointShape" : "emptyCircle",
                    "pointSize" : 4,
                    "fillAreaSettings" : {
                      "type" : "none",
                      "opacity" : 0.4,
                      "gradient" : {
                        "start" : 100,
                        "end" : 0
                      }
                    }
                  },
                  "barSettings" : {
                    "showBorder" : false,
                    "borderWidth" : 2,
                    "borderRadius" : 0,
                    "showLabel" : false,
                    "labelPosition" : "top",
                    "labelFont" : {
                      "family" : "Roboto",
                      "size" : 11,
                      "sizeUnit" : "px",
                      "style" : "normal",
                      "weight" : "400",
                      "lineHeight" : "1"
                    },
                    "labelColor" : "rgba(0, 0, 0, 0.76)",
                    "enableLabelBackground" : false,
                    "labelBackground" : "rgba(255,255,255,0.56)",
                    "backgroundSettings" : {
                      "type" : "none",
                      "opacity" : 0.4,
                      "gradient" : {
                        "start" : 100,
                        "end" : 0
                      }
                    }
                  },
                  "tooltipValueFormatter" : null,
                  "comparisonSettings" : {
                    "showValuesForComparison" : false,
                    "comparisonValuesLabel" : "",
                    "color" : ""
                  }
                },
                "_hash" : 0.6713650675943844,
                "units" : "%",
                "decimals" : 1,
                "aggregationType" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "data_temperature_2",
                "type" : "timeseries",
                "label" : "Temperatura",
                "color" : "#F44336",
                "settings" : {
                  "yAxisId" : "axis1",
                  "showInLegend" : true,
                  "dataHiddenByDefault" : false,
                  "type" : "line",
                  "lineSettings" : {
                    "showLine" : true,
                    "step" : false,
                    "stepType" : "start",
                    "smooth" : false,
                    "lineType" : "solid",
                    "lineWidth" : 2,
                    "showPoints" : false,
                    "showPointLabel" : false,
                    "pointLabelPosition" : "top",
                    "pointLabelFont" : {
                      "family" : "Roboto",
                      "size" : 11,
                      "sizeUnit" : "px",
                      "style" : "normal",
                      "weight" : "400",
                      "lineHeight" : "1"
                    },
                    "pointLabelColor" : "rgba(0, 0, 0, 0.76)",
                    "enablePointLabelBackground" : false,
                    "pointLabelBackground" : "rgba(255,255,255,0.56)",
                    "pointShape" : "emptyCircle",
                    "pointSize" : 4,
                    "fillAreaSettings" : {
                      "type" : "none",
                      "opacity" : 0.4,
                      "gradient" : {
                        "start" : 100,
                        "end" : 0
                      }
                    }
                  },
                  "barSettings" : {
                    "showBorder" : false,
                    "borderWidth" : 2,
                    "borderRadius" : 0,
                    "showLabel" : false,
                    "labelPosition" : "top",
                    "labelFont" : {
                      "family" : "Roboto",
                      "size" : 11,
                      "sizeUnit" : "px",
                      "style" : "normal",
                      "weight" : "400",
                      "lineHeight" : "1"
                    },
                    "labelColor" : "rgba(0, 0, 0, 0.76)",
                    "enableLabelBackground" : false,
                    "labelBackground" : "rgba(255,255,255,0.56)",
                    "backgroundSettings" : {
                      "type" : "none",
                      "opacity" : 0.4,
                      "gradient" : {
                        "start" : 100,
                        "end" : 0
                      }
                    }
                  },
                  "comparisonSettings" : {
                    "showValuesForComparison" : false,
                    "comparisonValuesLabel" : "",
                    "color" : ""
                  }
                },
                "_hash" : 0.4743401939350059,
                "units" : "Â°C",
                "decimals" : 0
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              },
              "latestDataKeys" : [ {
                "name" : "tankMaxAlarmThreshold",
                "type" : "attribute",
                "label" : "tankMaxAlarmThreshold",
                "color" : "#607d8b",
                "settings" : {
                  "__thresholdKey" : true
                },
                "_hash" : 0.7434718092990319
              }, {
                "name" : "tankMinAlarmThreshold",
                "type" : "attribute",
                "label" : "tankMinAlarmThreshold",
                "color" : "#607d8b",
                "settings" : {
                  "__thresholdKey" : true
                },
                "_hash" : 0.4432859879922736
              } ]
            } ],
            "timewindow" : {
              "hideAggregation" : false,
              "hideAggInterval" : false,
              "hideTimezone" : false,
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 0,
                "interval" : 3600000,
                "timewindowMs" : 604800000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 2,
                "interval" : 300000,
                "timewindowMs" : 18000000,
                "fixedTimewindow" : null,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              },
              "timezone" : null
            },
            "showTitle" : true,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "comparisonEnabled" : false,
              "timeForComparison" : "days",
              "comparisonCustomIntervalValue" : 7200000,
              "comparisonXAxis" : {
                "show" : true,
                "label" : "",
                "labelFont" : {
                  "family" : "Roboto",
                  "size" : 12,
                  "sizeUnit" : "px",
                  "style" : "normal",
                  "weight" : "600",
                  "lineHeight" : "1"
                },
                "labelColor" : "rgba(0, 0, 0, 0.54)",
                "position" : "top",
                "showTickLabels" : true,
                "tickLabelFont" : {
                  "family" : "Roboto",
                  "size" : 10,
                  "sizeUnit" : "px",
                  "style" : "normal",
                  "weight" : "400",
                  "lineHeight" : "1"
                },
                "tickLabelColor" : "rgba(0, 0, 0, 0.54)",
                "ticksFormat" : { },
                "showTicks" : true,
                "ticksColor" : "rgba(0, 0, 0, 0.54)",
                "showLine" : true,
                "lineColor" : "rgba(0, 0, 0, 0.54)",
                "showSplitLines" : true,
                "splitLinesColor" : "rgba(0, 0, 0, 0.12)"
              },
              "yAxes" : {
                "default" : {
                  "units" : "%",
                  "decimals" : 0,
                  "show" : true,
                  "label" : "",
                  "labelFont" : {
                    "family" : "Roboto",
                    "size" : 12,
                    "sizeUnit" : "px",
                    "style" : "normal",
                    "weight" : "600",
                    "lineHeight" : "1"
                  },
                  "labelColor" : "rgba(0, 0, 0, 0.54)",
                  "position" : "left",
                  "showTickLabels" : true,
                  "tickLabelFont" : {
                    "family" : "Roboto",
                    "size" : 12,
                    "sizeUnit" : "px",
                    "style" : "normal",
                    "weight" : "400",
                    "lineHeight" : "1"
                  },
                  "tickLabelColor" : "rgba(0, 0, 0, 0.54)",
                  "ticksFormatter" : null,
                  "showTicks" : true,
                  "ticksColor" : "rgba(0, 0, 0, 0.54)",
                  "showLine" : true,
                  "lineColor" : "rgba(0, 0, 0, 0.54)",
                  "showSplitLines" : true,
                  "splitLinesColor" : "rgba(0, 0, 0, 0.12)",
                  "id" : "default",
                  "order" : 0,
                  "min" : 0,
                  "max" : 100
                },
                "axis1" : {
                  "units" : "Â°C",
                  "decimals" : 0,
                  "show" : true,
                  "label" : "",
                  "labelFont" : {
                    "family" : "Roboto",
                    "size" : 12,
                    "sizeUnit" : "px",
                    "style" : "normal",
                    "weight" : "600",
                    "lineHeight" : "1"
                  },
                  "labelColor" : "rgba(0, 0, 0, 0.54)",
                  "position" : "right",
                  "showTickLabels" : true,
                  "tickLabelFont" : {
                    "family" : "Roboto",
                    "size" : 12,
                    "sizeUnit" : "px",
                    "style" : "normal",
                    "weight" : "400",
                    "lineHeight" : "1"
                  },
                  "tickLabelColor" : "rgba(0, 0, 0, 0.54)",
                  "ticksFormatter" : null,
                  "showTicks" : true,
                  "ticksColor" : "rgba(0, 0, 0, 0.54)",
                  "showLine" : true,
                  "lineColor" : "rgba(0, 0, 0, 0.54)",
                  "showSplitLines" : true,
                  "splitLinesColor" : "rgba(0, 0, 0, 0.12)",
                  "id" : "axis1",
                  "order" : 1,
                  "min" : 0,
                  "max" : 40
                }
              },
              "thresholds" : [ {
                "type" : "latestKey",
                "yAxisId" : "default",
                "units" : "%",
                "decimals" : 0,
                "lineColor" : "#FFAF40",
                "lineType" : "solid",
                "lineWidth" : 2,
                "startSymbol" : "none",
                "startSymbolSize" : 5,
                "endSymbol" : "arrow",
                "endSymbolSize" : 5,
                "showLabel" : true,
                "labelPosition" : "insideEndTop",
                "labelFont" : {
                  "size" : 12,
                  "family" : "Roboto",
                  "weight" : "500",
                  "style" : "normal"
                },
                "labelColor" : "#FFAF40",
                "enableLabelBackground" : false,
                "labelBackground" : "rgba(255,255,255,0.56)",
                "latestKey" : "tankMaxAlarmThreshold",
                "latestKeyType" : "attribute"
              }, {
                "type" : "latestKey",
                "yAxisId" : "default",
                "units" : "%",
                "decimals" : 0,
                "lineColor" : "#FFAF40",
                "lineType" : "solid",
                "lineWidth" : 2,
                "startSymbol" : "none",
                "startSymbolSize" : 5,
                "endSymbol" : "arrow",
                "endSymbolSize" : 5,
                "showLabel" : true,
                "labelPosition" : "insideEndTop",
                "labelFont" : {
                  "family" : "Roboto",
                  "size" : 12,
                  "sizeUnit" : "px",
                  "style" : "normal",
                  "weight" : "400",
                  "lineHeight" : "1"
                },
                "labelColor" : "#FFAF40",
                "enableLabelBackground" : false,
                "labelBackground" : "rgba(255,255,255,0.56)",
                "latestKey" : "tankMinAlarmThreshold",
                "latestKeyType" : "attribute"
              } ],
              "dataZoom" : true,
              "stack" : false,
              "grid" : {
                "show" : false,
                "backgroundColor" : "#FF0000",
                "borderWidth" : 1,
                "borderColor" : "#ccc"
              },
              "xAxis" : {
                "show" : true,
                "label" : "",
                "labelFont" : {
                  "family" : "Roboto",
                  "size" : 12,
                  "sizeUnit" : "px",
                  "style" : "normal",
                  "weight" : "600",
                  "lineHeight" : "1"
                },
                "labelColor" : "rgba(0, 0, 0, 0.54)",
                "position" : "bottom",
                "showTickLabels" : true,
                "tickLabelFont" : {
                  "family" : "Roboto",
                  "size" : 10,
                  "sizeUnit" : "px",
                  "style" : "normal",
                  "weight" : "400",
                  "lineHeight" : "1"
                },
                "tickLabelColor" : "rgba(0, 0, 0, 0.54)",
                "ticksFormat" : { },
                "showTicks" : true,
                "ticksColor" : "rgba(0, 0, 0, 0.54)",
                "showLine" : true,
                "lineColor" : "rgba(0, 0, 0, 0.54)",
                "showSplitLines" : true,
                "splitLinesColor" : "rgba(0, 0, 0, 0.12)"
              },
              "noAggregationBarWidthSettings" : {
                "strategy" : "group",
                "groupWidth" : {
                  "relative" : true,
                  "relativeWidth" : 2,
                  "absoluteWidth" : 1000
                },
                "barWidth" : {
                  "relative" : true,
                  "relativeWidth" : 2,
                  "absoluteWidth" : 1000
                }
              },
              "showLegend" : true,
              "legendColumnTitleFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "16px"
              },
              "legendColumnTitleColor" : "rgba(0, 0, 0, 0.38)",
              "legendLabelFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "16px"
              },
              "legendLabelColor" : "rgba(0, 0, 0, 0.76)",
              "legendValueFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "16px"
              },
              "legendValueColor" : "rgba(0, 0, 0, 0.87)",
              "legendConfig" : {
                "direction" : "column",
                "position" : "top",
                "sortDataKeys" : false,
                "showMin" : true,
                "showMax" : true,
                "showAvg" : true,
                "showTotal" : false,
                "showLatest" : true,
                "valueFormat" : null
              },
              "showTooltip" : true,
              "tooltipTrigger" : "axis",
              "tooltipLabelFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "16px"
              },
              "tooltipLabelColor" : "rgba(0, 0, 0, 0.76)",
              "tooltipValueFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "16px"
              },
              "tooltipValueColor" : "rgba(0, 0, 0, 0.76)",
              "tooltipValueFormatter" : null,
              "tooltipShowDate" : true,
              "tooltipDateFormat" : {
                "format" : "dd/MM/yyyy HH:mm",
                "lastUpdateAgo" : false,
                "custom" : false,
                "auto" : false,
                "autoDateFormatSettings" : { }
              },
              "tooltipDateFont" : {
                "family" : "Roboto",
                "size" : 11,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "16px"
              },
              "tooltipDateColor" : "rgba(0, 0, 0, 0.76)",
              "tooltipDateInterval" : true,
              "tooltipHideZeroValues" : null,
              "tooltipBackgroundColor" : "rgba(255, 255, 255, 0.76)",
              "tooltipBackgroundBlur" : 4,
              "animation" : {
                "animation" : true,
                "animationThreshold" : 2000,
                "animationDuration" : 500,
                "animationEasing" : "cubicOut",
                "animationDelay" : 14,
                "animationDurationUpdate" : 300,
                "animationEasingUpdate" : "cubicOut",
                "animationDelayUpdate" : 0
              },
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "12px"
            },
            "title" : "Nivel vs Tiempo",
            "dropShadow" : true,
            "enableFullscreen" : true,
            "titleStyle" : null,
            "mobileHeight" : null,
            "configMode" : "advanced",
            "actions" : { },
            "showTitleIcon" : false,
            "titleIcon" : "thermostat",
            "iconColor" : "#1F6BDD",
            "useDashboardTimewindow" : false,
            "displayTimewindow" : true,
            "titleFont" : {
              "size" : 16,
              "sizeUnit" : "px",
              "family" : "Roboto",
              "weight" : "500",
              "style" : "normal",
              "lineHeight" : "24px"
            },
            "titleColor" : "rgba(0, 0, 0, 0.87)",
            "titleTooltip" : "",
            "widgetStyle" : { },
            "widgetCss" : "",
            "pageSize" : 1024,
            "units" : "",
            "decimals" : null,
            "noDataDisplayMessage" : "",
            "timewindowStyle" : {
              "showIcon" : true,
              "iconSize" : "24px",
              "icon" : "mdi:clock-edit",
              "iconPosition" : "left",
              "font" : {
                "size" : 12,
                "sizeUnit" : "px",
                "family" : "Roboto",
                "weight" : "400",
                "style" : "normal",
                "lineHeight" : "16px"
              },
              "color" : "rgba(0, 0, 0, 0.38)",
              "displayTypePrefix" : true
            },
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px"
          },
          "row" : 0,
          "col" : 0,
          "id" : "cde8dc17-56b4-08f2-8a43-c1e53244b986"
        },
        "8d39ab28-b058-493f-38d3-52512c31042c" : {
          "typeFullFqn" : "system.temperature_card",
          "type" : "latest",
          "sizeX" : 3,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "waterVolume",
                "type" : "timeseries",
                "label" : "Volumen",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.6500108450787866,
                "aggregationType" : "NONE",
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1755215406568,
                  "endTimeMs" : 1755301806568
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgb(255, 255, 255)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "layout" : "centered",
              "autoScale" : true,
              "showLabel" : true,
              "labelFont" : {
                "family" : "Roboto",
                "size" : 40,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "1.5"
              },
              "labelColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIcon" : true,
              "iconSize" : 40,
              "iconSizeUnit" : "px",
              "icon" : "mdi:car-coolant-level",
              "iconColor" : {
                "type" : "constant",
                "color" : "rgb(57, 146, 255)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';",
                "gradient" : {
                  "advancedMode" : false,
                  "gradient" : [ "rgba(0, 255, 0, 1)", "rgba(255, 0, 0, 1)" ],
                  "gradientAdvanced" : [ {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(0, 255, 0, 1)"
                  }, {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(255, 0, 0, 1)"
                  } ],
                  "minValue" : 0,
                  "maxValue" : 100
                },
                "rangeList" : {
                  "advancedMode" : false,
                  "range" : [ {
                    "from" : null,
                    "to" : -20,
                    "color" : "#234CC7"
                  }, {
                    "from" : -20,
                    "to" : 0,
                    "color" : "#305AD7"
                  }, {
                    "from" : 0,
                    "to" : 10,
                    "color" : "#7191EF"
                  }, {
                    "from" : 10,
                    "to" : 20,
                    "color" : "#FFA600"
                  }, {
                    "from" : 20,
                    "to" : 30,
                    "color" : "#F36900"
                  }, {
                    "from" : 30,
                    "to" : 40,
                    "color" : "#F04022"
                  }, {
                    "from" : 40,
                    "to" : null,
                    "color" : "#D81838"
                  } ]
                }
              },
              "valueFont" : {
                "family" : "Roboto",
                "size" : 60,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "100%"
              },
              "valueColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';",
                "gradient" : {
                  "advancedMode" : false,
                  "gradient" : [ "rgba(0, 255, 0, 1)", "rgba(255, 0, 0, 1)" ],
                  "gradientAdvanced" : [ {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(0, 255, 0, 1)"
                  }, {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(255, 0, 0, 1)"
                  } ],
                  "minValue" : 0,
                  "maxValue" : 100
                },
                "rangeList" : {
                  "advancedMode" : false,
                  "range" : [ {
                    "from" : null,
                    "to" : -20,
                    "color" : "#234CC7"
                  }, {
                    "from" : -20,
                    "to" : 0,
                    "color" : "#305AD7"
                  }, {
                    "from" : 0,
                    "to" : 10,
                    "color" : "#7191EF"
                  }, {
                    "from" : 10,
                    "to" : 20,
                    "color" : "#FFA600"
                  }, {
                    "from" : 20,
                    "to" : 30,
                    "color" : "#F36900"
                  }, {
                    "from" : 30,
                    "to" : 40,
                    "color" : "#F04022"
                  }, {
                    "from" : 40,
                    "to" : null,
                    "color" : "#D81838"
                  } ]
                }
              },
              "showDate" : true,
              "dateFormat" : {
                "format" : null,
                "lastUpdateAgo" : true,
                "custom" : false,
                "auto" : false
              },
              "dateFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "1.33"
              },
              "dateColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.38)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : ""
            },
            "title" : "Temperature card",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "units" : "L",
            "decimals" : 0,
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "widgetStyle" : { },
            "actions" : { },
            "configMode" : "advanced",
            "displayTimewindow" : true,
            "margin" : "0",
            "borderRadius" : "0px",
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "titleFont" : {
              "size" : 12,
              "sizeUnit" : "px",
              "family" : null,
              "weight" : null,
              "style" : null,
              "lineHeight" : "1.6"
            },
            "titleIcon" : "",
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "14px",
            "timewindowStyle" : {
              "showIcon" : true,
              "iconSize" : "14px",
              "icon" : "query_builder",
              "iconPosition" : "left",
              "font" : {
                "size" : 12,
                "sizeUnit" : "px",
                "family" : null,
                "weight" : null,
                "style" : null,
                "lineHeight" : "1"
              },
              "color" : null
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "8d39ab28-b058-493f-38d3-52512c31042c"
        },
        "ba33a64d-74d2-e8d7-8d0e-ee2e2d10d17c" : {
          "typeFullFqn" : "system.temperature_card",
          "type" : "latest",
          "sizeX" : 3,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "data_temperature_2",
                "type" : "timeseries",
                "label" : "Temperatura",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.0641783889909967
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1755214883758,
                  "endTimeMs" : 1755301283758
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "layout" : "centered",
              "autoScale" : true,
              "showLabel" : true,
              "labelFont" : {
                "family" : "Roboto",
                "size" : 40,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "1.5"
              },
              "labelColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIcon" : true,
              "iconSize" : 40,
              "iconSizeUnit" : "px",
              "icon" : "thermostat",
              "iconColor" : {
                "type" : "range",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';",
                "rangeList" : {
                  "advancedMode" : false,
                  "range" : [ {
                    "from" : null,
                    "to" : -20,
                    "color" : "#234CC7"
                  }, {
                    "from" : -20,
                    "to" : 0,
                    "color" : "#305AD7"
                  }, {
                    "from" : 0,
                    "to" : 10,
                    "color" : "#7191EF"
                  }, {
                    "from" : 10,
                    "to" : 20,
                    "color" : "#FFA600"
                  }, {
                    "from" : 20,
                    "to" : 30,
                    "color" : "#F36900"
                  }, {
                    "from" : 30,
                    "to" : 40,
                    "color" : "#F04022"
                  }, {
                    "from" : 40,
                    "to" : null,
                    "color" : "#D81838"
                  } ]
                }
              },
              "valueFont" : {
                "family" : "Roboto",
                "size" : 60,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "100%"
              },
              "valueColor" : {
                "type" : "range",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';",
                "rangeList" : {
                  "advancedMode" : false,
                  "range" : [ {
                    "from" : null,
                    "to" : -20,
                    "color" : "#234CC7"
                  }, {
                    "from" : -20,
                    "to" : 0,
                    "color" : "#305AD7"
                  }, {
                    "from" : 0,
                    "to" : 10,
                    "color" : "#7191EF"
                  }, {
                    "from" : 10,
                    "to" : 20,
                    "color" : "#FFA600"
                  }, {
                    "from" : 20,
                    "to" : 30,
                    "color" : "#F36900"
                  }, {
                    "from" : 30,
                    "to" : 40,
                    "color" : "#F04022"
                  }, {
                    "from" : 40,
                    "to" : null,
                    "color" : "#D81838"
                  } ]
                }
              },
              "showDate" : true,
              "dateFormat" : {
                "format" : null,
                "lastUpdateAgo" : true,
                "custom" : false,
                "auto" : false
              },
              "dateFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "1.33"
              },
              "dateColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.38)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : ""
            },
            "title" : "Temperature card",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "units" : "Â°C",
            "decimals" : 0,
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "widgetStyle" : { },
            "actions" : { },
            "configMode" : "advanced",
            "displayTimewindow" : true,
            "margin" : "0px",
            "borderRadius" : "0px",
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "titleFont" : {
              "size" : 12,
              "sizeUnit" : "px",
              "family" : null,
              "weight" : null,
              "style" : null,
              "lineHeight" : "1.6"
            },
            "titleIcon" : "",
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "14px",
            "timewindowStyle" : {
              "showIcon" : true,
              "iconSize" : "14px",
              "icon" : "query_builder",
              "iconPosition" : "left",
              "font" : {
                "size" : 12,
                "sizeUnit" : "px",
                "family" : null,
                "weight" : null,
                "style" : null,
                "lineHeight" : "1"
              },
              "color" : null
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "ba33a64d-74d2-e8d7-8d0e-ee2e2d10d17c"
        },
        "fa593b45-ec47-29c1-96b2-7a2a886f9c3f" : {
          "typeFullFqn" : "system.temperature_card",
          "type" : "latest",
          "sizeX" : 3,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "waterLevelPerc",
                "type" : "timeseries",
                "label" : "Nivel",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.6500108450787866,
                "aggregationType" : "NONE",
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1755215406568,
                  "endTimeMs" : 1755301806568
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgb(255, 255, 255)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0",
            "settings" : {
              "layout" : "centered",
              "autoScale" : true,
              "showLabel" : true,
              "labelFont" : {
                "size" : 40,
                "sizeUnit" : "px",
                "family" : "Roboto",
                "weight" : "500",
                "style" : "normal",
                "lineHeight" : "1.5"
              },
              "labelColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIcon" : true,
              "iconSize" : 40,
              "iconSizeUnit" : "px",
              "icon" : "mdi:car-coolant-level",
              "iconColor" : {
                "type" : "constant",
                "color" : "rgb(57, 146, 255)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';",
                "gradient" : {
                  "advancedMode" : false,
                  "gradient" : [ "rgba(0, 255, 0, 1)", "rgba(255, 0, 0, 1)" ],
                  "gradientAdvanced" : [ {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(0, 255, 0, 1)"
                  }, {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(255, 0, 0, 1)"
                  } ],
                  "minValue" : 0,
                  "maxValue" : 100
                },
                "rangeList" : {
                  "advancedMode" : false,
                  "range" : [ {
                    "from" : null,
                    "to" : -20,
                    "color" : "#234CC7"
                  }, {
                    "from" : -20,
                    "to" : 0,
                    "color" : "#305AD7"
                  }, {
                    "from" : 0,
                    "to" : 10,
                    "color" : "#7191EF"
                  }, {
                    "from" : 10,
                    "to" : 20,
                    "color" : "#FFA600"
                  }, {
                    "from" : 20,
                    "to" : 30,
                    "color" : "#F36900"
                  }, {
                    "from" : 30,
                    "to" : 40,
                    "color" : "#F04022"
                  }, {
                    "from" : 40,
                    "to" : null,
                    "color" : "#D81838"
                  } ]
                }
              },
              "valueFont" : {
                "family" : "Roboto",
                "size" : 60,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "100%"
              },
              "valueColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';",
                "gradient" : {
                  "advancedMode" : false,
                  "gradient" : [ "rgba(0, 255, 0, 1)", "rgba(255, 0, 0, 1)" ],
                  "gradientAdvanced" : [ {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(0, 255, 0, 1)"
                  }, {
                    "source" : {
                      "type" : "constant"
                    },
                    "color" : "rgba(255, 0, 0, 1)"
                  } ],
                  "minValue" : 0,
                  "maxValue" : 100
                },
                "rangeList" : {
                  "advancedMode" : false,
                  "range" : [ {
                    "from" : null,
                    "to" : -20,
                    "color" : "#234CC7"
                  }, {
                    "from" : -20,
                    "to" : 0,
                    "color" : "#305AD7"
                  }, {
                    "from" : 0,
                    "to" : 10,
                    "color" : "#7191EF"
                  }, {
                    "from" : 10,
                    "to" : 20,
                    "color" : "#FFA600"
                  }, {
                    "from" : 20,
                    "to" : 30,
                    "color" : "#F36900"
                  }, {
                    "from" : 30,
                    "to" : 40,
                    "color" : "#F04022"
                  }, {
                    "from" : 40,
                    "to" : null,
                    "color" : "#D81838"
                  } ]
                }
              },
              "showDate" : true,
              "dateFormat" : {
                "format" : null,
                "lastUpdateAgo" : true,
                "custom" : false,
                "auto" : false
              },
              "dateFont" : {
                "family" : "Roboto",
                "size" : 12,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "500",
                "lineHeight" : "1.33"
              },
              "dateColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.38)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : ""
            },
            "title" : "Temperature card",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "units" : "%",
            "decimals" : 0,
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "widgetStyle" : { },
            "actions" : { },
            "configMode" : "advanced",
            "displayTimewindow" : true,
            "margin" : "0",
            "borderRadius" : "0px",
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "titleFont" : {
              "size" : 12,
              "sizeUnit" : "px",
              "family" : null,
              "weight" : null,
              "style" : null,
              "lineHeight" : "1.6"
            },
            "titleIcon" : "",
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "14px",
            "timewindowStyle" : {
              "showIcon" : true,
              "iconSize" : "14px",
              "icon" : "query_builder",
              "iconPosition" : "left",
              "font" : {
                "size" : 12,
                "sizeUnit" : "px",
                "family" : null,
                "weight" : null,
                "style" : null,
                "lineHeight" : "1"
              },
              "color" : null
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "fa593b45-ec47-29c1-96b2-7a2a886f9c3f"
        },
        "208c634c-f5bd-f809-dc5e-ed4259f13f90" : {
          "typeFullFqn" : "system.label_value_card",
          "type" : "latest",
          "sizeX" : 4.5,
          "sizeY" : 1,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "deviceId" : null,
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "data_frequency_1",
                "type" : "timeseries",
                "label" : "data_frequency_1",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.9977997268768006,
                "aggregationType" : "NONE",
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : true,
                "postFuncBody" : "    const secs = Number(value);\r\n    if (!isFinite(secs)) {\r\n        return '';\r\n    }\r\n    if (secs >= 3600) {\r\n        const hs = secs / 3600;\r\n        return hs.toFixed(2) + ' hs';\r\n    } else if (secs >= 60) {\r\n        const mins = secs / 60;\r\n        return mins.toFixed(0) + ' min';\r\n    } else {\r\n        return secs.toFixed(0) + ' s';\r\n    }\r\n"
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1754260604418,
                  "endTimeMs" : 1754347004418
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "autoScale" : true,
              "showLabel" : true,
              "label" : "Intervalo:",
              "labelFont" : {
                "family" : "Roboto",
                "size" : 20,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "24px"
              },
              "labelColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "showIcon" : true,
              "iconSize" : 24,
              "iconSizeUnit" : "px",
              "icon" : "schedule",
              "iconColor" : {
                "type" : "constant",
                "color" : "#5469FF",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "valueFont" : {
                "family" : "Roboto",
                "size" : 20,
                "sizeUnit" : "px",
                "style" : "normal",
                "weight" : "400",
                "lineHeight" : "24px"
              },
              "valueColor" : {
                "type" : "constant",
                "color" : "rgba(0, 0, 0, 0.87)",
                "colorFunction" : "var temperature = value;\nif (typeof temperature !== undefined) {\n  var percent = (temperature + 60)/120 * 100;\n  return tinycolor.mix('blue', 'red', percent).toHexString();\n}\nreturn 'blue';"
              },
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "12px"
            },
            "title" : "Label & value card",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "units" : "",
            "decimals" : 0,
            "useDashboardTimewindow" : true,
            "widgetStyle" : { },
            "actions" : { },
            "configMode" : "basic",
            "displayTimewindow" : true,
            "margin" : "0px",
            "borderRadius" : "0px",
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "titleFont" : {
              "size" : 12,
              "sizeUnit" : "px",
              "family" : null,
              "weight" : null,
              "style" : null,
              "lineHeight" : "1.6"
            },
            "titleIcon" : "",
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "14px",
            "timewindowStyle" : {
              "showIcon" : true,
              "iconSize" : "14px",
              "icon" : "query_builder",
              "iconPosition" : "left",
              "font" : {
                "size" : 12,
                "sizeUnit" : "px",
                "family" : null,
                "weight" : null,
                "style" : null,
                "lineHeight" : "1"
              },
              "color" : null
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "208c634c-f5bd-f809-dc5e-ed4259f13f90"
        },
        "529e636b-2124-578c-82c5-ff8da2204bf4" : {
          "typeFullFqn" : "system.map",
          "type" : "latest",
          "sizeX" : 8.5,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1741884755143,
                  "endTimeMs" : 1741971155143
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "mapType" : "geoMap",
              "layers" : [ {
                "label" : "{i18n:widgets.maps.layer.hybrid}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery",
                "referenceLayer" : "openstreetmap_hybrid"
              }, {
                "label" : "{i18n:widgets.maps.layer.satellite}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery"
              }, {
                "label" : "{i18n:widgets.maps.layer.roadmap}",
                "provider" : "openstreet",
                "layerType" : "OpenStreetMap.Mapnik"
              } ],
              "imageSource" : null,
              "markers" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : [ {
                  "name" : "temperature",
                  "type" : "timeseries",
                  "label" : "temperature",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.570889787682481,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "humidity",
                  "type" : "timeseries",
                  "label" : "humidity",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13597394595782442,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "active",
                  "type" : "attribute",
                  "label" : "active",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21080919932756603
                }, {
                  "name" : "type",
                  "type" : "entityField",
                  "label" : "Tipo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.1357587191053956
                }, {
                  "name" : "pozo",
                  "type" : "timeseries",
                  "label" : "pozo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6817815369277647,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : false,
                  "postFuncBody" : null
                }, {
                  "name" : "nivelAguada",
                  "type" : "timeseries",
                  "label" : "nivelAguada",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.41051360922605606,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "nivelTanque",
                  "type" : "timeseries",
                  "label" : "nivelTanque",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.10653271737889158,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "windDir",
                  "type" : "timeseries",
                  "label" : "windDir",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7494149641343646
                }, {
                  "name" : "windSpeed",
                  "type" : "timeseries",
                  "label" : "windSpeed",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6909522833646339
                }, {
                  "name" : "rain",
                  "type" : "timeseries",
                  "label" : "rain",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.3165646978758382
                }, {
                  "name" : "comedero1",
                  "type" : "timeseries",
                  "label" : "comedero1",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5447639875242816
                }, {
                  "name" : "comedero2",
                  "type" : "timeseries",
                  "label" : "comedero2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13120470438313603
                }, {
                  "name" : "comedero3",
                  "type" : "timeseries",
                  "label" : "comedero3",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21122955934647059
                }, {
                  "name" : "pressure",
                  "type" : "timeseries",
                  "label" : "pressure",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6357233440039781
                }, {
                  "name" : "nivelNapa",
                  "type" : "timeseries",
                  "label" : "nivelNapa",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5158796826873344
                }, {
                  "name" : "waterVolume",
                  "type" : "timeseries",
                  "label" : "waterVolume",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8649181166822368
                }, {
                  "name" : "waterLevelPerc",
                  "type" : "timeseries",
                  "label" : "waterLevelPerc",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8782297497321601
                }, {
                  "name" : "data_temperature_2",
                  "type" : "timeseries",
                  "label" : "data_temperature_2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7747460584745568
                } ],
                "label" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "${entityName}",
                  "patternFunction" : "\nvar color;\nif(data.active !== \"true\"){\n    color = 'rgb(255, 0, 0)';\n} else {\n    color = 'rgb(39, 134, 34)';\n}\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \n           '${entityLabel}' + \n        '</span>'"
                },
                "tooltip" : {
                  "show" : true,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "function",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Temperature:</b> ${temperature:1} Â°C<br/><b>Humidity:</b> ${humidity:0} %<br/><br/><link-act name=\"navigate_to_details\">Detalles</link-act><br/>",
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "patternFunction" : "var deviceType = data.Tipo;\r\n\r\nfunction buildRow(label, value) {\r\n    return `\r\n        <div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">\r\n            <div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:120px\">${label}</div>\r\n            <div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px;color:#29313C\">${value}</div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nif (typeof deviceType !== 'undefined') {\r\n    let content = `\r\n    <div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:'Roboto';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">\r\n        <div>${data.entityLabel ?? 'Sin nombre'}</div>\r\n        <div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>\r\n    `;\r\n\r\n    if (deviceType === \"lanza\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`);\r\n    } else if (deviceType === \"estMeteo\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Viento\", `${data.windSpeed?.toFixed(1) ?? 'N/A'} m/s`) +\r\n            buildRow(\"DirecciÃ³n\", `${data.windDir?.toFixed(0) ?? 'N/A'}Â°`) +\r\n            buildRow(\"Lluvia\", `${data.rain?.toFixed(1) ?? 'N/A'} mm`) +\r\n            buildRow(\"PresiÃ³n\", `${data.pressure?.toFixed(1) ?? 'N/A'} hPa`);\r\n    } else if (deviceType === \"pozo\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Aguada\", `${data.nivelAguada?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Nivel de Tanque\", `${data.nivelTanque?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Pozo\", estadoPozo);\r\n    } else if (deviceType === \"Ultrasonico\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Tanque\", `${data.waterLevelPerc?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Volumen de Tanque\", `${data.waterVolume?.toFixed(0) ?? 'N/A'} L`) +\r\n            buildRow(\"Temperatura\", `${data.data_temperature_2?.toFixed(1) ?? 'N/A'} Â°C`)\r\n    } else if (deviceType === \"Freatimetro\") {\r\n        content +=\r\n            buildRow(\"Nivel Napa\", `${data.nivelNapa?.toFixed(1) ?? 'N/A'} m`);\r\n    } else if (deviceType === \"comedero\") {\r\n        content +=\r\n            buildRow(\"Comedero 1\", `${data.comedero1?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 2\", `${data.comedero2?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 3\", `${data.comedero3?.toFixed(0) ?? 'N/A'} %`);\r\n    } else {\r\n        content += buildRow(\"Tipo\", \"Desconocido\");\r\n    }\r\n\r\n    content += `\r\n    <div style=\"text-align:center; margin-top:16px;\">\r\n        <link-act name=\"navigate_to_details\">Detalles</link-act>\r\n    </div>\r\n</div>`;\r\n\r\n\r\n\r\n    return content;\r\n}\r\n\r\nreturn `<b>${data.entityName ?? 'Dispositivo'}</b><br/>Tipo desconocido<br/>`;\r\n",
                  "tagActions" : [ {
                    "name" : "navigate_to_details",
                    "type" : "custom",
                    "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.updateState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                    "openInSeparateDialog" : false,
                    "openInPopover" : false
                  } ]
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ "add", "move" ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "sensors",
                  "size" : 48,
                  "color" : {
                    "type" : "function",
                    "color" : "rgb(255, 0, 0)",
                    "range" : null,
                    "colorFunction" : "if (data.active !== \"true\"){\n   return 'rgb(255, 0, 0)';\n} else {\n   return 'rgb(39, 134, 34)';\n}"
                  }
                },
                "markerImage" : {
                  "type" : "function",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34,
                  "imageFunction" : "return {};",
                  "images" : [ ]
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : true,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : true,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              }, {
                "dsType" : "entity",
                "dsLabel" : "",
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "shape",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "mdi:lightbulb-on",
                  "size" : 48,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerImage" : {
                  "type" : "image",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "positionFunction" : "return {x: origXPos, y: origYPos};",
                "markerClustering" : {
                  "enable" : false,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : false,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                },
                "label" : {
                  "show" : true,
                  "type" : "pattern",
                  "pattern" : "${entityName}"
                },
                "tooltip" : {
                  "show" : true,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "pattern",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} Â°C<br/><small>See tooltip settings for details</small>",
                  "offsetX" : 0,
                  "offsetY" : -1
                },
                "click" : {
                  "type" : "doNothing"
                },
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "dsEntityAliasId" : "cc632199-91cf-d1c5-f43e-5f1f6a6d9bf4"
              } ],
              "polygons" : [ ],
              "circles" : [ ],
              "additionalDataSources" : [ ],
              "controlsPosition" : "topleft",
              "zoomActions" : [ "scroll", "doubleClick", "controlButtons" ],
              "scales" : [ "metric" ],
              "dragModeButton" : false,
              "fitMapBounds" : true,
              "useDefaultCenterPosition" : false,
              "defaultCenterPosition" : "0,0",
              "defaultZoomLevel" : 14,
              "mapPageSize" : 16384,
              "mapActionButtons" : [ ],
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "0"
            },
            "title" : "Map",
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "/* Oculta la barra de attribution */\r\n.leaflet-control-attribution { \r\n  display: none !important; \r\n}\r\n\r\n/* Por si tu tema pone contenedores extra */\r\n.leaflet-bottom.leaflet-right .leaflet-control-attribution {\r\n  display: none !important;\r\n}\r\n",
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "configMode" : "advanced",
            "titleFont" : null,
            "titleColor" : null,
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px",
            "titleIcon" : "map",
            "iconColor" : "#1F6BDD",
            "actions" : { }
          },
          "row" : 0,
          "col" : 0,
          "id" : "529e636b-2124-578c-82c5-ff8da2204bf4"
        },
        "7aa81012-5fbf-6868-e0c5-751660c8806c" : {
          "typeFullFqn" : "system.input_widgets.update_multiple_attributes",
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ {
                "name" : "latitude",
                "type" : "attribute",
                "label" : "Latitud",
                "color" : "#2196f3",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "double",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.2916078179441628,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              }, {
                "name" : "longitude",
                "type" : "attribute",
                "label" : "Longitud",
                "color" : "#4caf50",
                "settings" : {
                  "dataKeyHidden" : false,
                  "dataKeyType" : "server",
                  "dataKeyValueType" : "double",
                  "required" : false,
                  "isEditable" : "editable",
                  "disabledOnDataKey" : "",
                  "appearance" : "outline",
                  "subscriptSizing" : "fixed",
                  "slideToggleLabelPosition" : "after",
                  "selectOptions" : [ ],
                  "radioColor" : null,
                  "radioColumns" : 1,
                  "radioLabelPosition" : "after",
                  "step" : 1,
                  "minValue" : null,
                  "maxValue" : null,
                  "requiredErrorMessage" : "",
                  "minValueErrorMessage" : "",
                  "maxValueErrorMessage" : "",
                  "invalidDateErrorMessage" : "",
                  "invalidJsonErrorMessage" : "",
                  "dialogTitle" : "",
                  "saveButtonLabel" : "",
                  "cancelButtonLabel" : "",
                  "useCustomIcon" : false,
                  "icon" : "",
                  "customIcon" : "",
                  "useGetValueFunction" : false,
                  "getValueFunctionBody" : "",
                  "useSetValueFunction" : false,
                  "setValueFunctionBody" : ""
                },
                "_hash" : 0.9263452609889278,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1758932701494,
                  "endTimeMs" : 1759019101494
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#fff",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "8px",
            "settings" : {
              "widgetTitle" : "",
              "showResultMessage" : true,
              "showActionButtons" : true,
              "updateAllValues" : false,
              "saveButtonLabel" : "",
              "resetButtonLabel" : "",
              "showGroupTitle" : false,
              "groupTitle" : "${entityName}",
              "fieldsAlignment" : "row",
              "fieldsInRow" : 2,
              "rowGap" : 5,
              "columnGap" : 10
            },
            "title" : "Update Multiple Attributes",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "enableDataExport" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "actions" : { },
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "7aa81012-5fbf-6868-e0c5-751660c8806c"
        },
        "6880b58b-e64a-fc38-05a4-8fa5ca17acac" : {
          "typeFullFqn" : "system.map",
          "type" : "latest",
          "sizeX" : 8.5,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1741884755143,
                  "endTimeMs" : 1741971155143
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "mapType" : "geoMap",
              "layers" : [ {
                "label" : "{i18n:widgets.maps.layer.hybrid}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery",
                "referenceLayer" : "openstreetmap_hybrid"
              }, {
                "label" : "{i18n:widgets.maps.layer.satellite}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery"
              }, {
                "label" : "{i18n:widgets.maps.layer.roadmap}",
                "provider" : "openstreet",
                "layerType" : "OpenStreetMap.Mapnik"
              } ],
              "imageSource" : null,
              "markers" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : [ {
                  "name" : "temperature",
                  "type" : "timeseries",
                  "label" : "temperature",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.570889787682481,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "humidity",
                  "type" : "timeseries",
                  "label" : "humidity",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13597394595782442,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "active",
                  "type" : "attribute",
                  "label" : "active",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21080919932756603
                }, {
                  "name" : "type",
                  "type" : "entityField",
                  "label" : "Tipo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.1357587191053956
                }, {
                  "name" : "pozo",
                  "type" : "timeseries",
                  "label" : "pozo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6817815369277647,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : false,
                  "postFuncBody" : null
                }, {
                  "name" : "nivelAguada",
                  "type" : "timeseries",
                  "label" : "nivelAguada",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.41051360922605606,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "nivelTanque",
                  "type" : "timeseries",
                  "label" : "nivelTanque",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.10653271737889158,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "windDir",
                  "type" : "timeseries",
                  "label" : "windDir",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7494149641343646
                }, {
                  "name" : "windSpeed",
                  "type" : "timeseries",
                  "label" : "windSpeed",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6909522833646339
                }, {
                  "name" : "rain",
                  "type" : "timeseries",
                  "label" : "rain",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.3165646978758382
                }, {
                  "name" : "comedero1",
                  "type" : "timeseries",
                  "label" : "comedero1",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5447639875242816
                }, {
                  "name" : "comedero2",
                  "type" : "timeseries",
                  "label" : "comedero2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13120470438313603
                }, {
                  "name" : "comedero3",
                  "type" : "timeseries",
                  "label" : "comedero3",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21122955934647059
                }, {
                  "name" : "pressure",
                  "type" : "timeseries",
                  "label" : "pressure",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6357233440039781
                }, {
                  "name" : "nivelNapa",
                  "type" : "timeseries",
                  "label" : "nivelNapa",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5158796826873344
                }, {
                  "name" : "waterVolume",
                  "type" : "timeseries",
                  "label" : "waterVolume",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8649181166822368
                }, {
                  "name" : "waterLevelPerc",
                  "type" : "timeseries",
                  "label" : "waterLevelPerc",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8782297497321601
                }, {
                  "name" : "data_temperature_2",
                  "type" : "timeseries",
                  "label" : "data_temperature_2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7747460584745568
                } ],
                "label" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "${entityName}",
                  "patternFunction" : "\nvar color;\nif(data.active !== \"true\"){\n    color = 'rgb(255, 0, 0)';\n} else {\n    color = 'rgb(39, 134, 34)';\n}\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \n           '${entityLabel}' + \n        '</span>'"
                },
                "tooltip" : {
                  "show" : true,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "function",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Temperature:</b> ${temperature:1} Â°C<br/><b>Humidity:</b> ${humidity:0} %<br/><br/><link-act name=\"navigate_to_details\">Detalles</link-act><br/>",
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "patternFunction" : "var deviceType = data.Tipo;\r\n\r\nfunction buildRow(label, value) {\r\n    return `\r\n        <div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">\r\n            <div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:120px\">${label}</div>\r\n            <div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px;color:#29313C\">${value}</div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nif (typeof deviceType !== 'undefined') {\r\n    let content = `\r\n    <div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:'Roboto';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">\r\n        <div>${data.entityLabel ?? 'Sin nombre'}</div>\r\n        <div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>\r\n    `;\r\n\r\n    if (deviceType === \"lanza\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`);\r\n    } else if (deviceType === \"estMeteo\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Viento\", `${data.windSpeed?.toFixed(1) ?? 'N/A'} m/s`) +\r\n            buildRow(\"DirecciÃ³n\", `${data.windDir?.toFixed(0) ?? 'N/A'}Â°`) +\r\n            buildRow(\"Lluvia\", `${data.rain?.toFixed(1) ?? 'N/A'} mm`) +\r\n            buildRow(\"PresiÃ³n\", `${data.pressure?.toFixed(1) ?? 'N/A'} hPa`);\r\n    } else if (deviceType === \"pozo\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Aguada\", `${data.nivelAguada?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Nivel de Tanque\", `${data.nivelTanque?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Pozo\", estadoPozo);\r\n    } else if (deviceType === \"Ultrasonico\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Tanque\", `${data.waterLevelPerc?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Volumen de Tanque\", `${data.waterVolume?.toFixed(0) ?? 'N/A'} L`) +\r\n            buildRow(\"Temperatura\", `${data.data_temperature_2?.toFixed(1) ?? 'N/A'} Â°C`)\r\n    } else if (deviceType === \"Freatimetro\") {\r\n        content +=\r\n            buildRow(\"Nivel Napa\", `${data.nivelNapa?.toFixed(1) ?? 'N/A'} m`);\r\n    } else if (deviceType === \"comedero\") {\r\n        content +=\r\n            buildRow(\"Comedero 1\", `${data.comedero1?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 2\", `${data.comedero2?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 3\", `${data.comedero3?.toFixed(0) ?? 'N/A'} %`);\r\n    } else {\r\n        content += buildRow(\"Tipo\", \"Desconocido\");\r\n    }\r\n\r\n    content += `\r\n    <div style=\"text-align:center; margin-top:16px;\">\r\n        <link-act name=\"navigate_to_details\">Detalles</link-act>\r\n    </div>\r\n</div>`;\r\n\r\n\r\n\r\n    return content;\r\n}\r\n\r\nreturn `<b>${data.entityName ?? 'Dispositivo'}</b><br/>Tipo desconocido<br/>`;\r\n",
                  "tagActions" : [ {
                    "name" : "navigate_to_details",
                    "type" : "custom",
                    "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.updateState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                    "openInSeparateDialog" : false,
                    "openInPopover" : false
                  } ]
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ "move" ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "sensors",
                  "size" : 48,
                  "color" : {
                    "type" : "function",
                    "color" : "rgb(255, 0, 0)",
                    "range" : null,
                    "colorFunction" : "if (data.active !== \"true\"){\n   return 'rgb(255, 0, 0)';\n} else {\n   return 'rgb(39, 134, 34)';\n}"
                  }
                },
                "markerImage" : {
                  "type" : "function",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34,
                  "imageFunction" : "return {};",
                  "images" : [ ]
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : true,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : true,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              }, {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "4db0de46-9963-11ff-d3dc-63bf8867bbd7",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : null,
                "label" : {
                  "show" : false,
                  "type" : "pattern",
                  "pattern" : "",
                  "patternFunction" : null
                },
                "tooltip" : {
                  "show" : false,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "pattern",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} Â°C<br/><small>See tooltip settings for details</small>",
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "patternFunction" : null,
                  "tagActions" : null
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ "add", "move", "remove" ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape6",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "home",
                  "size" : 48,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerImage" : {
                  "type" : "image",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : false,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : false,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              } ],
              "polygons" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "4db0de46-9963-11ff-d3dc-63bf8867bbd7",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : null,
                "label" : {
                  "show" : false,
                  "type" : "pattern",
                  "pattern" : "${entityName}"
                },
                "tooltip" : {
                  "show" : false,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "pattern",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
                  "offsetX" : 0,
                  "offsetY" : -1
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "fillType" : "color",
                "fillColor" : {
                  "type" : "constant",
                  "color" : "rgba(32, 32, 32, 0)",
                  "rangeKey" : null,
                  "range" : null,
                  "colorFunction" : null
                },
                "fillStripe" : {
                  "weight" : 3,
                  "color" : {
                    "type" : "constant",
                    "color" : "#8f8f8f"
                  },
                  "spaceWeight" : 9,
                  "spaceColor" : {
                    "type" : "constant",
                    "color" : "rgba(143,143,143,0)"
                  },
                  "angle" : 45
                },
                "fillImage" : {
                  "type" : "image",
                  "image" : "/assets/widget-preview-empty.svg",
                  "preserveAspectRatio" : true,
                  "opacity" : 1,
                  "angle" : 0,
                  "scale" : 1
                },
                "strokeColor" : {
                  "type" : "constant",
                  "color" : "#3388ff"
                },
                "strokeWeight" : 3,
                "polygonKey" : {
                  "name" : "fieldPerimeter",
                  "label" : "Perimetro",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3",
                  "aggregationType" : null,
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : null,
                  "postFuncBody" : null
                }
              } ],
              "circles" : [ ],
              "additionalDataSources" : [ ],
              "controlsPosition" : "topleft",
              "zoomActions" : [ "scroll", "doubleClick", "controlButtons" ],
              "scales" : [ "metric" ],
              "dragModeButton" : false,
              "fitMapBounds" : true,
              "useDefaultCenterPosition" : false,
              "defaultCenterPosition" : "0,0",
              "defaultZoomLevel" : 14,
              "mapPageSize" : 16384,
              "mapActionButtons" : [ ],
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "0"
            },
            "title" : "Map",
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "/* Oculta la barra de attribution */\r\n.leaflet-control-attribution { \r\n  display: none !important; \r\n}\r\n\r\n/* Por si tu tema pone contenedores extra */\r\n.leaflet-bottom.leaflet-right .leaflet-control-attribution {\r\n  display: none !important;\r\n}\r\n",
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "configMode" : "advanced",
            "titleFont" : null,
            "titleColor" : null,
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px",
            "titleIcon" : "map",
            "iconColor" : "#1F6BDD",
            "actions" : { }
          },
          "row" : 0,
          "col" : 0,
          "id" : "6880b58b-e64a-fc38-05a4-8fa5ca17acac"
        },
        "27f9305b-910e-3990-03b3-13f904b50700" : {
          "typeFullFqn" : "system.map",
          "type" : "latest",
          "sizeX" : 8.5,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1741884755143,
                  "endTimeMs" : 1741971155143
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "mapType" : "geoMap",
              "layers" : [ {
                "label" : "{i18n:widgets.maps.layer.hybrid}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery",
                "referenceLayer" : "openstreetmap_hybrid"
              }, {
                "label" : "{i18n:widgets.maps.layer.satellite}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery"
              }, {
                "label" : "{i18n:widgets.maps.layer.roadmap}",
                "provider" : "openstreet",
                "layerType" : "OpenStreetMap.Mapnik"
              } ],
              "imageSource" : null,
              "markers" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : [ {
                  "name" : "temperature",
                  "type" : "timeseries",
                  "label" : "temperature",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.570889787682481,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "humidity",
                  "type" : "timeseries",
                  "label" : "humidity",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13597394595782442,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "active",
                  "type" : "attribute",
                  "label" : "active",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21080919932756603
                }, {
                  "name" : "type",
                  "type" : "entityField",
                  "label" : "Tipo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.1357587191053956
                }, {
                  "name" : "pozo",
                  "type" : "timeseries",
                  "label" : "pozo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6817815369277647,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : false,
                  "postFuncBody" : null
                }, {
                  "name" : "nivelAguada",
                  "type" : "timeseries",
                  "label" : "nivelAguada",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.41051360922605606,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "nivelTanque",
                  "type" : "timeseries",
                  "label" : "nivelTanque",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.10653271737889158,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "windDir",
                  "type" : "timeseries",
                  "label" : "windDir",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7494149641343646
                }, {
                  "name" : "windSpeed",
                  "type" : "timeseries",
                  "label" : "windSpeed",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6909522833646339
                }, {
                  "name" : "rain",
                  "type" : "timeseries",
                  "label" : "rain",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.3165646978758382
                }, {
                  "name" : "comedero1",
                  "type" : "timeseries",
                  "label" : "comedero1",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5447639875242816
                }, {
                  "name" : "comedero2",
                  "type" : "timeseries",
                  "label" : "comedero2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13120470438313603
                }, {
                  "name" : "comedero3",
                  "type" : "timeseries",
                  "label" : "comedero3",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21122955934647059
                }, {
                  "name" : "pressure",
                  "type" : "timeseries",
                  "label" : "pressure",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6357233440039781
                }, {
                  "name" : "nivelNapa",
                  "type" : "timeseries",
                  "label" : "nivelNapa",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5158796826873344
                }, {
                  "name" : "waterVolume",
                  "type" : "timeseries",
                  "label" : "waterVolume",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8649181166822368
                }, {
                  "name" : "waterLevelPerc",
                  "type" : "timeseries",
                  "label" : "waterLevelPerc",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8782297497321601
                }, {
                  "name" : "data_temperature_2",
                  "type" : "timeseries",
                  "label" : "data_temperature_2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7747460584745568
                } ],
                "label" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "${entityName}",
                  "patternFunction" : "\nvar color;\nif(data.active !== \"true\"){\n    color = 'rgb(255, 0, 0)';\n} else {\n    color = 'rgb(39, 134, 34)';\n}\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \n           '${entityLabel}' + \n        '</span>'"
                },
                "tooltip" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Temperature:</b> ${temperature:1} Â°C<br/><b>Humidity:</b> ${humidity:0} %<br/><br/><link-act name=\"navigate_to_details\">Detalles</link-act><br/>",
                  "patternFunction" : "var deviceType = data.Tipo;\r\n\r\nfunction buildRow(label, value) {\r\n    return `\r\n        <div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">\r\n            <div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:120px\">${label}</div>\r\n            <div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px;color:#29313C\">${value}</div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nif (typeof deviceType !== 'undefined') {\r\n    let content = `\r\n    <div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:'Roboto';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">\r\n        <div>${data.entityLabel ?? 'Sin nombre'}</div>\r\n        <div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>\r\n    `;\r\n\r\n    if (deviceType === \"lanza\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`);\r\n    } else if (deviceType === \"estMeteo\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Viento\", `${data.windSpeed?.toFixed(1) ?? 'N/A'} m/s`) +\r\n            buildRow(\"DirecciÃ³n\", `${data.windDir?.toFixed(0) ?? 'N/A'}Â°`) +\r\n            buildRow(\"Lluvia\", `${data.rain?.toFixed(1) ?? 'N/A'} mm`) +\r\n            buildRow(\"PresiÃ³n\", `${data.pressure?.toFixed(1) ?? 'N/A'} hPa`);\r\n    } else if (deviceType === \"pozo\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Aguada\", `${data.nivelAguada?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Nivel de Tanque\", `${data.nivelTanque?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Pozo\", estadoPozo);\r\n    } else if (deviceType === \"Ultrasonico\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Tanque\", `${data.waterLevelPerc?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Volumen de Tanque\", `${data.waterVolume?.toFixed(0) ?? 'N/A'} L`) +\r\n            buildRow(\"Temperatura\", `${data.data_temperature_2?.toFixed(1) ?? 'N/A'} Â°C`)\r\n    } else if (deviceType === \"Freatimetro\") {\r\n        content +=\r\n            buildRow(\"Nivel Napa\", `${data.nivelNapa?.toFixed(1) ?? 'N/A'} m`);\r\n    } else if (deviceType === \"comedero\") {\r\n        content +=\r\n            buildRow(\"Comedero 1\", `${data.comedero1?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 2\", `${data.comedero2?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 3\", `${data.comedero3?.toFixed(0) ?? 'N/A'} %`);\r\n    } else {\r\n        content += buildRow(\"Tipo\", \"Desconocido\");\r\n    }\r\n\r\n    content += `\r\n    <div style=\"text-align:center; margin-top:16px;\">\r\n        <link-act name=\"navigate_to_details\">Detalles</link-act>\r\n    </div>\r\n</div>`;\r\n\r\n\r\n\r\n    return content;\r\n}\r\n\r\nreturn `<b>${data.entityName ?? 'Dispositivo'}</b><br/>Tipo desconocido<br/>`;\r\n",
                  "trigger" : "click",
                  "autoclose" : true,
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "tagActions" : [ {
                    "name" : "navigate_to_details",
                    "type" : "custom",
                    "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.updateState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                    "openInSeparateDialog" : false,
                    "openInPopover" : false
                  } ]
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "sensors",
                  "size" : 48,
                  "color" : {
                    "type" : "function",
                    "color" : "rgb(255, 0, 0)",
                    "range" : null,
                    "colorFunction" : "if (data.active !== \"true\"){\n   return 'rgb(255, 0, 0)';\n} else {\n   return 'rgb(39, 134, 34)';\n}"
                  }
                },
                "markerImage" : {
                  "type" : "function",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34,
                  "imageFunction" : "return {};",
                  "images" : [ ]
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : true,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : true,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              } ],
              "polygons" : [ ],
              "circles" : [ ],
              "additionalDataSources" : [ ],
              "controlsPosition" : "topleft",
              "zoomActions" : [ "scroll", "doubleClick", "controlButtons" ],
              "scales" : [ "metric" ],
              "dragModeButton" : false,
              "fitMapBounds" : true,
              "useDefaultCenterPosition" : false,
              "defaultCenterPosition" : "0,0",
              "defaultZoomLevel" : 14,
              "mapPageSize" : 16384,
              "mapActionButtons" : [ ],
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "0"
            },
            "title" : "Map",
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "/* Oculta la barra de attribution */\r\n.leaflet-control-attribution { \r\n  display: none !important; \r\n}\r\n\r\n/* Por si tu tema pone contenedores extra */\r\n.leaflet-bottom.leaflet-right .leaflet-control-attribution {\r\n  display: none !important;\r\n}\r\n",
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "configMode" : "advanced",
            "titleFont" : null,
            "titleColor" : null,
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px",
            "titleIcon" : "map",
            "iconColor" : "#1F6BDD",
            "actions" : {
              "headerButton" : [ {
                "name" : "Editar ubicaciones",
                "buttonType" : "miniFab",
                "icon" : "edit",
                "buttonColor" : "#ffffff",
                "buttonFillColor" : "#305680",
                "customButtonStyle" : { },
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "openDashboardState",
                "targetDashboardStateId" : "edit_location_all",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "dialogTitle" : "",
                "dialogHideDashboardToolbar" : true,
                "dialogWidth" : null,
                "dialogHeight" : null,
                "openInSeparateDialog" : true,
                "openInPopover" : false,
                "id" : "5495e891-66e1-e6c8-4928-d5a1bd66a60f"
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "27f9305b-910e-3990-03b3-13f904b50700"
        },
        "15c2dc8b-53bd-2250-0ad0-a90b99dc08cb" : {
          "typeFullFqn" : "system.map",
          "type" : "latest",
          "sizeX" : 8.5,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1741884755143,
                  "endTimeMs" : 1741971155143
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "mapType" : "geoMap",
              "layers" : [ {
                "label" : "{i18n:widgets.maps.layer.hybrid}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery",
                "referenceLayer" : "openstreetmap_hybrid"
              }, {
                "label" : "{i18n:widgets.maps.layer.satellite}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery"
              }, {
                "label" : "{i18n:widgets.maps.layer.roadmap}",
                "provider" : "openstreet",
                "layerType" : "OpenStreetMap.Mapnik"
              } ],
              "imageSource" : null,
              "markers" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : [ {
                  "name" : "temperature",
                  "type" : "timeseries",
                  "label" : "temperature",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.570889787682481,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "humidity",
                  "type" : "timeseries",
                  "label" : "humidity",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13597394595782442,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "active",
                  "type" : "attribute",
                  "label" : "active",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21080919932756603
                }, {
                  "name" : "type",
                  "type" : "entityField",
                  "label" : "Tipo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.1357587191053956
                }, {
                  "name" : "pozo",
                  "type" : "timeseries",
                  "label" : "pozo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6817815369277647,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : false,
                  "postFuncBody" : null
                }, {
                  "name" : "nivelAguada",
                  "type" : "timeseries",
                  "label" : "nivelAguada",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.41051360922605606,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "nivelTanque",
                  "type" : "timeseries",
                  "label" : "nivelTanque",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.10653271737889158,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "windDir",
                  "type" : "timeseries",
                  "label" : "windDir",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7494149641343646
                }, {
                  "name" : "windSpeed",
                  "type" : "timeseries",
                  "label" : "windSpeed",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6909522833646339
                }, {
                  "name" : "rain",
                  "type" : "timeseries",
                  "label" : "rain",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.3165646978758382
                }, {
                  "name" : "comedero1",
                  "type" : "timeseries",
                  "label" : "comedero1",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5447639875242816
                }, {
                  "name" : "comedero2",
                  "type" : "timeseries",
                  "label" : "comedero2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13120470438313603
                }, {
                  "name" : "comedero3",
                  "type" : "timeseries",
                  "label" : "comedero3",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21122955934647059
                }, {
                  "name" : "pressure",
                  "type" : "timeseries",
                  "label" : "pressure",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6357233440039781
                }, {
                  "name" : "nivelNapa",
                  "type" : "timeseries",
                  "label" : "nivelNapa",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5158796826873344
                }, {
                  "name" : "waterVolume",
                  "type" : "timeseries",
                  "label" : "waterVolume",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8649181166822368
                }, {
                  "name" : "waterLevelPerc",
                  "type" : "timeseries",
                  "label" : "waterLevelPerc",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8782297497321601
                }, {
                  "name" : "data_temperature_2",
                  "type" : "timeseries",
                  "label" : "data_temperature_2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7747460584745568
                } ],
                "label" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "${entityName}",
                  "patternFunction" : "\nvar color;\nif(data.active !== \"true\"){\n    color = 'rgb(255, 0, 0)';\n} else {\n    color = 'rgb(39, 134, 34)';\n}\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \n           '${entityLabel}' + \n        '</span>'"
                },
                "tooltip" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Temperature:</b> ${temperature:1} Â°C<br/><b>Humidity:</b> ${humidity:0} %<br/><br/><link-act name=\"navigate_to_details\">Detalles</link-act><br/>",
                  "patternFunction" : "var deviceType = data.Tipo;\r\n\r\nfunction buildRow(label, value) {\r\n    return `\r\n        <div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">\r\n            <div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:120px\">${label}</div>\r\n            <div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px;color:#29313C\">${value}</div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nif (typeof deviceType !== 'undefined') {\r\n    let content = `\r\n    <div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:'Roboto';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">\r\n        <div>${data.entityLabel ?? 'Sin nombre'}</div>\r\n        <div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>\r\n    `;\r\n\r\n    if (deviceType === \"lanza\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`);\r\n    } else if (deviceType === \"estMeteo\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Viento\", `${data.windSpeed?.toFixed(1) ?? 'N/A'} m/s`) +\r\n            buildRow(\"DirecciÃ³n\", `${data.windDir?.toFixed(0) ?? 'N/A'}Â°`) +\r\n            buildRow(\"Lluvia\", `${data.rain?.toFixed(1) ?? 'N/A'} mm`) +\r\n            buildRow(\"PresiÃ³n\", `${data.pressure?.toFixed(1) ?? 'N/A'} hPa`);\r\n    } else if (deviceType === \"pozo\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Aguada\", `${data.nivelAguada?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Nivel de Tanque\", `${data.nivelTanque?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Pozo\", estadoPozo);\r\n    } else if (deviceType === \"Ultrasonico\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Tanque\", `${data.waterLevelPerc?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Volumen de Tanque\", `${data.waterVolume?.toFixed(0) ?? 'N/A'} L`) +\r\n            buildRow(\"Temperatura\", `${data.data_temperature_2?.toFixed(1) ?? 'N/A'} Â°C`)\r\n    } else if (deviceType === \"Freatimetro\") {\r\n        content +=\r\n            buildRow(\"Nivel Napa\", `${data.nivelNapa?.toFixed(1) ?? 'N/A'} m`);\r\n    } else if (deviceType === \"comedero\") {\r\n        content +=\r\n            buildRow(\"Comedero 1\", `${data.comedero1?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 2\", `${data.comedero2?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 3\", `${data.comedero3?.toFixed(0) ?? 'N/A'} %`);\r\n    } else {\r\n        content += buildRow(\"Tipo\", \"Desconocido\");\r\n    }\r\n\r\n    content += `\r\n    <div style=\"text-align:center; margin-top:16px;\">\r\n        <link-act name=\"navigate_to_details\">Detalles</link-act>\r\n    </div>\r\n</div>`;\r\n\r\n\r\n\r\n    return content;\r\n}\r\n\r\nreturn `<b>${data.entityName ?? 'Dispositivo'}</b><br/>Tipo desconocido<br/>`;\r\n",
                  "trigger" : "click",
                  "autoclose" : true,
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "tagActions" : [ {
                    "name" : "navigate_to_details",
                    "type" : "custom",
                    "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.updateState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                    "openInSeparateDialog" : false,
                    "openInPopover" : false
                  } ]
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "sensors",
                  "size" : 48,
                  "color" : {
                    "type" : "function",
                    "color" : "rgb(255, 0, 0)",
                    "range" : null,
                    "colorFunction" : "if (data.active !== \"true\"){\n   return 'rgb(255, 0, 0)';\n} else {\n   return 'rgb(39, 134, 34)';\n}"
                  }
                },
                "markerImage" : {
                  "type" : "function",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34,
                  "imageFunction" : "return {};",
                  "images" : [ ]
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : true,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : true,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              } ],
              "polygons" : [ ],
              "circles" : [ ],
              "additionalDataSources" : [ ],
              "controlsPosition" : "topleft",
              "zoomActions" : [ "scroll", "doubleClick", "controlButtons" ],
              "scales" : [ "metric" ],
              "dragModeButton" : false,
              "fitMapBounds" : true,
              "useDefaultCenterPosition" : false,
              "defaultCenterPosition" : "0,0",
              "defaultZoomLevel" : 14,
              "mapPageSize" : 16384,
              "mapActionButtons" : [ ],
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "0"
            },
            "title" : "Map",
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "dropShadow" : true,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "/* Oculta la barra de attribution */\r\n.leaflet-control-attribution { \r\n  display: none !important; \r\n}\r\n\r\n/* Por si tu tema pone contenedores extra */\r\n.leaflet-bottom.leaflet-right .leaflet-control-attribution {\r\n  display: none !important;\r\n}\r\n",
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "configMode" : "advanced",
            "titleFont" : null,
            "titleColor" : null,
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px",
            "titleIcon" : "map",
            "iconColor" : "#1F6BDD",
            "actions" : {
              "headerButton" : [ {
                "name" : "Editar ubicaciones",
                "buttonType" : "miniFab",
                "icon" : "edit",
                "buttonColor" : "#ffffff",
                "buttonFillColor" : "#305680",
                "customButtonStyle" : { },
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "openDashboardState",
                "targetDashboardStateId" : "edit_location_all",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "dialogTitle" : "",
                "dialogHideDashboardToolbar" : true,
                "dialogWidth" : null,
                "dialogHeight" : null,
                "openInSeparateDialog" : true,
                "openInPopover" : false,
                "id" : "5495e891-66e1-e6c8-4928-d5a1bd66a60f"
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "15c2dc8b-53bd-2250-0ad0-a90b99dc08cb"
        },
        "26dcfa07-d55f-8108-1c8c-11d53dbc3cdf" : {
          "typeFullFqn" : "system.cards.markdown_card",
          "type" : "latest",
          "sizeX" : 5,
          "sizeY" : 3.5,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "e2c3a2c3-e8dc-e950-2715-6bf0c6bf0d57",
              "dataKeys" : [ {
                "name" : "title",
                "type" : "entityField",
                "label" : "Title",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.23278673876621192
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1724146213845,
                  "endTimeMs" : 1724232613845
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#FFFFFF",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "",
            "settings" : {
              "useMarkdownTextFunction" : false,
              "markdownTextPattern" : "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Sidebar Menu</title>\r\n    <link href=\"https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap\" rel=\"stylesheet\">\r\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css\">\r\n</head>\r\n\r\n<body>\r\n    <div class=\"logo-container\">\r\n        <img src=\"/api/images/public/eccgkajobndCxIy5sq6CzrRsqVljRfM\" alt=\"Logo\" class=\"logo\">\r\n    </div>\r\n    <div id=\"customerTitle\" style=\"display:none;\" >${entityName}</div>\r\n    <div class=\"sidebar\">\r\n        <a class=\"menu-item\" id=\"liveApp\">\r\n            <i class=\"fa-solid fa-map\"></i> Mapa\r\n        </a>\r\n        <div class=\"menu-item\" id=\"Devices\">\r\n            <i class=\"fas fa-wifi\"></i> Dispositivos\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Reports\" data-action=\"click\">\r\n            <i class=\"fas fa-book\"></i> Reports\r\n            <i class=\"fas fa-chevron-down\" id=\"reportsArrow\" style=\"margin-left:auto;\"></i>\r\n        </div>\r\n        <div class=\"submenu\" id=\"reportsSubmenu\">\r\n            <a id=\"WaterReport\"><i class=\"fa-solid fa-droplet\"></i>Water Salinity Reports</a>\r\n            <a id=\"EnergyReport\"><i class=\"fa-solid fa-bolt\"></i>Energy Reports</a>\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Automated\">\r\n            <i class=\"fa-solid fa-file\"></i> Automated Reports\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Alerts\">\r\n            <i class=\"fas fa-bell\"></i> Alertas\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Settings\">\r\n            <i class=\"fas fa-gear\"></i> Ajustes\r\n        </div>\r\n        <div class=\"menu-item\" id=\"Contact\">\r\n            <i class=\"fas fa-question-circle\"></i> Contacto\r\n        </div>\r\n    </div>\r\n</body>\r\n</html>\r\n",
              "markdownTextFunction" : "// === Mapeo itemId â stateId (AJUSTAR A TU DASHBOARD) ===\r\nconst stateMap = {\r\n  liveApp:     'default',\r\n  Devices:     'devices',\r\n  Reports:     null, // solo expande submenÃº\r\n  WaterReport: 'water_report_state',\r\n  EnergyReport:'energy_report_state',\r\n  Automated:   'automated_reports_state',\r\n  Alerts:      'alarms',\r\n  Contact:     'contact_state'\r\n};\r\n\r\n// ID Ãºnico para este render (evita choques si hay varios widgets)\r\nconst uid = 'sb_' + Math.random().toString(36).slice(2);\r\n\r\n// HTML (sin <script> y sin href que cambie la URL)\r\nconst html =\r\n  '<div id=\"'+uid+'\" class=\"sidebar\">' +\r\n\r\n    '<a class=\"menu-item\" data-item=\"liveApp\">' +\r\n      '<i class=\"fa-solid fa-map\"></i> Mapa' +\r\n    '</a>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Devices\">' +\r\n      '<i class=\"fas fa-wifi\"></i> Devices' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Reports\" data-expand=\"reportsSubmenu\">' +\r\n      '<i class=\"fas fa-book\"></i> Reports' +\r\n      '<i class=\"fas fa-chevron-down\" style=\"margin-left:auto;\"></i>' +\r\n    '</div>' +\r\n\r\n    '<div class=\"submenu\" id=\"reportsSubmenu\">' +\r\n      '<a data-item=\"WaterReport\"><i class=\"fa-solid fa-droplet\"></i> Water Salinity Reports</a>' +\r\n      '<a data-item=\"EnergyReport\"><i class=\"fa-solid fa-bolt\"></i> Energy Reports</a>' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Automated\">' +\r\n      '<i class=\"fa-solid fa-file\"></i> Automated Reports' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Alerts\">' +\r\n      '<i class=\"fas fa-bell\"></i> Alerts' +\r\n    '</div>' +\r\n\r\n    '<div class=\"menu-item\" data-item=\"Contact\">' +\r\n      '<i class=\"fas fa-question-circle\"></i> Contact' +\r\n    '</div>' +\r\n\r\n  '</div>';\r\n\r\n// Bind de eventos despuÃ©s de que TB inserta el HTML\r\nsetTimeout(function () {\r\n  const root = document.getElementById(uid);\r\n  if (!root || root.__bound) return;\r\n  root.__bound = true;\r\n\r\n  const submenu = root.querySelector('#reportsSubmenu');\r\n\r\n  function clearActive() {\r\n    root.querySelectorAll('.active').forEach(n => {\r\n      n.classList.remove('active');\r\n      n.setAttribute('aria-disabled', 'false');\r\n    });\r\n  }\r\n  function setActive(el) {\r\n    clearActive();\r\n    el.classList.add('active');\r\n    el.setAttribute('aria-disabled', 'true');\r\n  }\r\n  function openStateFor(itemId) {\r\n    const stateId = stateMap[itemId];\r\n    if (!stateId) return; // p.ej. Reports\r\n    try {\r\n      // usa ctx del scope de la funciÃ³n de valor\r\n      if (ctx && ctx.stateController && typeof ctx.stateController.openState === 'function') {\r\n        ctx.stateController.openState(stateId);\r\n        return;\r\n      }\r\n      if (ctx && ctx.actionsApi && typeof ctx.actionsApi.openDashboard === 'function') {\r\n        ctx.actionsApi.openDashboard(null, { stateId }, { openInDialog: false });\r\n      }\r\n    } catch (e) { /* silencioso */ }\r\n  }\r\n\r\n  // DelegaciÃ³n de clicks (sin cambiar la URL)\r\n  root.addEventListener('click', function (e) {\r\n    const item = e.target.closest('[data-item]');\r\n    if (!item || !root.contains(item)) return;\r\n    const id = item.getAttribute('data-item');\r\n\r\n    // Toggle Reports (expansor)\r\n    if (id === 'Reports') {\r\n      e.preventDefault();\r\n      submenu && submenu.classList.toggle('open');\r\n      setActive(item);\r\n      return;\r\n    }\r\n\r\n    e.preventDefault();\r\n    setActive(item);\r\n    openStateFor(id);\r\n  });\r\n\r\n  // Activo inicial (opcional)\r\n  const initial = root.querySelector('[data-item=\"Devices\"]');\r\n  if (initial) {\r\n    setActive(initial);\r\n    // openStateFor('Devices'); // descomentÃ¡ si querÃ©s abrir al cargar\r\n  }\r\n}, 0);\r\n\r\n// devolver el HTML al widget\r\nreturn html;\r\n",
              "applyDefaultMarkdownStyle" : false,
              "markdownCss" : "/* Mantener oculto el logo */\r\n.logo-container { display:none !important; margin:0 !important; padding:0 !important; }\r\n\r\n/* Base */\r\nbody {\r\n    font-family: 'Roboto', sans-serif;\r\n    margin: 0;\r\n    padding: 0;\r\n    background-color: #fff;\r\n}\r\n\r\n/* (Tu bloque extra de logo no es necesario si estÃ¡ oculto) */\r\n/* .logo-container { ... }  â eliminado */\r\n\r\n/* .logo { ... } â innecesario si no se muestra el logo */\r\n/* .logo { width:auto; max-width:100%; } */\r\n\r\n.sidebar {\r\n    width: 100%;\r\n    height: 100vh;\r\n    background-color: #ffffff;\r\n    padding: 0;\r\n}\r\n\r\n/* Ãtems de menÃº */\r\n.menu-item, .submenu a {\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: flex-start;\r\n    height: 60px;              /* 50px en submenÃº abajo */\r\n    padding: 0 20px;\r\n    width: 100%;\r\n    color: #333;\r\n    text-decoration: none;\r\n    font-size: 16px;           /* 14px en submenÃº abajo */\r\n    cursor: pointer;\r\n    transition: background-color 0.3s ease, color .2s ease;\r\n    box-sizing: border-box;\r\n}\r\n\r\n.menu-item:hover,\r\n.submenu a:hover {\r\n    background-color: rgba(235, 235, 235, 0.5); /* 50% opacity */\r\n}\r\n\r\n.menu-item i,\r\n.submenu a i {\r\n    margin-right: 10px;\r\n}\r\n\r\n/* SubmenÃº */\r\n.submenu {\r\n    padding-left: 0;\r\n    display: none;             /* oculto por defecto */\r\n    user-select: none;\r\n    flex-direction: column;\r\n}\r\n\r\n.submenu a {\r\n    height: 50px;\r\n    font-size: 14px;\r\n    background-color: #eee;\r\n    transition: background-color 0.3s ease, color .2s ease;\r\n}\r\n\r\n.submenu a:hover {\r\n    background-color: rgba(235, 96, 96, 0.7); /* 70% opacity */\r\n}\r\n\r\n/* Flecha rotada cuando Reports estÃ¡ activo (si usÃ¡s el Ã­cono con ese id) */\r\n#Reports:target + #reportsSubmenu + .menu-item .fa-chevron-down,\r\n#Reports:target .fa-chevron-down {\r\n    transform: rotate(180deg);\r\n}\r\n\r\n/* Abrir submenÃº cuando \"Reports\" es el :target */\r\n#Reports:target + #reportsSubmenu {\r\n    display: flex;\r\n}\r\n\r\n/* Estado ACTIVO usando :target (hash) */\r\n.menu-item:target,\r\n.submenu a:target {\r\n    background: #1f6feb;\r\n    color: #fff;\r\n}\r\n\r\n/* Deshabilitado visual mientras estÃ¡ activo */\r\n.menu-item:target,\r\n.submenu a:target {\r\n    pointer-events: none;      /* no clickeable mientras activo */\r\n    cursor: default;\r\n}\r\n\r\n/* Borde superior en Contact (lo mantenemos) */\r\n#Settings{\r\n    border-top: solid #b8bfd4 1px;\r\n}\r\n"
            },
            "title" : "Markdown/HTML Card",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "actions" : {
              "elementClick" : [ {
                "name" : "liveApp",
                "icon" : "map",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "map_mobile",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "7ae4f14c-e248-b709-2194-e251d4fb4def"
              }, {
                "name" : "Devices",
                "icon" : "wifi",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "devices",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "d1499cfd-7409-e619-b835-ff1edac50622"
              }, {
                "name" : "Automated",
                "icon" : "description",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "Automated Reports",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "011cac58-e56e-b396-d969-94361e3d8f5a"
              }, {
                "name" : "Alerts",
                "icon" : "notifications",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "alarms",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "24e6e7a0-0adc-b860-7c12-6be7d528142e"
              }, {
                "name" : "Contact",
                "icon" : "help",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "openURL",
                "openNewBrowserTab" : true,
                "url" : "https://www.google.com",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "52b5652f-de35-1ce5-b83e-63bde7f86f51"
              }, {
                "name" : "Reports",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "// Arrays for categorizing customers\r\nvar OnlyWater = [\"Customer A\",];\r\nvar OnlyEnergy = [\"Customer B\", \"Customer C\"];\r\nvar AllReports = [\"Customer D\"];\r\n\r\n// Retrieve the customer_title from the hidden div\r\nvar customerTitle = widgetContext.$container.find('#customerTitle').text().trim();\r\n\r\n// Find the submenu elements\r\nvar waterReport = widgetContext.$container.find('#WaterReport');\r\nvar energyReport = widgetContext.$container.find('#EnergyReport');\r\n\r\n// Find the Reports submenu and arrow\r\nvar reportsSubmenu = widgetContext.$container.find('#reportsSubmenu');\r\nvar reportsArrow = widgetContext.$container.find('#reportsArrow');\r\n\r\n// Toggle the visibility of the submenu directly based on the current state\r\nif (reportsSubmenu.is(':visible')) {\r\n    reportsSubmenu.hide();\r\n    reportsArrow.removeClass('rotate');\r\n} else {\r\n    reportsSubmenu.show();\r\n    reportsArrow.addClass('rotate');\r\n}\r\n\r\n// Determine which report options to show based on the customer title\r\nif (OnlyWater.includes(customerTitle)) {\r\n    waterReport.show();\r\n    energyReport.hide();\r\n} else if (OnlyEnergy.includes(customerTitle)) {\r\n    waterReport.hide();\r\n    energyReport.show();\r\n} else if (AllReports.includes(customerTitle)) {\r\n    waterReport.show();\r\n    energyReport.show();\r\n} else {\r\n    // Default behavior: Show all reports if the customer is not listed in any array\r\n    waterReport.show();\r\n    energyReport.show();\r\n}\r\n",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "d5c95e9f-c076-8c41-6b8a-edd6a750070a"
              }, {
                "name" : "WaterReport",
                "icon" : "water_drop",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "reports",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "f9505310-c43c-e0e0-4706-497157b80574"
              }, {
                "name" : "EnergyReport",
                "icon" : "bolt",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "Energy Reports",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : true,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "7c95a652-62a4-f26e-3631-5477d63c6c3b"
              }, {
                "name" : "Settings",
                "icon" : "settings",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "updateDashboardState",
                "targetDashboardStateId" : "settings",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "e2df470d-2e7b-2607-6316-9159a05bc1fd"
              } ]
            },
            "enableDataExport" : false,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "margin" : "0px"
          },
          "row" : 0,
          "col" : 0,
          "id" : "26dcfa07-d55f-8108-1c8c-11d53dbc3cdf"
        },
        "91982601-2bfa-cc2d-da7b-be5d9cdf6f9d" : {
          "typeFullFqn" : "system.cards.html_card",
          "type" : "static",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "static",
              "name" : "function",
              "dataKeys" : [ {
                "name" : "f(x)",
                "type" : "function",
                "label" : "Random",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.15479322438769105,
                "funcBody" : "var value = prevValue + Math.random() * 100 - 50;\nvar multiplier = Math.pow(10, 2 || 0);\nvar value = Math.round(value * multiplier) / multiplier;\nif (value < -1000) {\n\tvalue = -1000;\n} else if (value > 1000) {\n\tvalue = 1000;\n}\nreturn value;"
              } ]
            } ],
            "timewindow" : {
              "realtime" : {
                "timewindowMs" : 60000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(255, 255, 255, 0.97)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0",
            "settings" : {
              "cardHtml" : "<!-- RaÃ­z opcional (no se usa para incrustar, la burbuja flota) -->\r\n<div id=\"n8n-chat-root\"></div>\r\n\r\n<script type=\"module\">\r\n  // --- CONFIG ---\r\n  const WEBHOOK_URL = 'https://backend.nexoragro.com/webhook/67044a01-2acb-4377-9a32-8c090b67939d/chat';\r\n  const CHAT_SESSION_KEY = 'sessionId'; // n8n espera \"sessionId\"\r\n\r\n  // --- Obtener userId de ThingsBoard (igual que tenÃ­as) ---\r\n  function getTbUserId() {\r\n    try {\r\n      const u = JSON.parse(localStorage.getItem('user') || 'null');\r\n      const idFromUser = u?.userId?.id || u?.user?.id?.id;\r\n      if (idFromUser) return idFromUser;\r\n\r\n      const tok =\r\n        localStorage.getItem('jwt_token') ||\r\n        localStorage.getItem('tb.auth_token') ||\r\n        localStorage.getItem('token');\r\n      if (tok) {\r\n        const base64 = (tok.split('.')[1] || '').replace(/-/g, '+').replace(/_/g, '/');\r\n        const payload = JSON.parse(atob(base64));\r\n        return payload.userId || payload.sub || null;\r\n      }\r\n    } catch (_) {}\r\n    return null;\r\n  }\r\n\r\n  // --- NUEVO: helpers mÃ­nimos para llamar a la API de TB con el JWT ya almacenado ---\r\n  function getJwt() {\r\n    return (\r\n      localStorage.getItem('jwt_token') ||\r\n      localStorage.getItem('tb.auth_token') ||\r\n      localStorage.getItem('token') ||\r\n      null\r\n    );\r\n  }\r\n  async function apiGet(path) {\r\n    const tok = getJwt();\r\n    if (!tok) throw new Error('No JWT');\r\n    const res = await fetch(location.origin.replace(/\\/+$/, '') + path, {\r\n      headers: {\r\n        'X-Authorization': 'Bearer ' + tok,\r\n        'Content-Type': 'application/json'\r\n      }\r\n    });\r\n    if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + path);\r\n    return res.json();\r\n  }\r\n\r\n  // --- NUEVO: obtener user name/email de /api/auth/user y customer name de /api/customer/{id} ---\r\n  async function getUserNameEmail() {\r\n    try {\r\n      const me = await apiGet('/api/auth/user'); // devuelve el usuario logueado\r\n      // Campos tÃ­picos: me.id.id, me.email, me.name (o firstName/lastName)\r\n      const id = me?.id?.id ?? null;\r\n      const email = me?.email ?? null;\r\n      const fullName = [\r\n        me?.firstName ?? '',\r\n        me?.lastName ?? ''\r\n      ].join(' ').trim();\r\n      const name = (fullName || me?.name || null) || null;\r\n      return { id, name, email };\r\n    } catch {\r\n      // Fallback a localStorage si falla\r\n      try {\r\n        const u = JSON.parse(localStorage.getItem('user') || 'null');\r\n        const id = u?.userId?.id || u?.user?.id?.id || null;\r\n        const email = u?.email ?? u?.user?.email ?? null;\r\n        const fullName = [\r\n          u?.firstName ?? u?.user?.firstName ?? '',\r\n          u?.lastName ?? u?.user?.lastName ?? ''\r\n        ].join(' ').trim();\r\n        const name = (fullName || u?.name || u?.user?.name || null) || null;\r\n        return { id, name, email };\r\n      } catch {\r\n        return { id: null, name: null, email: null };\r\n      }\r\n    }\r\n  }\r\n\r\n  async function getCustomerName(customerId) {\r\n    if (!customerId) return null;\r\n    try {\r\n      const c = await apiGet('/api/customer/' + customerId);\r\n      return c?.title || c?.name || null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // --- Mantengo tu helper de estilos tal cual ---\r\n  function injectStyle(css) {\r\n    const id = 'n8n-chat-custom-style';\r\n    if (document.getElementById(id)) return;\r\n    const s = document.createElement('style');\r\n    s.id = id;\r\n    s.textContent = css;\r\n    document.head.appendChild(s);\r\n  }\r\n\r\n  const userId = getTbUserId();\r\n  const sessionId = userId || 'anon';\r\n\r\n  // TambiÃ©n tomamos customerId de LS/JWT (como ya usabas antes)\r\n  function getCustomerId() {\r\n    try {\r\n      const u = JSON.parse(localStorage.getItem('user') || 'null');\r\n      const cid = u?.customerId?.id ?? u?.user?.customerId?.id ?? null;\r\n      if (cid) return cid;\r\n    } catch {}\r\n    try {\r\n      const tok = getJwt();\r\n      if (tok) {\r\n        const base64 = (tok.split('.')[1] || '').replace(/-/g, '+').replace(/_/g, '/');\r\n        const payload = JSON.parse(atob(base64));\r\n        return payload.customerId || null;\r\n      }\r\n    } catch {}\r\n    return null;\r\n  }\r\n  const customerId = getCustomerId();\r\n\r\n  // --- 1) Cargar CSS y esperar a que estÃ© listo (igual que tenÃ­as) ---\r\n  function loadCss(href) {\r\n    return new Promise((resolve, reject) => {\r\n      const id = 'n8n-chat-style';\r\n      if (document.getElementById(id)) return resolve();\r\n      const link = document.createElement('link');\r\n      link.id = id;\r\n      link.rel = 'stylesheet';\r\n      link.href = href + '?v=' + Date.now(); // cache-busting\r\n      link.onload = resolve;\r\n      link.onerror = reject;\r\n      document.head.appendChild(link);\r\n    });\r\n  }\r\n\r\n  // --- 2) Importar el mÃ³dulo y crear la burbuja ---\r\n  async function boot() {\r\n    await loadCss('https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css');\r\n\r\n    // Estilos personalizados (despuÃ©s del CSS oficial)\r\n    injectStyle(`\r\n      :root {\r\n        /* Colores (tu tema) */\r\n        --chat--color-primary: #0a2342;\r\n        --chat--color-primary-shade-50: #092037;\r\n        --chat--color-primary-shade-100: #071a2d;\r\n        --chat--color-secondary: #0a2342;\r\n\r\n        /* Header compacto */\r\n        --chat--header-height: auto;\r\n        --chat--header--padding: 0.6rem;\r\n        --chat--heading--font-size: clamp(1rem, 0.9rem + 0.6vw, 1.15rem);\r\n        --chat--subtitle--font-size: clamp(0.85rem, 0.8rem + 0.2vw, 0.95rem);\r\n        --chat--subtitle--line-height: 1.3;\r\n\r\n        /* TipografÃ­a de mensajes (clamp) */\r\n        --chat--message--font-size:  10px !important;\r\n        --chat--message-line-height: 1;\r\n\r\n        /* Ventana y toggle (responsive) */\r\n        --chat--window--width: min(80vw, 600px);\r\n        --chat--window--height: min(80vh, 620px);\r\n        --chat--toggle--size: clamp(56px, 12vw, 72px);\r\n\r\n        /* Input mÃ¡s bajo */\r\n        --chat--textarea--height: 44px;\r\n\r\n        /* Bordes suaves */\r\n        .n8n-chat, .n8n-chat * { font-size:1rem !important; line-height:1.35 !important; }\r\n        --chat--border-radius: 14px;\r\n\r\n        /* Header y burbuja usuario en azul marino */\r\n        --chat--header--background: var(--chat--color-primary);\r\n        --chat--header--color: #fff;\r\n        --chat--message--user--background: var(--chat--color-primary);\r\n        --chat--message--user--color: #fff;\r\n      }\r\n    `);\r\n\r\n    // >>> NUEVO: pedir datos frescos antes de crear el chat <<<\r\n    const [{ id: selfId, name: userName, email: userEmail }, customerName] = await Promise.all([\r\n      getUserNameEmail(),\r\n      getCustomerName(customerId)\r\n    ]);\r\n\r\n    // Import ESM oficial\r\n    const { createChat } = await import('https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js');\r\n\r\n    // Crear burbuja con metadata enriquecida (agregado lo que pediste)\r\n    createChat({\r\n      webhookUrl: WEBHOOK_URL,\r\n      chatSessionKey: CHAT_SESSION_KEY,\r\n      loadPreviousSession: true,\r\n      metadata: {\r\n        sessionId,\r\n        userId: userId || selfId || null,\r\n        user: {\r\n          id: userId || selfId || null,\r\n          name: userName || null,\r\n          email: userEmail || null\r\n        },\r\n        customer: {\r\n          id: customerId || null,\r\n          name: customerName || null\r\n        }\r\n      },\r\n\r\n      // UX mÃ­nima de burbuja\r\n      position: 'bottom-right',\r\n      launcherTitle: 'Asistente',\r\n      initialMessages: ['Hola ð Â¿en quÃ© te ayudo?'],\r\n      i18n: {\r\n        en: {\r\n          title: 'Asistente',\r\n          subtitle: \"\",\r\n          footer: '',\r\n          getStarted: '',\r\n          inputPlaceholder: 'EscribÃ­ tu consulta...',\r\n        },\r\n      },\r\n\r\n      // Theme (igual que antes)\r\n      theme: { primary: '#111827' }\r\n    });\r\n  }\r\n\r\n  boot().catch(err => {\r\n    console.error('n8n chat error:', err);\r\n    // Fallback visual mÃ­nimo por si CSP bloquea el CSS\r\n    const warn = document.createElement('div');\r\n    warn.style.cssText = 'position:fixed;bottom:12px;right:12px;padding:8px 12px;background:#111;color:#fff;border-radius:8px;font:14px/1.2 system-ui;';\r\n    warn.textContent = 'No se pudo cargar el CSS de @n8n/chat (revisar CSP).';\r\n    document.body.appendChild(warn);\r\n  });\r\n</script>\r\n",
              "cardCss" : ""
            },
            "title" : "HTML Card",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "91982601-2bfa-cc2d-da7b-be5d9cdf6f9d"
        },
        "e1883c9a-eddc-d5ea-d6c9-1d475c5e6e31" : {
          "typeFullFqn" : "system.cards.entities_table",
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 6.5,
          "config" : {
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 86400000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1749767094291,
                  "endTimeMs" : 1749853494291
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "NONE",
                "limit" : 200
              }
            },
            "showTitle" : true,
            "backgroundColor" : "rgb(255, 255, 255)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "4px",
            "settings" : {
              "entitiesTitle" : "Reportes",
              "enableSearch" : true,
              "enableSelectColumnDisplay" : true,
              "enableStickyHeader" : true,
              "enableStickyAction" : true,
              "showCellActionsMenu" : true,
              "reserveSpaceForHiddenAction" : "true",
              "displayEntityName" : false,
              "entityNameColumnTitle" : "",
              "displayEntityLabel" : false,
              "entityLabelColumnTitle" : "",
              "displayEntityType" : false,
              "displayPagination" : true,
              "defaultPageSize" : 10,
              "pageStepCount" : 3,
              "pageStepIncrement" : 10,
              "defaultSortOrder" : "name",
              "useRowStyleFunction" : false,
              "rowStyleFunction" : ""
            },
            "title" : "REPORTS",
            "dropShadow" : true,
            "enableFullscreen" : true,
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400,
              "padding" : "5px 10px 5px 10px"
            },
            "useDashboardTimewindow" : false,
            "showLegend" : false,
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "deviceId" : null,
              "entityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
              "filterId" : null,
              "dataKeys" : [ {
                "name" : "label",
                "type" : "entityField",
                "label" : "Nombre",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.9633712812704178,
                "aggregationType" : null,
                "units" : null,
                "decimals" : null,
                "funcBody" : null,
                "usePostProcessing" : null,
                "postFuncBody" : null
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "displayTimewindow" : false,
            "configMode" : "advanced",
            "actions" : {
              "actionCellButton" : [ {
                "name" : "report",
                "icon" : "mdi:file-chart",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "customPretty",
                "customHtml" : "<form #reportForm=\"ngForm\" [formGroup]=\"reportFormGroup\"\r\n      (ngSubmit)=\"generateReport()\" class=\"edit-entity-form\">\r\n\r\n  <mat-toolbar color=\"primary\">\r\n    <h2>Generar reporte CSV</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" [disabled]=\"(loading$ | async)\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <!-- Contenedor fijo para no mover layout -->\r\n  <div style=\"height: 4px;\">\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\"\r\n                      *ngIf=\"loading$ | async\"></mat-progress-bar>\r\n  </div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-form-field fxFlex class=\"mat-block\">\r\n      <mat-label>Fecha inicio</mat-label>\r\n      <input matInput [matDatepicker]=\"startPicker\" formControlName=\"startDate\" required>\r\n      <mat-datepicker-toggle matSuffix [for]=\"startPicker\"></mat-datepicker-toggle>\r\n      <mat-datepicker #startPicker></mat-datepicker>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field fxFlex class=\"mat-block\">\r\n      <mat-label>Fecha fin</mat-label>\r\n      <input matInput [matDatepicker]=\"endPicker\" formControlName=\"endDate\" required>\r\n      <mat-datepicker-toggle matSuffix [for]=\"endPicker\"></mat-datepicker-toggle>\r\n      <mat-datepicker #endPicker></mat-datepicker>\r\n    </mat-form-field>\r\n\r\n    <!-- Estado / Mensajes -->\r\n    <div style=\"min-height:24px;\">\r\n      <span *ngIf=\"status\" style=\"color:#d32f2f;\">{{status}}</span>\r\n      <span *ngIf=\"!status && success\" style=\"color:#2e7d32;\">\r\n        <mat-icon inline style=\"font-size:18px;vertical-align:middle;\">check_circle</mat-icon>\r\n        Reporte generado\r\n      </span>\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(loading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      Cancelar\r\n    </button>\r\n    <button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(loading$ | async) || reportForm.invalid\">\r\n      <span *ngIf=\"!(loading$ | async)\">Generar reporte</span>\r\n      <span *ngIf=\"loading$ | async\">Generandoâ¦</span>\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss" : ".edit-entity-form {\r\n    width: 320px;\r\n}",
                "customFunction" : "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nopenReportDialog();\r\n\r\nfunction openReportDialog() {\r\n  customDialog.customDialog(htmlTemplate, ReportDialogController).subscribe();\r\n}\r\n\r\n/* ============ Config ============ */\r\nconst BUCKET_MS = 60_000;   // agrupar por minuto\r\nconst KEY_BATCH_SIZE = 10;  // cuÃ¡ntas keys por request (evita URLs gigantes)\r\nconst PER_KEY_LIMIT = 200_000; // puntos mÃ¡ximos por key (sobra para 1 aÃ±o a 1/h)\r\n\r\n/* ============ Auth helpers ============ */\r\nfunction readLocalJwt() {\r\n  try {\r\n    for (const k of ['jwt_token','tb.auth_token','token']) {\r\n      const v = localStorage.getItem(k);\r\n      if (v && typeof v === 'string') return v.replace(/^Bearer\\s+/i,'');\r\n    }\r\n  } catch(_) {}\r\n  return null;\r\n}\r\nfunction isJwtExpired(jwt) {\r\n  try {\r\n    const p = JSON.parse(atob(jwt.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));\r\n    if (!p?.exp) return false;\r\n    return Math.floor(Date.now()/1000) >= p.exp;\r\n  } catch(_) { return false; }\r\n}\r\nasync function refreshJwtIfPossible() {\r\n  try {\r\n    const res = await fetch('/api/auth/token', { method:'POST', credentials:'include' });\r\n    if (!res.ok) return null;\r\n    const data = await res.json();\r\n    const t = data?.token || data?.jwtToken || null;\r\n    if (t) { try { localStorage.setItem('jwt_token', t); } catch(_) {} }\r\n    return t;\r\n  } catch(_) { return null; }\r\n}\r\nasync function getJwtToken() {\r\n  let t = readLocalJwt();\r\n  if (t && !isJwtExpired(t)) return t;\r\n  const r = await refreshJwtIfPossible();\r\n  return r || t || null;\r\n}\r\nasync function fetchWithAuth(url, options = {}) {\r\n  let jwt = await getJwtToken();\r\n  const headers = new Headers(options.headers || {});\r\n  if (jwt) headers.set('X-Authorization', 'Bearer ' + jwt);\r\n  headers.set('accept', headers.get('accept') || 'application/json');\r\n\r\n  let res = await fetch(url, { ...options, headers });\r\n  if (res.status === 401) {\r\n    const newJwt = await refreshJwtIfPossible();\r\n    if (newJwt) {\r\n      headers.set('X-Authorization', 'Bearer ' + newJwt);\r\n      res = await fetch(url, { ...options, headers });\r\n    }\r\n  }\r\n  console.log(jwt)\r\n  console.log(res)\r\n  return res;\r\n}\r\n\r\n/* ============ Device helpers ============ */\r\nfunction getDeviceId() {\r\n  try {\r\n    if (typeof entityId !== 'undefined' && entityId?.id) return entityId.id;\r\n    const a = widgetContext?.ctx?.stateController?.getEntityId?.();\r\n    if (a?.id) return a.id;\r\n    const b = widgetContext?.ctx?.defaultSubscription?.targetEntity?.id?.id;\r\n    if (b) return b;\r\n    const c = widgetContext?.ctx?.datasources?.[0]?.entity?.id?.id;\r\n    if (c) return c;\r\n  } catch(_) {}\r\n  return null;\r\n}\r\nasync function getDeviceLabelOrName(deviceId) {\r\n  try {\r\n    const res = await fetchWithAuth(`/api/device/${deviceId}`);\r\n    if (!res.ok) return 'dispositivo';\r\n    const dev = await res.json();\r\n    return (dev?.label && String(dev.label).trim()) || dev?.name || 'dispositivo';\r\n  } catch(_) { return 'dispositivo'; }\r\n}\r\n\r\n/* ============ Fechas ============ */\r\nfunction getDateString(v) {\r\n  if (typeof v === 'string') return v;\r\n  if (v instanceof Date) return v.toISOString().slice(0,10);\r\n  return '';\r\n}\r\nfunction normalizeDateString(input) {\r\n  if (!input) return '';\r\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(input)) return input; // YYYY-MM-DD\r\n  const m = String(input).match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/); // DD/MM/YYYY\r\n  if (m) return `${m[3]}-${m[2]}-${m[1]}`;\r\n  const d = new Date(input);\r\n  return isNaN(d) ? '' : d.toISOString().slice(0,10);\r\n}\r\nfunction toDDMMYYYY(iso) { // 'YYYY-MM-DD' -> 'dd-mm-aaaa'\r\n  const [y,m,d] = iso.split('-');\r\n  return `${d}-${m}-${y}`;\r\n}\r\nfunction pad2(n){ return String(n).padStart(2,'0'); }\r\nfunction fmtIsoLocalMinute(ts) { // 'YYYY-MM-DD HH:mm'\r\n  const d = new Date(ts);\r\n  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} `\r\n       + `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;\r\n}\r\n\r\n/* ============ visibleKeys SOLO SERVER_SCOPE ============ */\r\nasync function getServerVisibleKeys(deviceId) {\r\n  const url = `/api/plugins/telemetry/DEVICE/${deviceId}/values/attributes?serverKeys=visibleKeys`;\r\n  const res = await fetchWithAuth(url);\r\n  if (!res.ok) throw new Error('No se pudo leer visibleKeys (SERVER_SCOPE)');\r\n  const data = await res.json();\r\n\r\n  let items = [];\r\n  if (Array.isArray(data)) items = data;\r\n  else if (Array.isArray(data.server)) items = data.server;\r\n\r\n  const it = items.find(x => x?.key === 'visibleKeys' && x?.value);\r\n  if (!it) throw new Error('visibleKeys no existe en SERVER_SCOPE');\r\n  let vk = typeof it.value === 'string' ? JSON.parse(it.value) : it.value;\r\n  if (!vk || typeof vk !== 'object' || !Object.keys(vk).length) {\r\n    throw new Error('visibleKeys (SERVER_SCOPE) estÃ¡ vacÃ­o');\r\n  }\r\n\r\n  const keys = Object.keys(vk);\r\n  const meta = {};\r\n  keys.forEach(k => {\r\n    const o = vk[k] || {};\r\n    meta[k] = { label: o.label || k, unit: o.unit || '' };\r\n  });\r\n  return { keys, meta };\r\n}\r\n\r\n/* ============ Fetch Ãºnico por key (o lote), SIN interval ni agg ============ */\r\n/**\r\n * Devuelve series crudas dentro del rango, en lotes de keys, con limit alto.\r\n * { key1:[{ts,value},...], key2:[...], ... }\r\n */\r\nasync function fetchTimeseriesRaw(deviceId, keys, startTs, endTs, keyBatchSize = KEY_BATCH_SIZE, perKeyLimit = PER_KEY_LIMIT) {\r\n  const out = {};\r\n  keys.forEach(k => out[k] = []);\r\n\r\n  for (let i = 0; i < keys.length; i += keyBatchSize) {\r\n    const group = keys.slice(i, i + keyBatchSize);\r\n\r\n    const url = `/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries`\r\n      + `?keys=${encodeURIComponent(group.join(','))}`\r\n      + `&startTs=${startTs}&endTs=${endTs}`\r\n      + `&limit=${perKeyLimit}`   // trae TODO en un solo tiro por key\r\n      + `&useStrictDataTypes=false`;\r\n\r\n    const res = await fetchWithAuth(url);\r\n   \r\n    if (!res.ok) {\r\n      const txt = await res.text();\r\n      throw new Error(txt || `Error ${res.status} en Telemetry`);\r\n    }\r\n    const chunk = await res.json();\r\n\r\n    for (const k of group) {\r\n      const arr = Array.isArray(chunk?.[k]) ? chunk[k] : [];\r\n      if (arr.length) out[k] = out[k].concat(arr);\r\n    }\r\n  }\r\n\r\n  // ordenar por ts\r\n  for (const k of keys) out[k].sort((a,b)=>a.ts - b.ts);\r\n  return out;\r\n}\r\n\r\n/* ============ Bucket por minuto y CSV ============ */\r\nfunction bucketTsMin(ts) {\r\n  return Math.floor(ts / BUCKET_MS) * BUCKET_MS;\r\n}\r\n\r\nfunction buildCsvBucketed(seriesByKey, keys, meta) {\r\n  const headers = [\r\n    'fecha',\r\n    'hora',\r\n    'fecha hora', // YYYY-MM-DD HH:mm\r\n    ...keys.map(k => {\r\n      const {label, unit} = meta[k] || {label:k, unit:''};\r\n      return unit ? `${label} (${unit})` : label;\r\n    })\r\n  ];\r\n\r\n  // mapear Ãºltimo valor por minuto\r\n  const maps = {};\r\n  const bucketSet = new Set();\r\n\r\n  for (const k of keys) {\r\n    const m = new Map();\r\n    for (const p of (seriesByKey[k] || [])) {\r\n      const b = bucketTsMin(p.ts);\r\n      m.set(b, p.value);      // queda el Ãºltimo del minuto\r\n      bucketSet.add(b);\r\n    }\r\n    maps[k] = m;\r\n  }\r\n\r\n  const buckets = Array.from(bucketSet).sort((a,b)=>a-b);\r\n\r\n  let csv = headers.join(',') + '\\n';\r\n  for (const b of buckets) {\r\n    const d = new Date(b);\r\n    const fecha = d.toLocaleDateString();\r\n    const hora  = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; // estable para grÃ¡ficos\r\n    const fh    = fmtIsoLocalMinute(b);\r\n    const row = [\r\n      fecha,\r\n      hora,\r\n      fh,\r\n      ...keys.map(k => maps[k].has(b) ? maps[k].get(b) : '')\r\n    ];\r\n    csv += row.join(',') + '\\n';\r\n  }\r\n  return csv;\r\n}\r\n\r\n/* ============ Dialog Controller ============ */\r\nfunction ReportDialogController(instance) {\r\n  const vm = instance;\r\n\r\n  // Loading reactivo y flags de UI\r\n  vm.loading$ = new widgetContext.rxjs.BehaviorSubject(false);\r\n  vm.status = '';\r\n  vm.success = false;\r\n\r\n  vm.reportFormGroup = vm.fb.group({\r\n    startDate: [null, vm.validators.required],\r\n    endDate:   [null, vm.validators.required]\r\n  });\r\n\r\n  vm.cancel = () => vm.dialogRef.close(null);\r\n\r\n  vm.generateReport = async function () {\r\n    vm.status = '';\r\n    vm.success = false;\r\n    vm.loading$.next(true);\r\n\r\n    try {\r\n      if (vm.reportFormGroup.invalid) {\r\n        vm.status = 'Selecciona ambas fechas.';\r\n        return;\r\n      }\r\n\r\n      // === Fechas ===\r\n      const startRaw  = vm.reportFormGroup.get('startDate').value;\r\n      const endRaw    = vm.reportFormGroup.get('endDate').value;\r\n      const startDate = getDateString(startRaw) || normalizeDateString(String(startRaw||''));\r\n      const endDate   = getDateString(endRaw)   || normalizeDateString(String(endRaw||''));\r\n      if (!startDate || !endDate) {\r\n        vm.status = 'Selecciona ambas fechas.';\r\n        return;\r\n      }\r\n      const startTs = new Date(`${startDate}T00:00:00`).getTime();\r\n      const endTs   = new Date(`${endDate}T23:59:59`).getTime();\r\n      if (isNaN(startTs) || isNaN(endTs)) {\r\n        vm.status = 'Formato de fecha invÃ¡lido.';\r\n        return;\r\n      }\r\n\r\n      // === Device & visibleKeys (SERVER_SCOPE) ===\r\n      const deviceId    = getDeviceId();\r\n      if (!deviceId) { vm.status = 'No se pudo resolver el Device ID.'; return; }\r\n      const deviceLabel = await getDeviceLabelOrName(deviceId);\r\n      const { keys, meta } = await getServerVisibleKeys(deviceId);\r\n\r\n      // === TelemetrÃ­a cruda en lotes (rÃ¡pido) ===\r\n      const seriesByKey = await fetchTimeseriesRaw(deviceId, keys, startTs, endTs, KEY_BATCH_SIZE, PER_KEY_LIMIT);\r\n      const hasAny = keys.some(k => (seriesByKey[k]||[]).length > 0);\r\n      if (!hasAny) { vm.status = 'No hay datos en ese rango.'; return; }\r\n\r\n      // === CSV bucketizado por minuto + columna \"fecha hora\" ===\r\n      const csvCore = buildCsvBucketed(seriesByKey, keys, meta);\r\n\r\n      // === Blob y nombre de archivo (Â¡definidos acÃ¡!)\r\n      const BOM = '\\uFEFF';\r\n      const blob = new Blob([BOM + csvCore], { type: 'text/csv;charset=utf-8' });\r\n      const prettyStart = toDDMMYYYY(startDate); // dd-mm-aaaa\r\n      const prettyEnd   = toDDMMYYYY(endDate);\r\n      const safeLabel   = String(deviceLabel).trim().replace(/[^\\w\\s\\-\\.]/g, '').replace(/\\s+/g,'_');\r\n      const fileName    = `${safeLabel}_reporte_${prettyStart}_a_${prettyEnd}.csv`;\r\n\r\n      // === Apagar loading ANTES del click, mostrar Ã©xito y refrescar UI ===\r\n      vm.loading$.next(false);\r\n      vm.success = true;\r\n      instance.$scope?.$applyAsync?.();\r\n      await Promise.resolve(); // yieldea 1 tick para que Angular pinte\r\n\r\n      // === Disparar descarga ===\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = fileName;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n\r\n      // Limpieza y cierre (deja que el click salga primero)\r\n      setTimeout(() => {\r\n        try { URL.revokeObjectURL(url); } catch(_) {}\r\n        try { document.body.removeChild(a); } catch(_) {}\r\n        // cerrar el diÃ¡logo automÃ¡ticamente\r\n        vm.dialogRef.close({ ok: true, fileName });\r\n      }, 2000);\r\n\r\n    } catch (err) {\r\n      vm.status = 'Error: ' + (err?.message || err);\r\n    } finally {\r\n      // asegurar que quede apagado si hubo early return con error\r\n      if (vm.loading$.getValue()) vm.loading$.next(false);\r\n      instance.$scope?.$applyAsync?.();\r\n    }\r\n  };\r\n}\r\n\r\n",
                "customResources" : [ ],
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "86a773a5-ea0f-f7dc-507c-e2414fb6065c"
              } ]
            },
            "showTitleIcon" : false,
            "titleIcon" : "list",
            "iconColor" : null,
            "titleFont" : null,
            "titleColor" : null,
            "titleTooltip" : "",
            "widgetStyle" : { },
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "e1883c9a-eddc-d5ea-d6c9-1d475c5e6e31"
        },
        "f91fe7ad-f793-d95d-ffec-adb94336d21d" : {
          "typeFullFqn" : "system.cards.html_card",
          "type" : "static",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "static",
              "name" : "function",
              "dataKeys" : [ {
                "name" : "f(x)",
                "type" : "function",
                "label" : "Random",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.15479322438769105,
                "funcBody" : "var value = prevValue + Math.random() * 100 - 50;\nvar multiplier = Math.pow(10, 2 || 0);\nvar value = Math.round(value * multiplier) / multiplier;\nif (value < -1000) {\n\tvalue = -1000;\n} else if (value > 1000) {\n\tvalue = 1000;\n}\nreturn value;"
              } ]
            } ],
            "timewindow" : {
              "realtime" : {
                "timewindowMs" : 60000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(255, 255, 255, 0.97)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0",
            "settings" : {
              "cardHtml" : "CHATBOT\r\n<!-- RaÃ­z opcional (no se usa para incrustar, la burbuja flota) -->\r\n<div id=\"n8n-chat-root\"></div>\r\n\r\n<script type=\"module\">\r\n  // --- CONFIG ---\r\n  const WEBHOOK_URL = 'https://backend.nexoragro.com/webhook/67044a01-2acb-4377-9a32-8c090b67939d/chat';\r\n  const CHAT_SESSION_KEY = 'sessionId'; // n8n espera \"sessionId\"\r\n\r\n  // --- Obtener userId de ThingsBoard ---\r\n  function getTbUserId() {\r\n    try {\r\n      const u = JSON.parse(localStorage.getItem('user') || 'null');\r\n      const idFromUser = u?.userId?.id || u?.user?.id?.id;\r\n      if (idFromUser) return idFromUser;\r\n\r\n      const tok =\r\n        localStorage.getItem('jwt_token') ||\r\n        localStorage.getItem('tb.auth_token') ||\r\n        localStorage.getItem('token');\r\n      if (tok) {\r\n        const base64 = (tok.split('.')[1] || '').replace(/-/g, '+').replace(/_/g, '/');\r\n        const payload = JSON.parse(atob(base64));\r\n        return payload.userId || payload.sub || null;\r\n      }\r\n    } catch (_) {}\r\n    return null;\r\n  }\r\n  \r\n  \r\nfunction injectStyle(css) {\r\n  const id = 'n8n-chat-custom-style';\r\n  if (document.getElementById(id)) return;\r\n  const s = document.createElement('style');\r\n  s.id = id;\r\n  s.textContent = css;\r\n  document.head.appendChild(s);\r\n}\r\n\r\n  const sessionId = getTbUserId() || 'anon';\r\n\r\n  // --- 1) Cargar CSS y esperar a que estÃ© listo ---\r\n  function loadCss(href) {\r\n    return new Promise((resolve, reject) => {\r\n      const id = 'n8n-chat-style';\r\n      if (document.getElementById(id)) return resolve();\r\n      const link = document.createElement('link');\r\n      link.id = id;\r\n      link.rel = 'stylesheet';\r\n      link.href = href + '?v=' + Date.now(); // cache-busting\r\n      link.onload = resolve;\r\n      link.onerror = reject;\r\n      document.head.appendChild(link);\r\n    });\r\n  }\r\n\r\n  // --- 2) Importar el mÃ³dulo y crear la burbuja ---\r\n  async function boot() {\r\n    // Asegurar estilos cargados (evita el \"texto pelado\")\r\n    await loadCss('https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css');\r\n\r\n\r\n// Estilos personalizados (despuÃ©s del CSS oficial)\r\n\r\ninjectStyle(`\r\n  :root {\r\n    /* Colores (tu tema) */\r\n    --chat--color-primary: #0a2342;\r\n    --chat--color-primary-shade-50: #092037;\r\n    --chat--color-primary-shade-100: #071a2d;\r\n    --chat--color-secondary: #0a2342;\r\n\r\n    /* Header compacto */\r\n    --chat--header-height: auto;\r\n    --chat--header--padding: 0.6rem;\r\n    --chat--heading--font-size: clamp(1rem, 0.9rem + 0.6vw, 1.15rem);\r\n    --chat--subtitle--font-size: clamp(0.85rem, 0.8rem + 0.2vw, 0.95rem);\r\n    --chat--subtitle--line-height: 1.3;\r\n\r\n    /* TipografÃ­a de mensajes (clamp) */\r\n    --chat--message--font-size:  10px !important;\r\n    --chat--message-line-height: 1;\r\n\r\n    /* Ventana y toggle (responsive) */\r\n    --chat--window--width: min(80vw, 600px);\r\n    --chat--window--height: min(80vh, 620px);\r\n    --chat--toggle--size: clamp(56px, 12vw, 72px);\r\n\r\n    /* Input mÃ¡s bajo */\r\n    --chat--textarea--height: 44px;\r\n\r\n    /* Bordes suaves */\r\n    .n8n-chat, .n8n-chat * { font-size:1rem !important; line-height:1.35 !important; }\r\n    --chat--border-radius: 14px;\r\n\r\n    /* Header y burbuja usuario en azul marino */\r\n    --chat--header--background: var(--chat--color-primary);\r\n    --chat--header--color: #fff;\r\n    --chat--message--user--background: var(--chat--color-primary);\r\n    --chat--message--user--color: #fff;\r\n  }\r\n`);\r\n\r\n\r\n    // Import ESM oficial\r\n    const { createChat } = await import('https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js');\r\n\r\n    // Â¡No pasamos un contenedor de embedding! (asÃ­ no ocupa fullscreen)\r\n    createChat({\r\n      webhookUrl: WEBHOOK_URL,\r\n      chatSessionKey: CHAT_SESSION_KEY,\r\n      loadPreviousSession: true,\r\n      metadata: { sessionId },\r\n\r\n      // UX mÃ­nima de burbuja\r\n      position: 'bottom-right',\r\n      launcherTitle: 'Asistente',\r\n      initialMessages: ['Hola ð Â¿en quÃ© te ayudo?'],\r\n      i18n: {\r\n\t\ten: {\r\n\t\t\ttitle: 'Asistente',\r\n\t\t\tsubtitle: \"\",\r\n\t\t\tfooter: '',\r\n\t\t\tgetStarted: '',\r\n\t\t\tinputPlaceholder: 'EscribÃ­ tu consulta...',\r\n\t\t},\r\n      },\r\n      \r\n\r\n      // Si tu versiÃ³n soporta theme, descomenta:\r\n       theme: { primary: '#111827' }\r\n    });\r\n  }\r\n\r\n  boot().catch(err => {\r\n    console.error('n8n chat error:', err);\r\n    // Fallback visual mÃ­nimo por si CSP bloquea el CSS\r\n    const warn = document.createElement('div');\r\n    warn.style.cssText = 'position:fixed;bottom:12px;right:12px;padding:8px 12px;background:#111;color:#fff;border-radius:8px;font:14px/1.2 system-ui;';\r\n    warn.textContent = 'No se pudo cargar el CSS de @n8n/chat (revisar CSP).';\r\n    document.body.appendChild(warn);\r\n  });\r\n</script>\r\n\r\n",
              "cardCss" : ""
            },
            "title" : "HTML Card",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "f91fe7ad-f793-d95d-ffec-adb94336d21d"
        },
        "b0aea088-616d-2f48-61d1-7efd74846d49" : {
          "typeFullFqn" : "system.map",
          "type" : "latest",
          "sizeX" : 8.5,
          "sizeY" : 6,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1741884755143,
                  "endTimeMs" : 1741971155143
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "rgba(0, 0, 0, 0)",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "mapType" : "geoMap",
              "layers" : [ {
                "label" : "{i18n:widgets.maps.layer.hybrid}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery",
                "referenceLayer" : "openstreetmap_hybrid"
              }, {
                "label" : "{i18n:widgets.maps.layer.satellite}",
                "provider" : "openstreet",
                "layerType" : "Esri.WorldImagery"
              }, {
                "label" : "{i18n:widgets.maps.layer.roadmap}",
                "provider" : "openstreet",
                "layerType" : "OpenStreetMap.Mapnik"
              } ],
              "imageSource" : null,
              "markers" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : [ {
                  "name" : "temperature",
                  "type" : "timeseries",
                  "label" : "temperature",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.570889787682481,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "humidity",
                  "type" : "timeseries",
                  "label" : "humidity",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13597394595782442,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "active",
                  "type" : "attribute",
                  "label" : "active",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21080919932756603
                }, {
                  "name" : "type",
                  "type" : "entityField",
                  "label" : "Tipo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.1357587191053956
                }, {
                  "name" : "pozo",
                  "type" : "timeseries",
                  "label" : "pozo",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6817815369277647,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : false,
                  "postFuncBody" : null
                }, {
                  "name" : "nivelAguada",
                  "type" : "timeseries",
                  "label" : "nivelAguada",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.41051360922605606,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "nivelTanque",
                  "type" : "timeseries",
                  "label" : "nivelTanque",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.10653271737889158,
                  "aggregationType" : "NONE",
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : true,
                  "postFuncBody" : "return value || \"\";"
                }, {
                  "name" : "windDir",
                  "type" : "timeseries",
                  "label" : "windDir",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7494149641343646
                }, {
                  "name" : "windSpeed",
                  "type" : "timeseries",
                  "label" : "windSpeed",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6909522833646339
                }, {
                  "name" : "rain",
                  "type" : "timeseries",
                  "label" : "rain",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.3165646978758382
                }, {
                  "name" : "comedero1",
                  "type" : "timeseries",
                  "label" : "comedero1",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5447639875242816
                }, {
                  "name" : "comedero2",
                  "type" : "timeseries",
                  "label" : "comedero2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.13120470438313603
                }, {
                  "name" : "comedero3",
                  "type" : "timeseries",
                  "label" : "comedero3",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.21122955934647059
                }, {
                  "name" : "pressure",
                  "type" : "timeseries",
                  "label" : "pressure",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.6357233440039781
                }, {
                  "name" : "nivelNapa",
                  "type" : "timeseries",
                  "label" : "nivelNapa",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.5158796826873344
                }, {
                  "name" : "waterVolume",
                  "type" : "timeseries",
                  "label" : "waterVolume",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8649181166822368
                }, {
                  "name" : "waterLevelPerc",
                  "type" : "timeseries",
                  "label" : "waterLevelPerc",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.8782297497321601
                }, {
                  "name" : "data_temperature_2",
                  "type" : "timeseries",
                  "label" : "data_temperature_2",
                  "color" : "#2196f3",
                  "settings" : { },
                  "_hash" : 0.7747460584745568
                } ],
                "label" : {
                  "show" : true,
                  "type" : "function",
                  "pattern" : "${entityName}",
                  "patternFunction" : "\nvar color;\nif(data.active !== \"true\"){\n    color = 'rgb(255, 0, 0)';\n} else {\n    color = 'rgb(39, 134, 34)';\n}\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \n           '${entityLabel}' + \n        '</span>'"
                },
                "tooltip" : {
                  "show" : true,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "function",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Temperature:</b> ${temperature:1} Â°C<br/><b>Humidity:</b> ${humidity:0} %<br/><br/><link-act name=\"navigate_to_details\">Detalles</link-act><br/>",
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "patternFunction" : "var deviceType = data.Tipo;\r\n\r\nfunction buildRow(label, value) {\r\n    return `\r\n        <div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">\r\n            <div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:120px\">${label}</div>\r\n            <div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px;color:#29313C\">${value}</div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nif (typeof deviceType !== 'undefined') {\r\n    let content = `\r\n    <div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:'Roboto';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">\r\n        <div>${data.entityLabel ?? 'Sin nombre'}</div>\r\n        <div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>\r\n    `;\r\n\r\n    if (deviceType === \"lanza\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`);\r\n    } else if (deviceType === \"estMeteo\") {\r\n        content +=\r\n            buildRow(\"Temperatura\", `${data.temperature?.toFixed(1) ?? 'N/A'} Â°C`) +\r\n            buildRow(\"Humedad\", `${data.humidity?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Viento\", `${data.windSpeed?.toFixed(1) ?? 'N/A'} m/s`) +\r\n            buildRow(\"DirecciÃ³n\", `${data.windDir?.toFixed(0) ?? 'N/A'}Â°`) +\r\n            buildRow(\"Lluvia\", `${data.rain?.toFixed(1) ?? 'N/A'} mm`) +\r\n            buildRow(\"PresiÃ³n\", `${data.pressure?.toFixed(1) ?? 'N/A'} hPa`);\r\n    } else if (deviceType === \"pozo\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Aguada\", `${data.nivelAguada?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Nivel de Tanque\", `${data.nivelTanque?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Pozo\", estadoPozo);\r\n    } else if (deviceType === \"Ultrasonico\") {\r\n        const estadoPozo = data.pozo == 1 ? \"Con Agua\" : \"Seco\";\r\n        content +=\r\n            buildRow(\"Nivel de Tanque\", `${data.waterLevelPerc?.toFixed(1) ?? 'N/A'} %`) +\r\n            buildRow(\"Volumen de Tanque\", `${data.waterVolume?.toFixed(0) ?? 'N/A'} L`) +\r\n            buildRow(\"Temperatura\", `${data.data_temperature_2?.toFixed(1) ?? 'N/A'} Â°C`)\r\n    } else if (deviceType === \"Freatimetro\") {\r\n        content +=\r\n            buildRow(\"Nivel Napa\", `${data.nivelNapa?.toFixed(1) ?? 'N/A'} m`);\r\n    } else if (deviceType === \"comedero\") {\r\n        content +=\r\n            buildRow(\"Comedero 1\", `${data.comedero1?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 2\", `${data.comedero2?.toFixed(0) ?? 'N/A'} %`) +\r\n            buildRow(\"Comedero 3\", `${data.comedero3?.toFixed(0) ?? 'N/A'} %`);\r\n    } else {\r\n        content += buildRow(\"Tipo\", \"Desconocido\");\r\n    }\r\n\r\n    content += `\r\n    <div style=\"text-align:center; margin-top:16px;\">\r\n        <link-act name=\"navigate_to_details\">Detalles</link-act>\r\n    </div>\r\n</div>`;\r\n\r\n\r\n\r\n    return content;\r\n}\r\n\r\nreturn `<b>${data.entityName ?? 'Dispositivo'}</b><br/>Tipo desconocido<br/>`;\r\n",
                  "tagActions" : [ {
                    "name" : "navigate_to_details",
                    "type" : "custom",
                    "customFunction" : "var deviceService = widgetContext.deviceService;\n\ndeviceService.getDevice(entityId.id, {\n    ignoreLoading: true\n}).subscribe(\n    function(device) {\n        var deviceType = device.type;\n        var params = {\n            entityId: entityId,\n            entityName: entityName,\n            entityLabel: entityLabel\n        };\n        var targetDashboardStateId;\n        switch (deviceType) {\n            case \"estMeteo\":\n                targetDashboardStateId =\n                    \"estMeteo_details\";\n                break;\n            case \"pozo\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"Ultrasonico\":\n                targetDashboardStateId = \"pozo_details\";\n                break;\n            case \"lanza\":\n                targetDashboardStateId =\n                \"lanza_details\";\n                break;\n            case \"comedero\":\n                targetDashboardStateId =\n                \"comedero_details\";\n                break;\n            case \"Freatimetro\":\n                targetDashboardStateId =\n                \"freatimetro_details\";\n                break;\n\n        }\n        if (targetDashboardStateId) {\n            widgetContext.stateController.updateState(\n                targetDashboardStateId, params,\n                false);\n        }\n    }\n);",
                    "openInSeparateDialog" : false,
                    "openInPopover" : false
                  } ]
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape1",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "sensors",
                  "size" : 48,
                  "color" : {
                    "type" : "function",
                    "color" : "rgb(255, 0, 0)",
                    "range" : null,
                    "colorFunction" : "if (data.active !== \"true\"){\n   return 'rgb(255, 0, 0)';\n} else {\n   return 'rgb(39, 134, 34)';\n}"
                  }
                },
                "markerImage" : {
                  "type" : "function",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34,
                  "imageFunction" : "return {};",
                  "images" : [ ]
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : true,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : true,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              }, {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "4db0de46-9963-11ff-d3dc-63bf8867bbd7",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : null,
                "label" : {
                  "show" : false,
                  "type" : "pattern",
                  "pattern" : "",
                  "patternFunction" : null
                },
                "tooltip" : {
                  "show" : false,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "pattern",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} Â°C<br/><small>See tooltip settings for details</small>",
                  "offsetX" : 0,
                  "offsetY" : -1,
                  "patternFunction" : null,
                  "tagActions" : null
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "xKey" : {
                  "name" : "latitude",
                  "label" : "latitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "yKey" : {
                  "name" : "longitude",
                  "label" : "longitude",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3"
                },
                "markerType" : "icon",
                "markerShape" : {
                  "shape" : "markerShape6",
                  "size" : 34,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerIcon" : {
                  "iconContainer" : "iconContainer1",
                  "icon" : "home",
                  "size" : 48,
                  "color" : {
                    "type" : "constant",
                    "color" : "#307FE5"
                  }
                },
                "markerImage" : {
                  "type" : "image",
                  "image" : "/assets/markers/shape1.svg",
                  "imageSize" : 34
                },
                "markerOffsetX" : 0.5,
                "markerOffsetY" : 1,
                "markerClustering" : {
                  "enable" : false,
                  "zoomOnClick" : true,
                  "maxZoom" : null,
                  "maxClusterRadius" : 80,
                  "zoomAnimation" : true,
                  "showCoverageOnHover" : true,
                  "spiderfyOnMaxZoom" : false,
                  "chunkedLoad" : false,
                  "lazyLoad" : true,
                  "useClusterMarkerColorFunction" : false,
                  "clusterMarkerColorFunction" : null
                }
              } ],
              "polygons" : [ {
                "dsType" : "entity",
                "dsLabel" : "",
                "dsDeviceId" : null,
                "dsEntityAliasId" : "4db0de46-9963-11ff-d3dc-63bf8867bbd7",
                "dsFilterId" : null,
                "additionalDataSources" : null,
                "additionalDataKeys" : null,
                "label" : {
                  "show" : false,
                  "type" : "pattern",
                  "pattern" : "${entityName}"
                },
                "tooltip" : {
                  "show" : false,
                  "trigger" : "click",
                  "autoclose" : true,
                  "type" : "pattern",
                  "pattern" : "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
                  "offsetX" : 0,
                  "offsetY" : -1
                },
                "click" : {
                  "type" : "doNothing"
                },
                "groups" : null,
                "edit" : {
                  "enabledActions" : [ "add", "edit", "move", "remove" ],
                  "attributeScope" : "SERVER_SCOPE",
                  "snappable" : false
                },
                "fillType" : "color",
                "fillColor" : {
                  "type" : "constant",
                  "color" : "rgba(51,136,255,0.2)"
                },
                "fillStripe" : {
                  "weight" : 3,
                  "color" : {
                    "type" : "constant",
                    "color" : "#8f8f8f"
                  },
                  "spaceWeight" : 9,
                  "spaceColor" : {
                    "type" : "constant",
                    "color" : "rgba(143,143,143,0)"
                  },
                  "angle" : 45
                },
                "fillImage" : {
                  "type" : "image",
                  "image" : "/assets/widget-preview-empty.svg",
                  "preserveAspectRatio" : true,
                  "opacity" : 1,
                  "angle" : 0,
                  "scale" : 1
                },
                "strokeColor" : {
                  "type" : "constant",
                  "color" : "#3388ff"
                },
                "strokeWeight" : 3,
                "polygonKey" : {
                  "name" : "fieldPerimeter",
                  "label" : "fieldPerimeter",
                  "type" : "attribute",
                  "settings" : { },
                  "color" : "#2196f3",
                  "aggregationType" : null,
                  "units" : null,
                  "decimals" : null,
                  "funcBody" : null,
                  "usePostProcessing" : null,
                  "postFuncBody" : null
                }
              } ],
              "circles" : [ ],
              "additionalDataSources" : [ ],
              "controlsPosition" : "topleft",
              "zoomActions" : [ "scroll", "doubleClick", "controlButtons" ],
              "scales" : [ "metric" ],
              "dragModeButton" : false,
              "fitMapBounds" : true,
              "useDefaultCenterPosition" : false,
              "defaultCenterPosition" : "0,0",
              "defaultZoomLevel" : 14,
              "mapPageSize" : 16384,
              "mapActionButtons" : [ ],
              "background" : {
                "type" : "color",
                "color" : "#fff",
                "overlay" : {
                  "enabled" : false,
                  "color" : "rgba(255,255,255,0.72)",
                  "blur" : 3
                }
              },
              "padding" : "0"
            },
            "title" : "Map",
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "showTitleIcon" : false,
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "widgetCss" : "/* Oculta la barra de attribution */\r\n.leaflet-control-attribution { \r\n  display: none !important; \r\n}\r\n\r\n/* Por si tu tema pone contenedores extra */\r\n.leaflet-bottom.leaflet-right .leaflet-control-attribution {\r\n  display: none !important;\r\n}\r\n",
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "configMode" : "advanced",
            "titleFont" : null,
            "titleColor" : null,
            "margin" : "0px",
            "borderRadius" : "",
            "iconSize" : "24px",
            "titleIcon" : "map",
            "iconColor" : "#1F6BDD",
            "actions" : { }
          },
          "row" : 0,
          "col" : 0,
          "id" : "b0aea088-616d-2f48-61d1-7efd74846d49"
        },
        "5dea708c-1e29-d7c3-6a10-5867d7c259ac" : {
          "typeFullFqn" : "system.action_button",
          "type" : "latest",
          "sizeX" : 3,
          "sizeY" : 1,
          "config" : {
            "datasources" : [ ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1759103859442,
                  "endTimeMs" : 1759190259442
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#FFFFFF01",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "activatedState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : false,
                "getAttribute" : {
                  "key" : "state",
                  "scope" : null
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "compareToValue" : true,
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;"
                }
              },
              "disabledState" : {
                "action" : "DO_NOTHING",
                "defaultValue" : false,
                "getAttribute" : {
                  "key" : "state",
                  "scope" : null
                },
                "getTimeSeries" : {
                  "key" : "state"
                },
                "getAlarmStatus" : {
                  "severityList" : null,
                  "typeList" : null
                },
                "dataToValue" : {
                  "type" : "NONE",
                  "compareToValue" : true,
                  "dataToValueFunction" : "/* Should return boolean value */\nreturn data;"
                }
              },
              "appearance" : {
                "type" : "outlined",
                "showLabel" : true,
                "label" : "Establecer perimetro del campo",
                "showIcon" : true,
                "icon" : "mdi:vector-square-edit",
                "iconSize" : 24,
                "iconSizeUnit" : "px",
                "mainColor" : "#3F52DD",
                "backgroundColor" : "#FFFFFF",
                "autoScale" : true,
                "customStyle" : {
                  "enabled" : null,
                  "hovered" : null,
                  "pressed" : null,
                  "activated" : null,
                  "disabled" : null
                }
              }
            },
            "title" : "Action button",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "borderRadius" : "4px",
            "configMode" : "basic",
            "actions" : {
              "click" : [ {
                "id" : "8e969843-d739-a122-235c-bef303297e08",
                "name" : "onClick",
                "icon" : "more_horiz",
                "type" : "openDashboardState",
                "targetDashboardStateId" : "set_field_perimeter",
                "setEntityId" : true,
                "stateEntityParamName" : null,
                "openRightLayout" : false,
                "dialogTitle" : "",
                "dialogHideDashboardToolbar" : true,
                "dialogWidth" : null,
                "dialogHeight" : null,
                "openInSeparateDialog" : true,
                "openInPopover" : false
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "5dea708c-1e29-d7c3-6a10-5867d7c259ac"
        },
        "a5a088e4-be2c-4ed4-c329-7ee102dface0" : {
          "typeFullFqn" : "tenant.custom_html_card",
          "type" : "latest",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
              "dataKeys" : [ ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1759165160122,
                  "endTimeMs" : 1759251560122
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#fff",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "cardHtml" : "<!-- RaÃ­z opcional (no se usa para incrustar, la burbuja flota) -->\r\n<div id=\"n8n-chat-root\"></div>\r\n\r\n<script type=\"module\">\r\n  // --- CONFIG ---\r\n  const WEBHOOK_URL = 'https://backend.nexoragro.com/webhook/67044a01-2acb-4377-9a32-8c090b67939d/chat';\r\n  const CHAT_SESSION_KEY = 'sessionId'; // n8n espera \"sessionId\"\r\n\r\n  // â Tomamos el entityId desde TB (${entityId}). Si no se resolviÃ³, queda null.\r\n  const ENTITY_ID_TPL = '${entityId}';\r\n  function getEntityIdFromTpl() {\r\n    const v = (ENTITY_ID_TPL || '').trim();\r\n    return v && !/\\$\\{/.test(v) ? v : null;\r\n  }\r\n\r\n  // --- Obtener userId de ThingsBoard (igual que tenÃ­as) ---\r\n  function getTbUserId() {\r\n    try {\r\n      const u = JSON.parse(localStorage.getItem('user') || 'null');\r\n      const idFromUser = u?.userId?.id || u?.user?.id?.id;\r\n      if (idFromUser) return idFromUser;\r\n\r\n      const tok =\r\n        localStorage.getItem('jwt_token') ||\r\n        localStorage.getItem('tb.auth_token') ||\r\n        localStorage.getItem('token');\r\n      if (tok) {\r\n        const base64 = (tok.split('.')[1] || '').replace(/-/g, '+').replace(/_/g, '/');\r\n        const payload = JSON.parse(atob(base64));\r\n        return payload.userId || payload.sub || null;\r\n      }\r\n    } catch (_) {}\r\n    return null;\r\n  }\r\n\r\n  // --- NUEVO: helpers mÃ­nimos para llamar a la API de TB con el JWT ya almacenado ---\r\n  function getJwt() {\r\n    return (\r\n      localStorage.getItem('jwt_token') ||\r\n      localStorage.getItem('tb.auth_token') ||\r\n      localStorage.getItem('token') ||\r\n      null\r\n    );\r\n  }\r\n  async function apiGet(path) {\r\n    const tok = getJwt();\r\n    if (!tok) throw new Error('No JWT');\r\n    const res = await fetch(location.origin.replace(/\\/+$/, '') + path, {\r\n      headers: {\r\n        'X-Authorization': 'Bearer ' + tok,\r\n        'Content-Type': 'application/json'\r\n      }\r\n    });\r\n    if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + path);\r\n    return res.json();\r\n  }\r\n\r\n  // --- NUEVO: obtener user name/email de /api/auth/user y customer name de /api/customer/{id} ---\r\n  async function getUserNameEmail() {\r\n    try {\r\n      const me = await apiGet('/api/auth/user'); // devuelve el usuario logueado\r\n      const id = me?.id?.id ?? null;\r\n      const email = me?.email ?? null;\r\n      const fullName = [\r\n        me?.firstName ?? '',\r\n        me?.lastName ?? ''\r\n      ].join(' ').trim();\r\n      const name = (fullName || me?.name || null) || null;\r\n      return { id, name, email };\r\n    } catch {\r\n      // Fallback a localStorage si falla\r\n      try {\r\n        const u = JSON.parse(localStorage.getItem('user') || 'null');\r\n        const id = u?.userId?.id || u?.user?.id?.id || null;\r\n        const email = u?.email ?? u?.user?.email ?? null;\r\n        const fullName = [\r\n          u?.firstName ?? u?.user?.firstName ?? '',\r\n          u?.lastName ?? u?.user?.lastName ?? ''\r\n        ].join(' ').trim();\r\n        const name = (fullName || u?.name || u?.user?.name || null) || null;\r\n        return { id, name, email };\r\n      } catch {\r\n        return { id: null, name: null, email: null };\r\n      }\r\n    }\r\n  }\r\n\r\n  async function getCustomerName(customerId) {\r\n    if (!customerId) return null;\r\n    try {\r\n      const c = await apiGet('/api/customer/' + customerId);\r\n      return c?.title || c?.name || null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // --- Mantengo tu helper de estilos tal cual ---\r\n  function injectStyle(css) {\r\n    const id = 'n8n-chat-custom-style';\r\n    if (document.getElementById(id)) return;\r\n    const s = document.createElement('style');\r\n    s.id = id;\r\n    s.textContent = css;\r\n    document.head.appendChild(s);\r\n  }\r\n\r\n  const userId = getTbUserId();\r\n  const sessionId = userId || 'anon';\r\n\r\n  // TambiÃ©n tomamos customerId de LS/JWT (como ya usabas antes)\r\n  function getCustomerId() {\r\n    try {\r\n      const u = JSON.parse(localStorage.getItem('user') || 'null');\r\n      const cid = u?.customerId?.id ?? u?.user?.customerId?.id ?? null;\r\n      if (cid) return cid;\r\n    } catch {}\r\n    try {\r\n      const tok = getJwt();\r\n      if (tok) {\r\n        const base64 = (tok.split('.')[1] || '').replace(/-/g, '+').replace(/_/g, '/');\r\n        const payload = JSON.parse(atob(base64));\r\n        return payload.customerId || null;\r\n      }\r\n    } catch {}\r\n    return null;\r\n  }\r\n  const customerId = getCustomerId();\r\n\r\n  // --- 1) Cargar CSS y esperar a que estÃ© listo (igual que tenÃ­as) ---\r\n  function loadCss(href) {\r\n    return new Promise((resolve, reject) => {\r\n      const id = 'n8n-chat-style';\r\n      if (document.getElementById(id)) return resolve();\r\n      const link = document.createElement('link');\r\n      link.id = id;\r\n      link.rel = 'stylesheet';\r\n      link.href = href + '?v=' + Date.now(); // cache-busting\r\n      link.onload = resolve;\r\n      link.onerror = reject;\r\n      document.head.appendChild(link);\r\n    });\r\n  }\r\n\r\n  // --- 2) Importar el mÃ³dulo y crear la burbuja ---\r\n  async function boot() {\r\n    await loadCss('https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css');\r\n\r\n    // Estilos personalizados (despuÃ©s del CSS oficial)\r\n    injectStyle(`\r\n      :root {\r\n        /* Colores (tu tema) */\r\n        --chat--color-primary: #0a2342;\r\n        --chat--color-primary-shade-50: #092037;\r\n        --chat--color-primary-shade-100: #071a2d;\r\n        --chat--color-secondary: #0a2342;\r\n\r\n        /* Header compacto */\r\n        --chat--header-height: auto;\r\n        --chat--header--padding: 0.6rem;\r\n        --chat--heading--font-size: clamp(1rem, 0.9rem + 0.6vw, 1.15rem);\r\n        --chat--subtitle--font-size: clamp(0.85rem, 0.8rem + 0.2vw, 0.95rem);\r\n        --chat--subtitle--line-height: 1.3;\r\n\r\n        /* TipografÃ­a de mensajes (clamp) */\r\n        --chat--message--font-size:  10px !important;\r\n        --chat--message-line-height: 1;\r\n\r\n        /* Ventana y toggle (responsive) */\r\n        --chat--window--width: min(80vw, 600px);\r\n        --chat--window--height: min(80vh, 620px);\r\n        --chat--toggle--size: clamp(56px, 12vw, 72px);\r\n\r\n        /* Input mÃ¡s bajo */\r\n        --chat--textarea--height: 44px;\r\n\r\n        /* Bordes suaves */\r\n        .n8n-chat, .n8n-chat * { font-size:1rem !important; line-height:1.35 !important; }\r\n        --chat--border-radius: 14px;\r\n\r\n        /* Header y burbuja usuario en azul marino */\r\n        --chat--header--background: var(--chat--color-primary);\r\n        --chat--header--color: #fff;\r\n        --chat--message--user--background: var(--chat--color-primary);\r\n        --chat--message--user--color: #fff;\r\n      }\r\n    `);\r\n\r\n    // >>> NUEVO: pedir datos frescos antes de crear el chat <<<\r\n    const [{ id: selfId, name: userName, email: userEmail }, customerName] = await Promise.all([\r\n      getUserNameEmail(),\r\n      getCustomerName(customerId)\r\n    ]);\r\n\r\n    // â Obtenemos entityId resuelto (si el widget/HTML lo inyectÃ³)\r\n    const entityId = getEntityIdFromTpl();\r\n\r\n    // Import ESM oficial\r\n    const { createChat } = await import('https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js');\r\n\r\n    // Crear burbuja con metadata enriquecida (agregado entityId)\r\n    createChat({\r\n      webhookUrl: WEBHOOK_URL,\r\n      chatSessionKey: CHAT_SESSION_KEY,\r\n      loadPreviousSession: true,\r\n      metadata: {\r\n        sessionId,\r\n        userId: userId || selfId || null,\r\n        user: {\r\n          id: userId || selfId || null,\r\n          name: userName || null,\r\n          email: userEmail || null\r\n        },\r\n        customer: {\r\n          id: customerId || null,\r\n          name: customerName || null\r\n        },\r\n        // â NUEVO: entityId (solo si estÃ¡ disponible)\r\n        entityId: entityId || null\r\n      },\r\n\r\n      // UX mÃ­nima de burbuja\r\n      position: 'bottom-right',\r\n      launcherTitle: 'Asistente',\r\n      initialMessages: ['Hola ð Â¿en quÃ© te ayudo?'],\r\n      i18n: {\r\n        en: {\r\n          title: 'Asistente',\r\n          subtitle: \"\",\r\n          footer: '',\r\n          getStarted: '',\r\n          inputPlaceholder: 'EscribÃ­ tu consulta...',\r\n        },\r\n      },\r\n\r\n      // Theme (igual que antes)\r\n      theme: { primary: '#111827' }\r\n    });\r\n  }\r\n\r\n  boot().catch(err => {\r\n    console.error('n8n chat error:', err);\r\n    // Fallback visual mÃ­nimo por si CSP bloquea el CSS\r\n    const warn = document.createElement('div');\r\n    warn.style.cssText = 'position:fixed;bottom:12px;right:12px;padding:8px 12px;background:#111;color:#fff;border-radius:8px;font:14px/1.2 system-ui;';\r\n    warn.textContent = 'No se pudo cargar el CSS de @n8n/chat (revisar CSP).';\r\n    document.body.appendChild(warn);\r\n  });\r\n</script>\r\n",
              "cardCss" : ""
            },
            "title" : "Custom HTML Card",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "useDashboardTimewindow" : true,
            "showLegend" : false,
            "actions" : { },
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "a5a088e4-be2c-4ed4-c329-7ee102dface0"
        },
        "a1a9e001-a144-0878-d695-aae0affe8182" : {
          "typeFullFqn" : "system.cards.markdown_card",
          "type" : "latest",
          "sizeX" : 5,
          "sizeY" : 3.5,
          "config" : {
            "datasources" : [ {
              "type" : "entity",
              "name" : "",
              "entityAliasId" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
              "dataKeys" : [ {
                "name" : "name",
                "type" : "entityField",
                "label" : "Nombre",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.18788394870546488
              }, {
                "name" : "type",
                "type" : "entityField",
                "label" : "Tipo",
                "color" : "#4caf50",
                "settings" : { },
                "_hash" : 0.7277008645532687
              }, {
                "name" : "data_temperature_2",
                "type" : "timeseries",
                "label" : "data_temperature_2",
                "color" : "#f44336",
                "settings" : { },
                "_hash" : 0.3113716288501823
              }, {
                "name" : "waterLevelPerc",
                "type" : "timeseries",
                "label" : "waterLevelPerc",
                "color" : "#ffc107",
                "settings" : { },
                "_hash" : 0.3588994643776008
              }, {
                "name" : "waterVolume",
                "type" : "timeseries",
                "label" : "waterVolume",
                "color" : "#607d8b",
                "settings" : { },
                "_hash" : 0.11598182185513584
              }, {
                "name" : "rain",
                "type" : "timeseries",
                "label" : "rain",
                "color" : "#9c27b0",
                "settings" : { },
                "_hash" : 0.20112760147397624
              }, {
                "name" : "windDir",
                "type" : "timeseries",
                "label" : "windDir",
                "color" : "#8bc34a",
                "settings" : { },
                "_hash" : 0.05847622555323728
              }, {
                "name" : "temperature",
                "type" : "timeseries",
                "label" : "temperature",
                "color" : "#e91e63",
                "settings" : { },
                "_hash" : 0.012523065486068519
              }, {
                "name" : "humidity",
                "type" : "timeseries",
                "label" : "humidity",
                "color" : "#ffeb3b",
                "settings" : { },
                "_hash" : 0.946407427496765
              }, {
                "name" : "windSpeed",
                "type" : "timeseries",
                "label" : "windSpeed",
                "color" : "#ffeb3b",
                "settings" : { },
                "_hash" : 0.41291441643142546
              }, {
                "name" : "pressure",
                "type" : "timeseries",
                "label" : "pressure",
                "color" : "#03a9f4",
                "settings" : { },
                "_hash" : 0.6169344540672429
              }, {
                "name" : "comedero1",
                "type" : "timeseries",
                "label" : "comedero1",
                "color" : "#ff9800",
                "settings" : { },
                "_hash" : 0.5308682453811485
              }, {
                "name" : "comedero2",
                "type" : "timeseries",
                "label" : "comedero2",
                "color" : "#673ab7",
                "settings" : { },
                "_hash" : 0.40970797413494
              }, {
                "name" : "comedero3",
                "type" : "timeseries",
                "label" : "comedero3",
                "color" : "#cddc39",
                "settings" : { },
                "_hash" : 0.6186957887381043
              } ],
              "alarmFilterConfig" : {
                "statusList" : [ "ACTIVE" ]
              }
            } ],
            "timewindow" : {
              "displayValue" : "",
              "selectedTab" : 0,
              "realtime" : {
                "realtimeType" : 1,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideQuickInterval" : false
              },
              "history" : {
                "historyType" : 0,
                "interval" : 1000,
                "timewindowMs" : 60000,
                "fixedTimewindow" : {
                  "startTimeMs" : 1757198970022,
                  "endTimeMs" : 1757285370022
                },
                "quickInterval" : "CURRENT_DAY",
                "hideInterval" : false,
                "hideLastInterval" : false,
                "hideFixedInterval" : false,
                "hideQuickInterval" : false
              },
              "aggregation" : {
                "type" : "AVG",
                "limit" : 25000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#FFFFFF00",
            "color" : "rgba(0, 0, 0, 0.87)",
            "padding" : "0px",
            "settings" : {
              "useMarkdownTextFunction" : true,
              "markdownTextPattern" : "<script>\r\n/**\r\n * Cards por dispositivo con filtro por tipo (case-insensitive),\r\n * orden por tipo+label y botÃ³n que dispara acciÃ³n goToDetails.\r\n *\r\n * Requiere: definir acciÃ³n \"goToDetails\" en la pestaÃ±a Acciones del widget.\r\n * Pasa { entityId, entityLabel, deviceType } como datos de la acciÃ³n.\r\n */\r\n\r\n// ---- Utils ----\r\nfunction getItemTypeRaw(item) {\r\n  return item.Tipo ?? item.tipo ?? item.type ?? item.deviceType ?? '';\r\n}\r\nfunction getItemTypeLc(item) {\r\n  return String(getItemTypeRaw(item)).trim().toLowerCase();\r\n}\r\nfunction getLabel(item) {\r\n  return item.entityLabel || item.label || item.name || ('Device ' + (item.entityId || ''));\r\n}\r\nfunction dedupByEntityId(arr) {\r\n  const seen = new Set();\r\n  const out = [];\r\n  for (const it of arr) {\r\n    const id = it.entityId || it.id;\r\n    if (!id) continue;\r\n    if (seen.has(id)) continue;\r\n    seen.add(id);\r\n    out.push(it);\r\n  }\r\n  return out;\r\n}\r\n\r\n// ---- Render de una card ----\r\nfunction getDeviceCard(item) {\r\n  const deviceLabel = getLabel(item);\r\n  const deviceId = item.entityId || item.id || '';\r\n  const typeRaw = String(getItemTypeRaw(item) || '').trim();\r\n  const typeLc = typeRaw.toLowerCase();\r\n\r\n  return `\r\n    <div class=\"flex-item\" data-type-lc=\"${typeLc}\" data-id=\"${deviceId}\">\r\n      <div class=\"card\">\r\n        <div class=\"content\">\r\n          <h2>${deviceLabel}</h2>\r\n          <i class=\"chip\">${typeRaw || 'â'}</i>\r\n          <div class=\"info muted\">ID: ${deviceId}</div>\r\n        </div>\r\n        <div class=\"card-buttons noselect\">\r\n          <button class=\"button button-primary btn-details\"\r\n                  data-id=\"${deviceId}\"\r\n                  data-label=\"${deviceLabel.replace(/\"/g, '&quot;')}\"\r\n                  data-type=\"${typeRaw.replace(/\"/g, '&quot;')}\">\r\n            Ver detalles\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>`;\r\n}\r\n\r\n// ---- Filtros (checkbox por tipo detectado) ----\r\nfunction renderFilters(typesLcSorted, typeDisplayByLc) {\r\n  const options = typesLcSorted.map(tlc => {\r\n    const display = typeDisplayByLc[tlc] || tlc;\r\n    return `\r\n      <label class=\"filter-opt\">\r\n        <input type=\"checkbox\" class=\"flt\" value=\"${tlc}\" checked />\r\n        <span>${display}</span>\r\n      </label>`;\r\n  }).join('');\r\n  return `\r\n    <div class=\"toolbar\">\r\n      <div class=\"filters\">\r\n        <span class=\"lbl\">Filtrar:</span>\r\n        ${options}\r\n      </div>\r\n    </div>`;\r\n}\r\n\r\n// ---- Render principal ----\r\n(function renderCards() {\r\n  // 1) Dataset saneado y deduplicado\r\n  const list = Array.isArray(data) ? data.slice() : [];\r\n  const devices = dedupByEntityId(list);\r\n\r\n  // 2) Orden por tipo (lc) y luego por label\r\n  devices.sort((a, b) => {\r\n    const ta = getItemTypeLc(a);\r\n    const tb = getItemTypeLc(b);\r\n    if (ta < tb) return -1;\r\n    if (ta > tb) return 1;\r\n    const la = getLabel(a).toLowerCase();\r\n    const lb = getLabel(b).toLowerCase();\r\n    if (la < lb) return -1;\r\n    if (la > lb) return 1;\r\n    return 0;\r\n  });\r\n\r\n  // 3) Tipos Ãºnicos (lc) y un display representativo por tipo\r\n  const typeDisplayByLc = {};\r\n  for (const it of devices) {\r\n    const lc = getItemTypeLc(it);\r\n    if (!(lc in typeDisplayByLc)) {\r\n      typeDisplayByLc[lc] = String(getItemTypeRaw(it) || lc);\r\n    }\r\n  }\r\n  const typesLcSorted = Object.keys(typeDisplayByLc).sort();\r\n\r\n  // 4) ConstrucciÃ³n del HTML\r\n  let html = '';\r\n  html += renderFilters(typesLcSorted, typeDisplayByLc);\r\n  html += '<div id=\"cards-root\" class=\"flex-container wrap\">';\r\n  for (const it of devices) {\r\n    html += getDeviceCard(it);\r\n  }\r\n  html += '</div>';\r\n\r\n  // 5) Inyectar\r\n  document.currentScript.insertAdjacentHTML('afterend', html);\r\n\r\n  // 6) Listeners: filtros y botÃ³n detalles\r\n  const $root = document.getElementById('cards-root');\r\n\r\n  // Filtro: mostrar/ocultar por data-type-lc\r\n  function applyFilters() {\r\n    const checked = Array.from(document.querySelectorAll('.filters .flt:checked')).map(i => i.value);\r\n    const items = $root.querySelectorAll('.flex-item');\r\n    items.forEach(el => {\r\n      const typeLc = el.getAttribute('data-type-lc') || '';\r\n      el.style.display = checked.includes(typeLc) ? '' : 'none';\r\n    });\r\n  }\r\n  document.querySelectorAll('.filters .flt').forEach(cb => {\r\n    cb.addEventListener('change', applyFilters);\r\n  });\r\n  applyFilters();\r\n\r\n  // AcciÃ³n: goToDetails (definida en pestaÃ±a Acciones)\r\n  $root.addEventListener('click', function (ev) {\r\n    const btn = ev.target.closest('.btn-details');\r\n    if (!btn) return;\r\n    const deviceId = btn.getAttribute('data-id');\r\n    const deviceLabel = btn.getAttribute('data-label') || '';\r\n    const deviceType = btn.getAttribute('data-type') || '';\r\n    try {\r\n      if (self && self.ctx && self.ctx.actionsApi && typeof self.ctx.actionsApi.performAction === 'function') {\r\n        self.ctx.actionsApi.performAction('goToDetails', {\r\n          entityId: deviceId,\r\n          entityLabel: deviceLabel,\r\n          deviceType: deviceType\r\n        });\r\n      }\r\n    } catch (e) {\r\n      // Silencioso para no romper el widget si no estÃ¡ definida la acciÃ³n\r\n      // console.warn('performAction error:', e);\r\n    }\r\n  });\r\n})();\r\n</script>\r\n\r\n\r\n",
              "markdownTextFunction" : "// === Helpers cortos ===\r\nfunction getTypeRaw(it){return (it&&(it.Tipo||it.tipo||it.type||it.deviceType))||'';}\r\nfunction getTypeLc(it){var t=getTypeRaw(it);return String(t).replace(/^\\s+|\\s+$/g,'').toLowerCase();}\r\nfunction getLabel(it){return (it&&(it.entityLabel||it.label||it.name))||('Device '+((it&&(it.entityId||it.id))||''));}\r\nfunction esc(s){s=(s==null)?'':String(s);return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;');}\r\nfunction dedupByEntityId(arr){var seen={},out=[];for(var i=0;i<arr.length;i++){var it=arr[i],id=it&&(it.entityId||it.id);if(!id||seen[id])continue;seen[id]=1;out.push(it);}return out;}\r\nfunction n(v,d){if(v==null||v===''||isNaN(Number(v)))return'N/A';var num=Number(v);return(typeof d==='number')?num.toFixed(d):String(num);}\r\nfunction buildRow(k,v){\r\n  return '<div class=\"kv\" style=\"display:flex;justify-content:space-between;align-items:baseline;margin:6px 0;\">'\r\n       +   '<div class=\"k\" style=\"font-size:13px;font-weight:500;color:rgba(0,0,0,.38);margin-right:8px;\">'+esc(k)+'</div>'\r\n       +   '<div class=\"v\" style=\"font-size:14px;font-weight:600;color:#29313C;text-align:right;\">'+esc(v)+'</div>'\r\n       + '</div>';\r\n}\r\n// Auto-sizing por longitud (mapea a tus clases CSS title--xl|lg|md|sm|xs)\r\nfunction titleClassFor(label){\r\n  var len=(label||'').length;\r\n  if (len<=18) return 'title--xl';\r\n  if (len<=26) return 'title--lg';\r\n  if (len<=34) return 'title--md';\r\n  if (len<=46) return 'title--sm';\r\n  return 'title--xs';\r\n}\r\n\r\n// === Mapeo de tipo -> etiqueta visible (custom type) ===\r\n// Es case-insensitive: comparamos en minÃºsculas con getTypeLc(...)\r\nvar customTypeMap = {\r\n  'ultrasonico': 'Aguada',\r\n  'estmeteo': 'EstaciÃ³n meteorologica',\r\n  'freatimetro': 'FreatÃ­metro',\r\n  'pozo': 'Pozo',\r\n  'comedero': 'Comedero',\r\n  'lanza': 'Lanza'\r\n};\r\n\r\n// === Dataset y orden ===\r\nvar list = Array.isArray(data) ? data.slice() : [];\r\nvar devices = dedupByEntityId(list);\r\ndevices.sort(function(a,b){\r\n  var ta=getTypeLc(a), tb=getTypeLc(b);\r\n  if(ta<tb) return -1; if(ta>tb) return 1;\r\n  var la=getLabel(a).toLowerCase(), lb=getLabel(b).toLowerCase();\r\n  if(la<lb) return -1; if(la>lb) return 1;\r\n  return 0;\r\n});\r\n\r\n// === Render ===\r\nvar html = '<div class=\"flex-container wrap\">';\r\nfor (var i=0;i<devices.length;i++){\r\n  var it = devices[i];\r\n  var deviceId = (it&&(it.entityId||it.id)) || '';\r\n  var label = getLabel(it);\r\n  var typeRaw = String(getTypeRaw(it)||'');\r\n  var typeLc  = getTypeLc(it);\r\n\r\n  // tÃ­tulo: clase dinÃ¡mica segÃºn longitud -> ajusta tamaÃ±o para 1â2 lÃ­neas\r\n  var titleCls = titleClassFor(label);\r\n\r\n  // chipLabel con override por mapa personalizado (si no existe, usa el type tal cual)\r\n  var chipLabel = customTypeMap[typeLc] || typeRaw || 'â';\r\n\r\n  // contenido especÃ­fico por tipo\r\n  var infoHtml = '';\r\n  if (typeLc==='lanza'){\r\n    infoHtml+=buildRow('Temperatura', n(it.temperature,1)+' Â°C');\r\n    infoHtml+=buildRow('Humedad', n(it.humidity,0)+' %');\r\n  } else if (typeLc==='estmeteo'){\r\n    infoHtml+=buildRow('Temperatura', n(it.temperature,1)+' Â°C');\r\n    infoHtml+=buildRow('Humedad', n(it.humidity,0)+' %');\r\n    infoHtml+=buildRow('Viento', n(it.windSpeed,1)+' m/s');\r\n    infoHtml+=buildRow('DirecciÃ³n', n(it.windDir,0)+'Â°');\r\n    infoHtml+=buildRow('Lluvia', n(it.rain,1)+' mm');\r\n    infoHtml+=buildRow('PresiÃ³n', n(it.pressure,1)+' hPa');\r\n  } else if (typeLc==='pozo'){\r\n    var estadoPozo = (String(it.pozo)==='1') ? 'Con Agua' : 'Seco';\r\n    infoHtml+=buildRow('Nivel de Aguada', n(it.nivelAguada,1)+' %');\r\n    infoHtml+=buildRow('Nivel de Tanque', n(it.nivelTanque,1)+' %');\r\n    infoHtml+=buildRow('Pozo', estadoPozo);\r\n  } else if (typeLc==='ultrasonico'){\r\n    infoHtml+=buildRow('Nivel de Tanque', n(it.waterLevelPerc,1)+' %');\r\n    infoHtml+=buildRow('Volumen de Tanque', (n(it.waterVolume,0)==='N/A'?'N/A':n(it.waterVolume,0)+' L'));\r\n    infoHtml+=buildRow('Temperatura', n(it.data_temperature_2,1)+' Â°C');\r\n  } else if (typeLc==='freatimetro'){\r\n    infoHtml+=buildRow('Nivel Napa', n(it.nivelNapa,1)+' m');\r\n  } else if (typeLc==='comedero'){\r\n    infoHtml+=buildRow('Comedero 1', n(it.comedero1,0)+' %');\r\n    infoHtml+=buildRow('Comedero 2', n(it.comedero2,0)+' %');\r\n    infoHtml+=buildRow('Comedero 3', n(it.comedero3,0)+' %');\r\n  } else {\r\n    infoHtml+=buildRow('Tipo', chipLabel);\r\n  }\r\n\r\n  html += ''\r\n    + '<div class=\"flex-item\" data-id=\"'+esc(deviceId)+'\">'\r\n    + '  <div class=\"card card--equal\">'\r\n    + '    <div class=\"content\">'\r\n    + '      <h2 class=\"device-title '+titleCls+'\">'+esc(label)+'</h2>'\r\n    + '      <i class=\"chip\">'+esc(chipLabel)+'</i>'\r\n    + '      <div class=\"info-block\" style=\"margin-top:10px;text-align:left;\">'+infoHtml+'</div>'\r\n    + '    </div>'\r\n    + '    <div class=\"card-buttons noselect\">'\r\n    + '      <button id=\"goToDetails\" tb-action [actionId]=\"\\'goToDetails\\'\"'\r\n    + '              data-entity-id=\"'+esc(deviceId)+'\"'\r\n    + '              data-entity-name=\"'+esc(label)+'\"'\r\n    + '              data-entity-label=\"'+esc(label)+'\"'\r\n    + '              class=\"button\" type=\"button\"'\r\n    + '              style=\"width:100%;border-right:none;display:flex;align-items:center;justify-content:center;\">'\r\n    + '        Ver detalles'\r\n    + '      </button>'\r\n    + '    </div>'\r\n    + '  </div>'\r\n    + '</div>';\r\n}\r\nhtml += '</div>';\r\nreturn html;\r\n",
              "applyDefaultMarkdownStyle" : true,
              "markdownCss" : "/* ====== BASE LAYOUT ====== */\r\n.flex-container {\r\n  padding: 0;\r\n  margin: 0;\r\n  list-style: none;\r\n\r\n  display: -webkit-box;\r\n  display: -moz-box;\r\n  display: -ms-flexbox;\r\n  display: -moz-flex;\r\n  display: -webkit-flex;\r\n  display: flex;\r\n}\r\n.wrap {\r\n  -webkit-flex-wrap: wrap;\r\n  flex-wrap: wrap;\r\n}\r\n.flex-item {\r\n  margin: 10px;         /* separaciÃ³n entre cards */\r\n  font-size: 1em;\r\n  flex: 1 1 325px;      /* 2â3 columnas segÃºn ancho */\r\n  max-width: 380px;     /* lÃ­mite de ancho por card */\r\n}\r\n\r\n/* ====== CLEARFIX ====== */\r\n.row:after { content: \"\"; display: table; clear: both; }\r\n\r\n/* ====== CARD ====== */\r\n.card {\r\n  min-width: 325px;\r\n  box-shadow: 0 4px 8px 0 rgba(0,0,0,.2);\r\n  padding: 0;\r\n  font-family: 'Poppins', Helvetica, Arial, sans-serif;\r\n  border-radius: 12px;\r\n  overflow: hidden;               /* respeta el radio */\r\n  height: 100%;                   /* igualar alturas */\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n.content {\r\n  padding: 16px;\r\n  text-align: center;\r\n  background-color: #fff;\r\n  flex: 1 1 auto;                 /* empuja el botÃ³n al pie */\r\n}\r\n\r\n.chip {\r\n  display: inline-block;\r\n  margin-top: 2px;                /* mÃ¡s pegado al tÃ­tulo */\r\n  border-radius: 6px;\r\n  padding: 2px 6px;\r\n  font-size: 1rem;\r\n  font-weight: 500;\r\n  background-color: #e2e8f0;\r\n  color: #334155;\r\n}\r\n\r\n.noselect {\r\n  -webkit-user-select: none;\r\n  -moz-user-select: none;\r\n  -ms-user-select: none;\r\n  user-select: none;\r\n}\r\n\r\n/* ====== BUTTONS ====== */\r\n.card-buttons {\r\n  border-top: 1px solid #e6e6e6;  /* separador claro (no tan oscuro) */\r\n  background-color: #fff;\r\n  overflow: hidden;\r\n  border-bottom-left-radius: 12px;\r\n  border-bottom-right-radius: 12px;\r\n  padding: 0;\r\n}\r\n\r\n.button {\r\n  background-color: #f3f4f6;      /* gris claro, sin borde oscuro */\r\n  color: #374151;\r\n  cursor: pointer;\r\n  float: left;\r\n  font-weight: 600;\r\n  height: 50px;\r\n  line-height: 50px;\r\n  text-align: center;\r\n  text-transform: uppercase;\r\n  transition: background-color .15s ease, transform .08s ease, box-shadow .15s ease, opacity .15s ease;\r\n  width: 100%;                    /* ocupa todo el ancho */\r\n  border: 0;                      /* sin bordes */\r\n  border-right: 0;\r\n\r\n  display: flex; align-items: center; justify-content: center;\r\n}\r\n.button:hover {\r\n  background-color: #e5e7eb;      /* mÃ¡s contraste en hover */\r\n  opacity: .98;\r\n  transform: translateY(-1px);\r\n  box-shadow: 0 6px 14px rgba(0,0,0,0.08);\r\n}\r\n.button:focus-visible {\r\n  outline: none;\r\n  box-shadow: 0 0 0 3px rgba(59,130,246,0.35);\r\n}\r\n\r\n/* ====== TÃTULO ADAPTABLE (1â2 lÃ­neas, alturas consistentes) ====== */\r\n.device-title {\r\n  margin: 0 0 4px 0;              /* un toque mÃ¡s pegado al chip */\r\n  line-height: 1.2;\r\n  display: -webkit-box;\r\n  -webkit-line-clamp: 2;          /* mÃ¡ximo 2 lÃ­neas visibles */\r\n  -webkit-box-orient: vertical;\r\n  overflow: hidden;\r\n  word-break: break-word;\r\n  min-height: 2.4em;              /* reserva â 2 lÃ­neas para que todas las cards calcen */\r\n}\r\n\r\n/* escalas por longitud (las asigna tu HTML: title--xl|lg|md|sm|xs) */\r\n.device-title.title--xl { font-size: 1.6rem; }\r\n.device-title.title--lg { font-size: 1.4rem; }\r\n.device-title.title--md { font-size: 1.2rem; }\r\n.device-title.title--sm { font-size: 1.05rem; }\r\n.device-title.title--xs { font-size: 0.95rem; }\r\n"
            },
            "title" : "Markdown/HTML Card",
            "showTitleIcon" : false,
            "iconColor" : "rgba(0, 0, 0, 0.87)",
            "iconSize" : "24px",
            "titleTooltip" : "",
            "dropShadow" : false,
            "enableFullscreen" : false,
            "widgetStyle" : { },
            "titleStyle" : {
              "fontSize" : "16px",
              "fontWeight" : 400
            },
            "showLegend" : false,
            "useDashboardTimewindow" : true,
            "displayTimewindow" : true,
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : "",
            "actions" : {
              "elementClick" : [ {
                "name" : "goToDetails",
                "icon" : "more_horiz",
                "useShowWidgetActionFunction" : null,
                "showWidgetActionFunction" : "return true;",
                "type" : "custom",
                "customFunction" : "var deviceService = widgetContext.deviceService;\r\n\r\nvar targetEl = (widgetContext && widgetContext.$event && widgetContext.$event.target)\r\n  ? widgetContext.$event.target\r\n  : (typeof document !== 'undefined' ? document.activeElement : null);\r\n\r\nfunction getAttr(el, name) {\r\n  if (!el) return null;\r\n  var v = el.getAttribute(name);\r\n  return (v !== null && v !== undefined && v !== '') ? v : null;\r\n}\r\n\r\nvar buttonEntityId    = getAttr(targetEl, 'data-entity-id');\r\nvar buttonEntityName  = getAttr(targetEl, 'data-entity-name');\r\nvar buttonEntityLabel = getAttr(targetEl, 'data-entity-label');\r\n\r\nvar eId    = buttonEntityId ? { entityType: 'DEVICE', id: buttonEntityId } : entityId;\r\nvar eName  = buttonEntityName || entityName || (buttonEntityId || '');\r\nvar eLabel = buttonEntityLabel || entityLabel || (buttonEntityId || '');\r\n\r\ndeviceService.getDevice(eId.id, { ignoreLoading: true }).subscribe(function(device) {\r\n  var deviceType = device.type;\r\n  var params = { entityId: eId, entityName: eName, entityLabel: eLabel };\r\n  var target = null;\r\n\r\n  switch (deviceType) {\r\n    case \"estMeteo\":    target=\"estMeteo_details\"; break;\r\n    case \"pozo\":        target=\"pozo_details\";     break;\r\n    case \"Ultrasonico\": target=\"pozo_details\";     break;\r\n    case \"lanza\":       target=\"lanza_details\";    break;\r\n    case \"comedero\":    target=\"comedero_details\"; break;\r\n    case \"Freatimetro\": target=\"freatimetro_details\"; break;\r\n  }\r\n\r\n  if (target) {\r\n    widgetContext.stateController.updateState(target, params, true);\r\n  }\r\n});\r\n",
                "openInSeparateDialog" : false,
                "openInPopover" : false,
                "id" : "154e40d1-c746-a571-10d7-b464dd7598f3"
              } ]
            }
          },
          "row" : 0,
          "col" : 0,
          "id" : "a1a9e001-a144-0878-d695-aae0affe8182"
        }
      },
      "states" : {
        "default" : {
          "name" : "Home",
          "root" : true,
          "layouts" : {
            "main" : {
              "widgets" : {
                "e9b44a17-a4e8-a720-9552-36e4cbdd0863" : {
                  "sizeX" : 10,
                  "sizeY" : 9,
                  "resizable" : true,
                  "row" : 1,
                  "col" : 4
                },
                "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                  "sizeX" : 4,
                  "sizeY" : 13,
                  "row" : 0,
                  "col" : 0
                },
                "61b8a4c1-a6f1-6281-442d-3f7106a11bb0" : {
                  "sizeX" : 3,
                  "sizeY" : 1,
                  "row" : 0,
                  "col" : 4
                },
                "a04df291-ae01-490d-3608-b1fb5639ae0e" : {
                  "sizeX" : 3,
                  "sizeY" : 1,
                  "row" : 0,
                  "col" : 7
                },
                "91982601-2bfa-cc2d-da7b-be5d9cdf6f9d" : {
                  "sizeX" : 1,
                  "sizeY" : 1,
                  "row" : 1,
                  "col" : 14,
                  "resizable" : true,
                  "mobileHide" : false,
                  "desktopHide" : false
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 24,
                "viewFormat" : "grid",
                "autoFillHeight" : false,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              },
              "breakpoints" : {
                "md" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 24,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "minColumns" : 24,
                    "viewFormat" : "grid",
                    "autoFillHeight" : false,
                    "rowHeight" : 70,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "e9b44a17-a4e8-a720-9552-36e4cbdd0863" : {
                      "sizeX" : 11,
                      "sizeY" : 11,
                      "resizable" : true,
                      "row" : 2,
                      "col" : 4
                    },
                    "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                      "sizeX" : 4,
                      "sizeY" : 13,
                      "row" : 0,
                      "col" : 0
                    },
                    "61b8a4c1-a6f1-6281-442d-3f7106a11bb0" : {
                      "sizeX" : 4,
                      "sizeY" : 2,
                      "row" : 0,
                      "col" : 4
                    },
                    "a04df291-ae01-490d-3608-b1fb5639ae0e" : {
                      "sizeX" : 4,
                      "sizeY" : 2,
                      "row" : 0,
                      "col" : 8
                    }
                  }
                },
                "xs" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 24,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "minColumns" : 24,
                    "viewFormat" : "list",
                    "autoFillHeight" : true,
                    "rowHeight" : 70,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "26dcfa07-d55f-8108-1c8c-11d53dbc3cdf" : {
                      "sizeX" : 4,
                      "sizeY" : 13,
                      "mobileOrder" : 1,
                      "resizable" : true,
                      "row" : 0,
                      "col" : 0
                    },
                    "91982601-2bfa-cc2d-da7b-be5d9cdf6f9d" : {
                      "sizeX" : 1,
                      "sizeY" : 1,
                      "resizable" : true,
                      "row" : 13,
                      "col" : 2
                    }
                  }
                },
                "lg" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 24,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "minColumns" : 24,
                    "viewFormat" : "grid",
                    "autoFillHeight" : false,
                    "rowHeight" : 70,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "e9b44a17-a4e8-a720-9552-36e4cbdd0863" : {
                      "sizeX" : 12,
                      "sizeY" : 9,
                      "resizable" : true,
                      "row" : 0,
                      "col" : 5
                    },
                    "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                      "sizeX" : 5,
                      "sizeY" : 13,
                      "row" : 0,
                      "col" : 0
                    },
                    "61b8a4c1-a6f1-6281-442d-3f7106a11bb0" : {
                      "sizeX" : 4,
                      "sizeY" : 2,
                      "row" : 2,
                      "col" : 17
                    },
                    "a04df291-ae01-490d-3608-b1fb5639ae0e" : {
                      "sizeX" : 4,
                      "sizeY" : 2,
                      "row" : 0,
                      "col" : 17
                    },
                    "91982601-2bfa-cc2d-da7b-be5d9cdf6f9d" : {
                      "sizeX" : 1,
                      "sizeY" : 1,
                      "row" : 5,
                      "col" : 17,
                      "resizable" : true
                    }
                  }
                }
              }
            }
          }
        },
        "devices" : {
          "name" : "Dispositivos",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "bde68678-7e78-3712-8d2b-627b5b8e8b11" : {
                  "sizeX" : 11,
                  "sizeY" : 11,
                  "resizable" : true,
                  "row" : 0,
                  "col" : 5
                },
                "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                  "sizeX" : 5,
                  "sizeY" : 13,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%"
              },
              "breakpoints" : {
                "xs" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 24,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "viewFormat" : "list",
                    "minColumns" : 24,
                    "autoFillHeight" : false,
                    "rowHeight" : 70,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "bde68678-7e78-3712-8d2b-627b5b8e8b11" : {
                      "sizeX" : 11,
                      "sizeY" : 10,
                      "resizable" : true,
                      "row" : 0,
                      "col" : 4
                    }
                  }
                }
              }
            }
          }
        },
        "alarms" : {
          "name" : "Alarmas",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "ec20cec1-99ac-8c09-a11c-c1d2a049e756" : {
                  "sizeX" : 11,
                  "sizeY" : 8,
                  "row" : 0,
                  "col" : 4
                },
                "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                  "sizeX" : 4,
                  "sizeY" : 13,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%"
              },
              "breakpoints" : {
                "lg" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 24,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%"
                  },
                  "widgets" : {
                    "ec20cec1-99ac-8c09-a11c-c1d2a049e756" : {
                      "sizeX" : 11,
                      "sizeY" : 8,
                      "row" : 0,
                      "col" : 5
                    },
                    "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                      "sizeX" : 5,
                      "sizeY" : 13,
                      "row" : 0,
                      "col" : 0
                    }
                  }
                }
              }
            }
          }
        },
        "dump" : {
          "name" : "dump",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "db950ff4-5a07-3715-4cac-723c6f3ddc97" : {
                  "sizeX" : 3,
                  "sizeY" : 1,
                  "row" : 0,
                  "col" : 0
                },
                "194b430a-d590-85f8-e70e-b994c1ff8713" : {
                  "sizeX" : 3,
                  "sizeY" : 1,
                  "row" : 0,
                  "col" : 3
                },
                "9d7e46d2-1a47-ab6c-6dcf-510dee09671c" : {
                  "sizeX" : 3,
                  "sizeY" : 1,
                  "row" : 0,
                  "col" : 6
                },
                "26ae7f2d-c634-a13d-ab63-2f67646b9a80" : {
                  "sizeX" : 10,
                  "sizeY" : 4,
                  "row" : 0,
                  "col" : 9
                },
                "e1883c9a-eddc-d5ea-d6c9-1d475c5e6e31" : {
                  "sizeX" : 8,
                  "sizeY" : 5,
                  "row" : 4,
                  "col" : 10
                },
                "f91fe7ad-f793-d95d-ffec-adb94336d21d" : {
                  "sizeX" : 2,
                  "sizeY" : 1,
                  "resizable" : true,
                  "row" : 1,
                  "col" : 2
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%"
              }
            }
          }
        },
        "tanks-location" : {
          "name" : "devices map",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "cdd2fc91-0d65-de77-ef91-727493e2502f" : {
                  "sizeX" : 25,
                  "sizeY" : 12,
                  "resizable" : true,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#FFFFFF",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 24,
                "viewFormat" : "grid",
                "autoFillHeight" : false,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              }
            }
          }
        },
        "device-alarm-filter-buttons" : {
          "name" : "device filter buttons",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "8497c662-0aca-b710-7497-f046bf3cbf56" : {
                  "sizeX" : 24,
                  "sizeY" : 2,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#FFFFFF",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 24,
                "viewFormat" : "grid",
                "autoFillHeight" : false,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              }
            }
          }
        },
        "device_alarm_filter_1st_part" : {
          "name" : "map Filter",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "a0a086d3-4855-b1eb-8297-540de5147d73" : {
                  "sizeX" : 148,
                  "sizeY" : 15,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 148,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 148,
                "viewFormat" : "grid",
                "autoFillHeight" : false,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              }
            }
          }
        },
        "device_alarm_filter_2nd_part" : {
          "name" : "device_alarm_filter_2nd_part",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "dd29a6ca-371e-6cea-2180-fd58601b2988" : {
                  "sizeX" : 24,
                  "sizeY" : 2,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%"
              }
            }
          }
        },
        "settings" : {
          "name" : "Ajustes",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                  "sizeX" : 4,
                  "sizeY" : 13,
                  "row" : 0,
                  "col" : 0
                },
                "1861e9c6-bae1-a8a3-7e94-93d749fe31c9" : {
                  "sizeX" : 8,
                  "sizeY" : 2,
                  "row" : 0,
                  "col" : 4
                },
                "5dea708c-1e29-d7c3-6a10-5867d7c259ac" : {
                  "sizeX" : 8,
                  "sizeY" : 1,
                  "row" : 2,
                  "col" : 4
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%"
              }
            }
          }
        },
        "pozo_details" : {
          "name" : "Detalles: ${entityLabel}",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                  "sizeX" : 14,
                  "sizeY" : 44,
                  "row" : 0,
                  "col" : 0
                },
                "469cfc0a-f34d-07b5-e417-97d93dab3d84" : {
                  "sizeX" : 61,
                  "sizeY" : 4,
                  "row" : 0,
                  "col" : 14
                },
                "cde8dc17-56b4-08f2-8a43-c1e53244b986" : {
                  "sizeX" : 51,
                  "sizeY" : 29,
                  "mobileHeight" : null,
                  "row" : 4,
                  "col" : 24
                },
                "8d39ab28-b058-493f-38d3-52512c31042c" : {
                  "sizeX" : 10,
                  "sizeY" : 8,
                  "row" : 12,
                  "col" : 14
                },
                "ba33a64d-74d2-e8d7-8d0e-ee2e2d10d17c" : {
                  "sizeX" : 10,
                  "sizeY" : 9,
                  "row" : 20,
                  "col" : 14
                },
                "fa593b45-ec47-29c1-96b2-7a2a886f9c3f" : {
                  "sizeX" : 10,
                  "sizeY" : 8,
                  "resizable" : true,
                  "row" : 4,
                  "col" : 14
                },
                "208c634c-f5bd-f809-dc5e-ed4259f13f90" : {
                  "sizeX" : 10,
                  "sizeY" : 4,
                  "row" : 29,
                  "col" : 14
                },
                "a5a088e4-be2c-4ed4-c329-7ee102dface0" : {
                  "sizeX" : 14,
                  "sizeY" : 2,
                  "row" : 44,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 64,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 64,
                "viewFormat" : "grid",
                "autoFillHeight" : false,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              },
              "breakpoints" : {
                "xs" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 64,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "minColumns" : 64,
                    "viewFormat" : "list",
                    "autoFillHeight" : false,
                    "rowHeight" : 70,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "469cfc0a-f34d-07b5-e417-97d93dab3d84" : {
                      "sizeX" : 64,
                      "sizeY" : 4,
                      "row" : 0,
                      "col" : 11,
                      "resizable" : true,
                      "mobileOrder" : 1
                    },
                    "cde8dc17-56b4-08f2-8a43-c1e53244b986" : {
                      "sizeX" : 54,
                      "sizeY" : 27,
                      "mobileHeight" : null,
                      "row" : 4,
                      "col" : 21,
                      "resizable" : true,
                      "mobileOrder" : 5
                    },
                    "8d39ab28-b058-493f-38d3-52512c31042c" : {
                      "sizeX" : 10,
                      "sizeY" : 8,
                      "row" : 12,
                      "col" : 11,
                      "resizable" : true,
                      "mobileOrder" : 3
                    },
                    "ba33a64d-74d2-e8d7-8d0e-ee2e2d10d17c" : {
                      "sizeX" : 10,
                      "sizeY" : 8,
                      "row" : 20,
                      "col" : 11,
                      "resizable" : true,
                      "mobileOrder" : 4
                    },
                    "fa593b45-ec47-29c1-96b2-7a2a886f9c3f" : {
                      "sizeX" : 10,
                      "sizeY" : 8,
                      "resizable" : true,
                      "row" : 4,
                      "col" : 11,
                      "mobileOrder" : 2
                    },
                    "208c634c-f5bd-f809-dc5e-ed4259f13f90" : {
                      "sizeX" : 10,
                      "sizeY" : 3,
                      "row" : 28,
                      "col" : 11
                    }
                  }
                },
                "lg" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 64,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "minColumns" : 64,
                    "viewFormat" : "grid",
                    "autoFillHeight" : false,
                    "rowHeight" : 70,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "35346681-a6d0-f40e-e68f-4998d0978a2e" : {
                      "sizeX" : 13,
                      "sizeY" : 44,
                      "row" : 0,
                      "col" : 0
                    },
                    "469cfc0a-f34d-07b5-e417-97d93dab3d84" : {
                      "sizeX" : 62,
                      "sizeY" : 4,
                      "row" : 0,
                      "col" : 13
                    },
                    "cde8dc17-56b4-08f2-8a43-c1e53244b986" : {
                      "sizeX" : 52,
                      "sizeY" : 29,
                      "mobileHeight" : null,
                      "row" : 4,
                      "col" : 23
                    },
                    "8d39ab28-b058-493f-38d3-52512c31042c" : {
                      "sizeX" : 10,
                      "sizeY" : 8,
                      "row" : 12,
                      "col" : 13
                    },
                    "ba33a64d-74d2-e8d7-8d0e-ee2e2d10d17c" : {
                      "sizeX" : 10,
                      "sizeY" : 9,
                      "row" : 20,
                      "col" : 13
                    },
                    "fa593b45-ec47-29c1-96b2-7a2a886f9c3f" : {
                      "sizeX" : 10,
                      "sizeY" : 8,
                      "resizable" : true,
                      "row" : 4,
                      "col" : 13
                    },
                    "208c634c-f5bd-f809-dc5e-ed4259f13f90" : {
                      "sizeX" : 10,
                      "sizeY" : 4,
                      "row" : 29,
                      "col" : 13
                    },
                    "a5a088e4-be2c-4ed4-c329-7ee102dface0" : {
                      "sizeX" : 15,
                      "sizeY" : 3,
                      "row" : 44,
                      "col" : 0
                    }
                  }
                }
              }
            }
          }
        },
        "pozo_settings" : {
          "name" : "Ajustes dispositivo",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "11cd269e-acda-5149-8172-fa668b33a6a7" : {
                  "sizeX" : 29,
                  "sizeY" : 29,
                  "resizable" : true,
                  "row" : 0,
                  "col" : 0
                },
                "6c82e300-6a83-31c4-d952-fdf3bfd9d0af" : {
                  "sizeX" : 35,
                  "sizeY" : 29,
                  "preserveAspectRatio" : false,
                  "resizable" : true,
                  "row" : 0,
                  "col" : 29
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#FFFFFF",
                "columns" : 64,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 64,
                "viewFormat" : "grid",
                "autoFillHeight" : true,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              },
              "breakpoints" : {
                "xs" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#FFFFFF",
                    "columns" : 64,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "minColumns" : 64,
                    "viewFormat" : "list",
                    "autoFillHeight" : false,
                    "rowHeight" : 50,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "11cd269e-acda-5149-8172-fa668b33a6a7" : {
                      "sizeX" : 29,
                      "sizeY" : 29,
                      "resizable" : true,
                      "row" : 0,
                      "col" : 0
                    },
                    "6c82e300-6a83-31c4-d952-fdf3bfd9d0af" : {
                      "sizeX" : 35,
                      "sizeY" : 29,
                      "preserveAspectRatio" : false,
                      "resizable" : true,
                      "row" : 0,
                      "col" : 29,
                      "mobileOrder" : 1,
                      "mobileHeight" : 7
                    }
                  }
                }
              }
            }
          }
        },
        "edit_location" : {
          "name" : "Editar ubicaciÃ³n",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "529e636b-2124-578c-82c5-ff8da2204bf4" : {
                  "sizeX" : 24,
                  "sizeY" : 8,
                  "resizable" : true,
                  "row" : 4,
                  "col" : 0
                },
                "7aa81012-5fbf-6868-e0c5-751660c8806c" : {
                  "sizeX" : 24,
                  "sizeY" : 4,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#FFFFFF",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 24,
                "viewFormat" : "grid",
                "autoFillHeight" : true,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              }
            }
          }
        },
        "edit_location_all" : {
          "name" : "Editar ubicaciones de los sensores",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "6880b58b-e64a-fc38-05a4-8fa5ca17acac" : {
                  "sizeX" : 24,
                  "sizeY" : 12,
                  "resizable" : true,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#FFFFFF",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 24,
                "viewFormat" : "grid",
                "autoFillHeight" : true,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              }
            }
          }
        },
        "map_mobile" : {
          "name" : "Mapa",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "27f9305b-910e-3990-03b3-13f904b50700" : {
                  "sizeX" : 24,
                  "sizeY" : 10,
                  "resizable" : true,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%"
              },
              "breakpoints" : {
                "xs" : {
                  "gridSettings" : {
                    "layoutType" : "default",
                    "backgroundColor" : "#eeeeee",
                    "columns" : 24,
                    "margin" : 10,
                    "outerMargin" : true,
                    "backgroundSizeMode" : "100%",
                    "viewFormat" : "list",
                    "rowHeight" : 70,
                    "autoFillHeight" : true,
                    "minColumns" : 24,
                    "backgroundImageUrl" : null,
                    "mobileAutoFillHeight" : false,
                    "mobileRowHeight" : 70
                  },
                  "widgets" : {
                    "15c2dc8b-53bd-2250-0ad0-a90b99dc08cb" : {
                      "sizeX" : 10,
                      "sizeY" : 9,
                      "resizable" : true,
                      "row" : 0,
                      "col" : 0
                    }
                  }
                }
              }
            }
          }
        },
        "set_field_perimeter" : {
          "name" : "set field perimeter",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "b0aea088-616d-2f48-61d1-7efd74846d49" : {
                  "sizeX" : 24,
                  "sizeY" : 12,
                  "resizable" : true,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 24,
                "viewFormat" : "grid",
                "autoFillHeight" : true,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              }
            }
          }
        },
        "deviceSummary" : {
          "name" : "Resumen General",
          "root" : false,
          "layouts" : {
            "main" : {
              "widgets" : {
                "a1a9e001-a144-0878-d695-aae0affe8182" : {
                  "sizeX" : 24,
                  "sizeY" : 18,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "layoutType" : "default",
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%",
                "minColumns" : 24,
                "viewFormat" : "grid",
                "autoFillHeight" : true,
                "rowHeight" : 70,
                "backgroundImageUrl" : null,
                "mobileAutoFillHeight" : false,
                "mobileRowHeight" : 70
              }
            }
          }
        }
      },
      "entityAliases" : {
        "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2" : {
          "id" : "13e2cae3-ea9e-26ce-f5d8-e14167e38ab2",
          "alias" : "customerDevices",
          "filter" : {
            "type" : "entityType",
            "resolveMultiple" : true,
            "entityType" : "DEVICE"
          }
        },
        "e2c3a2c3-e8dc-e950-2715-6bf0c6bf0d57" : {
          "id" : "e2c3a2c3-e8dc-e950-2715-6bf0c6bf0d57",
          "alias" : "Customers",
          "filter" : {
            "type" : "singleEntity",
            "resolveMultiple" : false,
            "singleEntity" : {
              "entityType" : "CURRENT_CUSTOMER",
              "id" : "7810e4c0-45cd-11ef-bcb7-976e94e2a809"
            }
          }
        },
        "cc632199-91cf-d1c5-f43e-5f1f6a6d9bf4" : {
          "id" : "cc632199-91cf-d1c5-f43e-5f1f6a6d9bf4",
          "alias" : "Current Customer",
          "filter" : {
            "type" : "singleEntity",
            "resolveMultiple" : false,
            "singleEntity" : {
              "entityType" : "CURRENT_CUSTOMER",
              "id" : "0d4eee10-7a34-11f0-bbbd-d5b23296cf03"
            }
          }
        },
        "faca9a03-d526-e45a-69d7-e2dd9d89930b" : {
          "id" : "faca9a03-d526-e45a-69d7-e2dd9d89930b",
          "alias" : "Tanks",
          "filter" : {
            "type" : "deviceType",
            "resolveMultiple" : true,
            "deviceTypes" : [ "Tank" ],
            "deviceNameFilter" : ""
          }
        },
        "c5728f69-c11d-5b71-9941-af192de00fbb" : {
          "id" : "c5728f69-c11d-5b71-9941-af192de00fbb",
          "alias" : "Current user",
          "filter" : {
            "type" : "singleEntity",
            "resolveMultiple" : false,
            "singleEntity" : {
              "entityType" : "CURRENT_USER",
              "id" : "13814000-1dd2-11b2-8080-808080808080"
            }
          }
        },
        "6b08fb94-54f4-49d9-5a8c-9409e66b8970" : {
          "id" : "6b08fb94-54f4-49d9-5a8c-9409e66b8970",
          "alias" : "devActual",
          "filter" : {
            "type" : "stateEntity",
            "resolveMultiple" : false,
            "stateEntityParamName" : null,
            "defaultStateEntity" : null
          }
        },
        "4db0de46-9963-11ff-d3dc-63bf8867bbd7" : {
          "id" : "4db0de46-9963-11ff-d3dc-63bf8867bbd7",
          "alias" : "campoCliente",
          "filter" : {
            "type" : "assetType",
            "resolveMultiple" : true,
            "assetTypes" : [ "Root Property" ],
            "assetNameFilter" : ""
          }
        }
      },
      "filters" : {
        "57cfdb2e-dc93-4507-b68f-c3c446e205bc" : {
          "id" : "57cfdb2e-dc93-4507-b68f-c3c446e205bc",
          "filter" : "Ultrasonicos",
          "keyFilters" : [ {
            "key" : {
              "type" : "ENTITY_FIELD",
              "key" : "type"
            },
            "valueType" : "STRING",
            "predicates" : [ {
              "keyFilterPredicate" : {
                "operation" : "STARTS_WITH",
                "value" : {
                  "defaultValue" : "Ultrasonic",
                  "dynamicValue" : null
                },
                "ignoreCase" : false,
                "type" : "STRING"
              },
              "userInfo" : {
                "editable" : true,
                "label" : "",
                "autogeneratedLabel" : true,
                "order" : 0,
                "unit" : ""
              }
            } ]
          } ],
          "editable" : false
        },
        "50be9efa-7b06-c731-f543-aff20c73c420" : {
          "id" : "50be9efa-7b06-c731-f543-aff20c73c420",
          "filter" : "Tanks filter",
          "keyFilters" : [ {
            "key" : {
              "type" : "ENTITY_FIELD",
              "key" : "type"
            },
            "valueType" : "STRING",
            "predicates" : [ {
              "keyFilterPredicate" : {
                "operation" : "OR",
                "predicates" : [ {
                  "keyFilterPredicate" : {
                    "operation" : "EQUAL",
                    "value" : {
                      "defaultValue" : "Ultrasonico",
                      "dynamicValue" : {
                        "sourceType" : "CURRENT_USER",
                        "sourceAttribute" : "Ultrasonico",
                        "inherit" : false
                      }
                    },
                    "ignoreCase" : true,
                    "type" : "STRING"
                  },
                  "userInfo" : {
                    "editable" : true,
                    "label" : "",
                    "autogeneratedLabel" : true,
                    "order" : 0,
                    "unit" : ""
                  }
                }, {
                  "keyFilterPredicate" : {
                    "operation" : "EQUAL",
                    "value" : {
                      "defaultValue" : "Freatimetro",
                      "dynamicValue" : {
                        "sourceType" : "CURRENT_USER",
                        "sourceAttribute" : "Freatimetro",
                        "inherit" : false
                      }
                    },
                    "ignoreCase" : true,
                    "type" : "STRING"
                  },
                  "userInfo" : {
                    "editable" : true,
                    "label" : "",
                    "autogeneratedLabel" : true,
                    "order" : 0,
                    "unit" : ""
                  }
                }, {
                  "keyFilterPredicate" : {
                    "operation" : "EQUAL",
                    "value" : {
                      "defaultValue" : "Comedero",
                      "dynamicValue" : {
                        "sourceType" : "CURRENT_USER",
                        "sourceAttribute" : "Comedero",
                        "inherit" : false
                      }
                    },
                    "ignoreCase" : true,
                    "type" : "STRING"
                  },
                  "userInfo" : {
                    "editable" : true,
                    "label" : "",
                    "autogeneratedLabel" : true,
                    "order" : 0,
                    "unit" : ""
                  }
                } ],
                "type" : "COMPLEX"
              },
              "userInfo" : {
                "editable" : true,
                "label" : "",
                "autogeneratedLabel" : true,
                "order" : 0,
                "unit" : ""
              }
            } ]
          } ],
          "editable" : false
        },
        "226fb4ee-b1fe-d1eb-9a64-5a79191d8b0a" : {
          "id" : "226fb4ee-b1fe-d1eb-9a64-5a79191d8b0a",
          "filter" : "deviceFilter",
          "keyFilters" : [ {
            "key" : {
              "type" : "CLIENT_ATTRIBUTE",
              "key" : "type"
            },
            "valueType" : "BOOLEAN",
            "predicates" : [ {
              "keyFilterPredicate" : {
                "operation" : "EQUAL",
                "value" : {
                  "defaultValue" : false,
                  "dynamicValue" : {
                    "sourceType" : "CURRENT_USER",
                    "sourceAttribute" : "Ultrasonico",
                    "inherit" : false
                  }
                },
                "type" : "BOOLEAN"
              },
              "userInfo" : {
                "editable" : true,
                "label" : "",
                "autogeneratedLabel" : true,
                "order" : 0,
                "unit" : ""
              }
            } ]
          } ],
          "editable" : true
        }
      },
      "timewindow" : {
        "displayValue" : "",
        "hideAggregation" : false,
        "hideAggInterval" : false,
        "hideTimezone" : false,
        "selectedTab" : 0,
        "realtime" : {
          "realtimeType" : 0,
          "interval" : 1000,
          "timewindowMs" : 60000,
          "quickInterval" : "CURRENT_DAY",
          "hideInterval" : false,
          "hideLastInterval" : false,
          "hideQuickInterval" : false
        },
        "history" : {
          "historyType" : 0,
          "interval" : 1000,
          "timewindowMs" : 60000,
          "fixedTimewindow" : {
            "startTimeMs" : 1758663697384,
            "endTimeMs" : 1758750097384
          },
          "quickInterval" : "CURRENT_DAY",
          "hideInterval" : false,
          "hideLastInterval" : false,
          "hideFixedInterval" : false,
          "hideQuickInterval" : false
        },
        "aggregation" : {
          "type" : "AVG",
          "limit" : 25000
        }
      },
      "settings" : {
        "stateControllerId" : "entity",
        "showTitle" : false,
        "showDashboardsSelect" : false,
        "showEntitiesSelect" : true,
        "showDashboardTimewindow" : false,
        "showDashboardExport" : false,
        "toolbarAlwaysOpen" : true,
        "titleColor" : "rgba(0,0,0,0.870588)",
        "showDashboardLogo" : true,
        "dashboardLogoUrl" : "tb-image;/api/images/tenant/logo_title_white_(1).png",
        "hideToolbar" : false,
        "showFilters" : false,
        "showUpdateDashboardImage" : false,
        "dashboardCss" : ".tb-widget-container > .tb-widget {\r\n  border-radius: 12px !important;\r\n  overflow: hidden;\r\n}\r\n.tb-powered-by-footer {\r\n  display: none !important;\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/* 1) Desactivar el autoscale por transform */\r\n.tb-widget .auto-scale,\r\n.tb-widget .tb-auto-scale,\r\n.tb-widget .value.auto-scale,\r\n.tb-widget .tb-value-auto-scale {\r\n  transform: none !important;\r\n  transform-origin: center !important;\r\n}\r\n\r\n/* 2) La tarjeta llena su alto y el contenido no se âachica de mÃ¡sâ */\r\n.tb-widget .mat-card, \r\n.tb-widget .tb-card,\r\n.tb-widget .mat-card-content,\r\n.tb-widget .tb-card-content {\r\n  height: 100%;\r\n}\r\n.tb-widget .mat-card-content,\r\n.tb-widget .tb-card-content {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between; /* o center */\r\n  gap: 12px;\r\n}\r\n\r\n/* 3) TipografÃ­a fluida (no se hace minÃºscula) */\r\n.tb-widget .tb-card-title,\r\n.tb-widget .mat-card-title,\r\n.tb-widget .title {\r\n  font-size: clamp(14px, 1.4vw, 18px) !important;\r\n  line-height: 1.2;\r\n}\r\n.tb-widget .value, \r\n.tb-widget .tb-card-value,\r\n.tb-widget .latest-value {\r\n  font-size: clamp(18px, 2.2vw, 32px) !important;\r\n  line-height: 1.1;\r\n  font-weight: 600;\r\n}\r\n\r\n/* 4) Bordes/espacios mÃ¡s sobrios (evita âmucho bordeâ al reducir) */\r\n.tb-widget .mat-card, \r\n.tb-widget .tb-card {\r\n  padding: clamp(8px, 1.2vw, 14px) !important;\r\n  border-radius: 12px;\r\n}\r\n"
      }
    },
    "name" : "Main TEST",
    "resources" : null,
    "assignedCustomers" : [ {
      "customerId" : {
        "entityType" : "CUSTOMER",
        "id" : "0d4eee10-7a34-11f0-bbbd-d5b23296cf03"
      },
      "title" : "Campo La Travesia",
      "public" : false
    } ],
    "externalId" : null,
    "id" : {
      "entityType" : "DASHBOARD",
      "id" : "3dbe2550-998f-11f0-b045-c1dbc0c3e378"
    }
  },
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}