{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "tasmota_mqtt_console2",
    "name" : "Tasmota MQTT Console",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "latest",
      "sizeX" : 4,
      "sizeY" : 2,
      "resources" : [ ],
      "templateHtml" : "<div class=\"console-wrap\">\r\n  <div class=\"row\">\r\n    <input class=\"cmd\"\r\n           placeholder=\"Command (e.g. TelePeriod 60 | TelePeriod | WebPassword xxxx)\"\r\n           [(ngModel)]=\"cmd\"\r\n           (keyup.enter)=\"send()\"/>\r\n    <button mat-raised-button color=\"primary\" (click)=\"send()\">Send</button>\r\n    <button mat-button (click)=\"clear()\">Clear</button>\r\n  </div>\r\n\r\n  <div class=\"hint\">\r\n    Sends one-way RPC via <code>controlApi.sendOneWayCommand()</code> using Gateway built-in <code>set</code>.\r\n  </div>\r\n\r\n  <pre class=\"log\">{{log}}</pre>\r\n</div>",
      "templateCss" : ".console-wrap {\r\n  height: 100%;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n}\r\n\r\n.row {\r\n  display: flex;\r\n  gap: 8px;\r\n  align-items: center;\r\n}\r\n\r\n.cmd {\r\n  flex: 1;\r\n  padding: 10px 12px;\r\n  border: 1px solid rgba(0,0,0,.2);\r\n  border-radius: 8px;\r\n  font-size: 14px;\r\n}\r\n\r\n.hint {\r\n  font-size: 12px;\r\n  opacity: 0.75;\r\n}\r\n\r\n.log {\r\n  flex: 1;\r\n  margin: 0;\r\n  padding: 12px;\r\n  border-radius: 10px;\r\n  background: rgba(0,0,0,.04);\r\n  overflow: auto;\r\n  white-space: pre-wrap;\r\n}",
      "controllerScript" : "self.onInit = function () {\r\n  self.ctx.$scope.cmd = \"\";\r\n  self.ctx.$scope.log = \"\";\r\n\r\n  function append(line) {\r\n    const ts = new Date().toISOString();\r\n    self.ctx.$scope.log = `[${ts}] ${line}\\n` + self.ctx.$scope.log;\r\n    self.ctx.detectChanges();\r\n  }\r\n\r\n  function safeEncodeValue(v) {\r\n    // No JSON. String plano. Escapamos ';' por si alguien lo mete en el valor.\r\n    return String(v).replace(/;/g, \"%3B\");\r\n  }\r\n\r\n  function parseUserInput(raw) {\r\n    // Soporta:\r\n    // - \"TelePeriod 35\"\r\n    // - \"TelePeriod=35\"\r\n    // - \"TelePeriod: 35\"\r\n    // - \"TelePeriod\" (GET)\r\n    const s = (raw || \"\").trim();\r\n    if (!s) return null;\r\n\r\n    let m = s.match(/^([^=:\\s]+)\\s*(?:=|:)\\s*(.*)$/);\r\n    if (m) {\r\n      return { cmd: (m[1] || \"\").trim(), value: (m[2] || \"\").trim() };\r\n    }\r\n\r\n    const parts = s.split(/\\s+/);\r\n    const cmd = (parts.shift() || \"\").trim();\r\n    const value = parts.join(\" \").trim(); // permite \"WebPassword pepe 123\"\r\n    return { cmd, value };\r\n  }\r\n\r\n  function buildGatewaySetParams(cmd, valueOrEmpty) {\r\n    // Si no hay valor => GET: tu Gateway requiere \" \" (espacio)\r\n    const v = (valueOrEmpty && valueOrEmpty.length) ? safeEncodeValue(valueOrEmpty) : \" \";\r\n    // IMPORTANTE: dejamos ${deviceName} literal para que lo resuelva el Gateway\r\n    return `requestTopicExpression=cmnd/\\${deviceName}/${cmd};value=${v};`;\r\n  }\r\n\r\n  self.ctx.$scope.clear = function () {\r\n    self.ctx.$scope.log = \"\";\r\n    self.ctx.detectChanges();\r\n  };\r\n\r\n  self.ctx.$scope.send = function () {\r\n    const timeout = (self.ctx.settings && self.ctx.settings.timeout) || 5000;\r\n\r\n    // Forzamos method set\r\n    const method = \"set\";\r\n\r\n    const raw = (self.ctx.$scope.cmd || \"\").trim();\r\n    if (!raw) {\r\n      append(\"Nothing to send.\");\r\n      return;\r\n    }\r\n\r\n    const parsed = parseUserInput(raw);\r\n    if (!parsed || !parsed.cmd) {\r\n      append(\"ERROR: Invalid input. Examples: 'TelePeriod 60' | 'TelePeriod' | 'WebPassword pepe'\");\r\n      return;\r\n    }\r\n\r\n    const cmd = parsed.cmd;\r\n    const value = parsed.value; // \"\" => GET\r\n    const params = buildGatewaySetParams(cmd, value);\r\n\r\n    if (value && value.length) {\r\n      append(`> ${method} ${cmd} ${value}`);\r\n    } else {\r\n      append(`> ${method} ${cmd} (GET)`);\r\n    }\r\n    append(`RAW: ${params}`);\r\n\r\n    const obs = self.ctx.controlApi.sendOneWayCommand(method, params, timeout);\r\n\r\n    obs.subscribe(\r\n      function () {\r\n        append(\"OK (command delivered to server). Check Tasmota RESULT/STATE telemetry for ACK.\");\r\n      },\r\n      function (rej) {\r\n        append(`ERROR: ${rej.status} ${rej.statusText || \"\"}`.trim());\r\n      }\r\n    );\r\n  };\r\n};",
      "dataKeySettingsForm" : [ ],
      "settingsDirective" : "tb-gpio-control-widget-settings",
      "defaultConfig" : "{\"targetDeviceAliases\":[],\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"parseGpioStatusFunction\":\"return body[pin] === true;\",\"gpioStatusChangeRequest\":{\"method\":\"setGpioStatus\",\"paramsBody\":\"{\\n   \\\"pin\\\": \\\"{$pin}\\\",\\n   \\\"enabled\\\": \\\"{$enabled}\\\"\\n}\"},\"requestTimeout\":500,\"switchPanelBackgroundColor\":\"#b71c1c\",\"gpioStatusRequest\":{\"method\":\"getGpioStatus\",\"paramsBody\":\"{}\"},\"gpioList\":[{\"pin\":1,\"label\":\"GPIO 1\",\"row\":0,\"col\":0,\"_uniqueKey\":0},{\"pin\":2,\"label\":\"GPIO 2\",\"row\":0,\"col\":1,\"_uniqueKey\":1},{\"pin\":3,\"label\":\"GPIO 3\",\"row\":1,\"col\":0,\"_uniqueKey\":2}]},\"title\":\"Tasmota MQTT Console\",\"datasources\":[],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}}}"
    },
    "externalId" : null,
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "5c170760-1423-11f1-8fce-55f815a3848a"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}