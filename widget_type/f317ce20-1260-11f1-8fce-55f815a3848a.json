{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "testresumen",
    "name" : "testResumen",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "latest",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateHtml" : "<div class=\"cards-wrapper\">\r\n  <!-- Filtro (multi-check) -->\r\n  <div class=\"toolbar\">\r\n    <details class=\"tb-dd\" id=\"tbTypeDD\">\r\n      <summary class=\"tb-dd-btn\">Filtrar por tipo</summary>\r\n      <div class=\"tb-dd-panel\" id=\"tbTypePanel\"></div>\r\n    </details>\r\n    <div class=\"dd-backdrop\" id=\"tbTypeBackdrop\"></div>\r\n  </div>\r\n\r\n  <!-- Scroll -->\r\n  <div class=\"scroll\" id=\"tbCardsScroll\">\r\n    <div id=\"cards\" class=\"cards flex-container wrap\"></div>\r\n  </div>\r\n</div>",
      "templateCss" : "/* ===== WRAPPER & SCROLL ===== */\r\n.cards-wrapper{\r\n  height:100%;\r\n  width:100%;\r\n  display:flex;\r\n  flex-direction:column;\r\n  padding:0 10px;\r\n  box-sizing:border-box;\r\n}\r\n\r\n.scroll{\r\n  flex:1 1 auto;\r\n  min-height:0;\r\n  overflow:auto;\r\n}\r\n\r\n/* ===== LAYOUT (igual al MD original) ===== */\r\n.flex-container{\r\n  padding:0;\r\n  margin:0;\r\n  list-style:none;\r\n  display:flex;\r\n  flex-wrap:wrap;\r\n  align-items:stretch; /* misma altura en la fila */\r\n}\r\n\r\n.flex-item{\r\n  margin:10px;\r\n  flex:1 1 325px;\r\n  max-width:380px;\r\n  min-width:0;\r\n  box-sizing:border-box;\r\n}\r\n\r\n@media (max-width:640px){\r\n  .flex-item{ flex:1 1 100%; max-width:100%; }\r\n}\r\n\r\n/* ===== CARD ===== */\r\n.card{\r\n  position:relative;\r\n  border-radius:12px;\r\n  overflow:hidden;\r\n  background:#fff;\r\n  border:1px solid rgba(0,0,0,.08);\r\n  box-shadow:0 4px 8px rgba(0,0,0,.12);\r\n  display:flex;\r\n  flex-direction:column;\r\n  height:100%;\r\n}\r\n\r\n/* ===== ALARM DEGRADE (SIN BORDE) ===== */\r\n.card::before{\r\n  content:\"\";\r\n  position:absolute;\r\n  inset:0;\r\n  pointer-events:none;\r\n  opacity:0;\r\n  transition:opacity .15s ease;\r\n}\r\n\r\n.card[data-sev]:not([data-sev=\"off\"])::before{\r\n  opacity:1;\r\n}\r\n\r\n.card[data-sev=\"critical\"]::before{\r\n  background:linear-gradient(180deg, rgba(239,68,68,.20) 0%, rgba(255,255,255,0) 55%);\r\n}\r\n.card[data-sev=\"major\"]::before{\r\n  background:linear-gradient(180deg, rgba(249,115,22,.20) 0%, rgba(255,255,255,0) 55%);\r\n}\r\n.card[data-sev=\"minor\"]::before{\r\n  background:linear-gradient(180deg, rgba(245,158,11,.20) 0%, rgba(255,255,255,0) 55%);\r\n}\r\n.card[data-sev=\"warning\"]::before{\r\n  background:linear-gradient(180deg, rgba(234,179,8,.20) 0%, rgba(255,255,255,0) 55%);\r\n}\r\n.card[data-sev=\"indeterminate\"]::before{\r\n  background:linear-gradient(180deg, rgba(100,116,139,.18) 0%, rgba(255,255,255,0) 55%);\r\n}\r\n\r\n/* ===== CONTENT ===== */\r\n.content{\r\n  position:relative;\r\n  z-index:1;\r\n  padding:16px;\r\n  flex:1 1 auto;\r\n}\r\n\r\n/* ===== TITLE ===== */\r\n.device-title{\r\n  margin:0 0 6px 0;\r\n  text-align:center;\r\n  line-height:1.2;\r\n  font-weight:700;\r\n}\r\n\r\n.device-title.title--xl{font-size:1.6rem;}\r\n.device-title.title--lg{font-size:1.4rem;}\r\n.device-title.title--md{font-size:1.2rem;}\r\n.device-title.title--sm{font-size:1.05rem;}\r\n.device-title.title--xs{font-size:0.95rem;}\r\n\r\n/* ===== CHIPS ===== */\r\n.chips{\r\n  display:flex;\r\n  justify-content:center;\r\n  gap:8px;\r\n  margin-bottom:12px;\r\n  flex-wrap:wrap;\r\n}\r\n\r\n.chip{\r\n  border-radius:6px;\r\n  padding:2px 6px;\r\n  font-size:.85rem;\r\n  font-weight:600;\r\n  background:#e2e8f0;\r\n  color:#334155;\r\n  font-style:italic;\r\n}\r\n\r\n.chip--sev{\r\n  font-style:normal;\r\n  font-weight:800;\r\n}\r\n\r\n.sev--critical{ background:#fee2e2; color:#991b1b; }\r\n.sev--major{ background:#ffedd5; color:#9a3412; }\r\n.sev--minor{ background:#fef3c7; color:#92400e; }\r\n.sev--warning{ background:#fef9c3; color:#854d0e; }\r\n.sev--indeterminate{ background:#e2e8f0; color:#334155; }\r\n\r\n/* ===== DATA ROWS ===== */\r\n.info-block{\r\n  margin-top:6px;\r\n}\r\n\r\n.kv{\r\n  display:flex;\r\n  justify-content:space-between;\r\n  align-items:baseline;\r\n  margin:6px 0;\r\n}\r\n\r\n.kv .k{\r\n  font-size:.9rem;\r\n  color:#6b7280;\r\n}\r\n\r\n.kv .v{\r\n  font-size:.95rem;\r\n  font-weight:700;\r\n  color:#111827;\r\n  text-align:right;\r\n}\r\n\r\n/* ===== BUTTON (igual al original) ===== */\r\n.card-buttons{\r\n  border-top:1px solid #e6e6e6;\r\n  background:#fff;\r\n}\r\n\r\n.button{\r\n  background:#f3f4f6;\r\n  color:#374151;\r\n  width:100%;\r\n  height:50px;\r\n  border:0;\r\n  display:flex;\r\n  align-items:center;\r\n  justify-content:center;\r\n  font-weight:600;\r\n  text-transform:uppercase;\r\n  cursor:pointer;\r\n  transition:background-color .15s ease, transform .08s ease;\r\n}\r\n\r\n.button:hover{\r\n  background:#e5e7eb;\r\n  transform:translateY(-1px);\r\n}\r\n\r\n/* ===== TOOLBAR (TRANSPARENTE) ===== */\r\n.toolbar{\r\n  display:flex;\r\n  align-items:flex-start;\r\n  justify-content:flex-start;\r\n  gap:10px;\r\n  padding:10px 0 8px 0;\r\n  background:transparent;\r\n}\r\n\r\n/* =======================\r\n   Dropdown de filtros (como el MD/HTML anterior)\r\n   ======================= */\r\n.tb-dd{ position:relative; display:inline-block; }\r\n\r\n/* Botón */\r\n.tb-dd-btn{\r\n  list-style:none;\r\n  cursor:pointer;\r\n  padding:12px 16px;\r\n  background:#fff;\r\n  border:1px solid #e5e7eb;\r\n  border-radius:10px;\r\n  color:#0f172a;\r\n  font-weight:800;\r\n  font-size:14.5px;\r\n  line-height:1;\r\n  box-shadow:0 2px 6px rgba(0,0,0,.05);\r\n  display:inline-flex;\r\n  align-items:center;\r\n  gap:10px;\r\n}\r\n.tb-dd-btn::-webkit-details-marker{ display:none; }\r\n\r\n.tb-dd-btn::after{\r\n  content:\"\";\r\n  width:0;height:0;\r\n  border-left:5px solid transparent;\r\n  border-right:5px solid transparent;\r\n  border-top:6px solid #6b7280;\r\n  transition:transform .15s ease;\r\n}\r\n.tb-dd[open] .tb-dd-btn::after{ transform:rotate(180deg); }\r\n\r\n/* Panel */\r\n.tb-dd-panel{\r\n  position:absolute;\r\n  z-index:10000;\r\n  min-width:300px;\r\n  padding:12px;\r\n  margin-top:6px;\r\n  background:#fff;\r\n  border:1px solid #e5e7eb;\r\n  border-radius:12px;\r\n  box-shadow:0 12px 24px rgba(0,0,0,.10);\r\n}\r\n.tb-dd-panel .grid{\r\n  display:grid;\r\n  grid-template-columns:repeat(auto-fill,minmax(170px,1fr));\r\n  gap:10px 14px;\r\n}\r\n\r\n/* Opción */\r\n.tb-dd-opt{\r\n  display:flex;\r\n  align-items:center;\r\n  gap:12px;\r\n  padding:10px 12px;\r\n  border-radius:10px;\r\n  transition:background-color .12s ease;\r\n}\r\n.tb-dd-opt:hover{ background:#f8fafc; }\r\n\r\n/* Ocultar checkbox nativo */\r\n.tb-dd-opt input[type=\"checkbox\"]{\r\n  appearance:none; -webkit-appearance:none;\r\n  position:absolute;\r\n  width:1px; height:1px;\r\n  overflow:hidden;\r\n  clip:rect(0 0 0 0);\r\n}\r\n\r\n/* Casilla visual */\r\n.tb-dd-check{\r\n  width:20px; height:20px;\r\n  border:2px solid #cbd5e1;\r\n  border-radius:6px;\r\n  background:#fff;\r\n  display:inline-flex;\r\n  align-items:center;\r\n  justify-content:center;\r\n  transition:border-color .15s ease, background-color .15s ease, box-shadow .15s ease;\r\n  position:relative;\r\n}\r\n.tb-dd-check .tick{\r\n  width:8px; height:12px;\r\n  border-right:3px solid transparent;\r\n  border-bottom:3px solid transparent;\r\n  transform:rotate(45deg) scale(0.8);\r\n  transition:transform .12s ease;\r\n}\r\n\r\n.tb-dd-opt input[type=\"checkbox\"]:checked + .tb-dd-check{\r\n  background:#2563eb;\r\n  border-color:#2563eb;\r\n  box-shadow:0 0 0 2px rgba(37,99,235,.15);\r\n}\r\n.tb-dd-opt input[type=\"checkbox\"]:checked + .tb-dd-check .tick{\r\n  border-right-color:#fff;\r\n  border-bottom-color:#fff;\r\n  transform:rotate(45deg) scale(1);\r\n}\r\n\r\n.tb-dd-text{\r\n  font-size:14.5px;\r\n  color:#0f172a;\r\n  font-weight:650;\r\n}\r\n\r\n/* Backdrop para cerrar al click afuera */\r\n.dd-backdrop{\r\n  display:none;\r\n  position:fixed;\r\n  inset:0;\r\n  background:transparent;\r\n  z-index:9999;\r\n}\r\n\r\n.tb-dd-btn:focus-visible,\r\n.tb-dd-opt:focus-within{\r\n  outline:none;\r\n  box-shadow:0 0 0 3px rgba(37,99,235,.35);\r\n}\r\n\r\n@media (max-width:640px){\r\n  .tb-dd-panel{ right:0; min-width:240px; }\r\n}\r\n\r\n/* ===== TYPE UNDER TITLE ===== */\r\n.device-subtitle{\r\n  margin:0 0 10px 0;\r\n  text-align:center;\r\n  font-size:.95rem;\r\n  font-weight:750;\r\n  color:#475569;\r\n}\r\n\r\n/* ===== IMPORTANT: evita “huecos raros” en flex ===== */\r\n.flex-container{\r\n  justify-content:flex-start;\r\n  align-content:flex-start;\r\n}",
      "controllerScript" : "/* =========================\r\n   Custom Widget JS (ROBUSTO + FILTRO MULTI)\r\n   - visibleKeys (minúscula) = JSON object { key:{label,unit} }\r\n   - alarm_severity + alarm_type\r\n   - Tipo (superset key \"Tipo\") para mostrar y filtrar\r\n========================= */\r\n\r\nself.onInit = function () {\r\n  var root = (self.ctx && self.ctx.$container && self.ctx.$container[0]) ? self.ctx.$container[0] : document;\r\n\r\n  self.$cards   = root.querySelector('#cards');\r\n  self.$scroll  = root.querySelector('#tbCardsScroll');\r\n\r\n  self.$dd      = root.querySelector('#tbTypeDD');\r\n  self.$panel   = root.querySelector('#tbTypePanel');\r\n  self.$backdrop= root.querySelector('#tbTypeBackdrop');\r\n\r\n  self._scrollTop = 0;\r\n  self._uid = 'u' + Math.random().toString(36).slice(2,8);\r\n\r\n  // estado del filtro: set de tipos activos (lc)\r\n  self._activeTypes = null; // null => “todos”\r\n  self._typesLcSorted = [];\r\n  self._typeDisplayByLc = {};\r\n\r\n  if (!self.$cards) {\r\n    console.log('[widget] No encuentro #cards en el HTML');\r\n    return;\r\n  }\r\n\r\n  // Toggle backdrop cuando abre/cierra\r\n  if (self.$dd && self.$backdrop) {\r\n    self.$dd.addEventListener('toggle', function(){\r\n      self.$backdrop.style.display = self.$dd.open ? 'block' : 'none';\r\n    });\r\n    self.$backdrop.addEventListener('click', function(){\r\n      self.$dd.removeAttribute('open');\r\n      self.$backdrop.style.display = 'none';\r\n    });\r\n  }\r\n\r\n  // Delegación de eventos del panel (una sola vez)\r\n  if (self.$panel) {\r\n    self.$panel.addEventListener('change', function(e){\r\n      onFilterPanelEvent(e);\r\n    });\r\n    self.$panel.addEventListener('input', function(e){\r\n      onFilterPanelEvent(e);\r\n    });\r\n  }\r\n};\r\n\r\nself.onDataUpdated = function () {\r\n  if (!self.$cards) return;\r\n\r\n  if (self.$scroll) self._scrollTop = self.$scroll.scrollTop || 0;\r\n\r\n  try {\r\n    var devices = buildDevicesFromCtx();\r\n\r\n    // sort: severidad + label\r\n    devices.sort(function(a,b){\r\n      var ra = severityRank(a.alarm_severity);\r\n      var rb = severityRank(b.alarm_severity);\r\n      if (ra !== rb) return ra - rb;\r\n\r\n      var la = (a.label || '').toLowerCase();\r\n      var lb = (b.label || '').toLowerCase();\r\n      if (la < lb) return -1;\r\n      if (la > lb) return 1;\r\n      return 0;\r\n    });\r\n\r\n    // render cards (SIN wrapper extra)\r\n    self.$cards.innerHTML = renderHtml(devices);\r\n\r\n    // construir / actualizar filtro (tipos)\r\n    buildTypeIndex(devices);\r\n    renderFilterPanel();\r\n\r\n    // aplicar filtro actual (si ya había selección)\r\n    applyFilterToDom();\r\n\r\n  } catch (e) {\r\n    console.log('[widget] render error:', e);\r\n    self.$cards.innerHTML = '<div style=\"padding:12px;color:#b91c1c;font-weight:700;\">Widget error. Mirá la consola.</div>';\r\n  }\r\n\r\n  if (self.$scroll) {\r\n    requestAnimationFrame(function(){\r\n      requestAnimationFrame(function(){\r\n        self.$scroll.scrollTop = self._scrollTop || 0;\r\n      });\r\n    });\r\n  }\r\n};\r\n\r\n/* ---------- Helpers ---------- */\r\nfunction esc(s){\r\n  s = (s==null) ? '' : String(s);\r\n  return s.replace(/&/g,'&amp;')\r\n          .replace(/</g,'&lt;')\r\n          .replace(/>/g,'&gt;')\r\n          .replace(/\"/g,'&quot;');\r\n}\r\n\r\nfunction lcTrim(s){\r\n  return String(s || '').replace(/^\\s+|\\s+$/g,'').toLowerCase();\r\n}\r\n\r\nfunction getEntityId(ds){\r\n  if (!ds) return null;\r\n  var e = ds.entityId;\r\n  if (!e) return null;\r\n  if (typeof e === 'string') return e;\r\n  if (typeof e === 'object') return e.id || e.entityId || e;\r\n  return null;\r\n}\r\n\r\nfunction getLastValueFromSeries(series){\r\n  if (!Array.isArray(series) || !series.length) return undefined;\r\n  var last = series[series.length - 1];\r\n  return Array.isArray(last) ? last[1] : last;\r\n}\r\n\r\nfunction parseObj(raw){\r\n  if (raw == null) return null;\r\n  if (typeof raw === 'object') return raw;\r\n  var s = String(raw).trim();\r\n  if (!s) return null;\r\n  try {\r\n    var o = JSON.parse(s);\r\n    return (o && typeof o === 'object') ? o : null;\r\n  } catch(e){ return null; }\r\n}\r\n\r\nfunction fmtValue(v){\r\n  if (v == null || v === '') return 'N/A';\r\n  var num = Number(v);\r\n  if (!isNaN(num) && v !== true && v !== false) {\r\n    if (Math.abs(num) >= 100) return String(Math.round(num));\r\n    if (Math.abs(num) >= 10)  return num.toFixed(1);\r\n    return num.toFixed(2);\r\n  }\r\n  return String(v);\r\n}\r\n\r\nfunction severityRank(sev){\r\n  sev = String(sev||'off').trim().toLowerCase();\r\n  if (!sev || sev==='off' || sev==='false' || sev==='none' || sev==='0') return 999;\r\n  var map = { critical:0, major:1, minor:2, warning:3, indeterminate:4 };\r\n  return (sev in map) ? map[sev] : 5;\r\n}\r\n\r\nfunction isAlarmActive(sev){\r\n  sev = String(sev||'off').trim().toLowerCase();\r\n  return !!(sev && sev!=='off' && sev!=='false' && sev!=='none' && sev!=='0');\r\n}\r\n\r\n/* ---------- Tipo (map opcional) ---------- */\r\nvar customTypeMap = {\r\n  'ultrasonico': 'Aguada',\r\n  'estmeteo': 'Estación meteo',\r\n  'freatimetro': 'Freatímetro',\r\n  'pozo': 'Pozo',\r\n  'comedero': 'Comedero',\r\n  'lanza': 'Lanza'\r\n};\r\nfunction getDisplayType(raw){\r\n  var lc = lcTrim(raw);\r\n  return customTypeMap[lc] || (String(raw || '').trim()) || 'default';\r\n}\r\n\r\n/* ---------- Build devices from ctx.data ---------- */\r\nfunction buildDevicesFromCtx(){\r\n  var ctxData = (self.ctx && Array.isArray(self.ctx.data)) ? self.ctx.data : [];\r\n  var byId = {};\r\n\r\n  for (var i=0; i<ctxData.length; i++){\r\n    var item = ctxData[i];\r\n    if (!item || !item.datasource || !item.dataKey) continue;\r\n\r\n    var ds = item.datasource;\r\n    var id = getEntityId(ds);\r\n    if (!id) continue;\r\n\r\n    if (!byId[id]) {\r\n      byId[id] = {\r\n        id: id,\r\n        label: ds.entityLabel || ds.entityName || id,\r\n        values: {},\r\n        visibleKeys: null,\r\n        alarm_severity: 'off',\r\n        alarm_type: '',\r\n        typeRaw: '',\r\n        typeLc: ''\r\n      };\r\n    }\r\n\r\n    var keyName = item.dataKey.name;\r\n    var val = getLastValueFromSeries(item.data);\r\n\r\n    if (keyName === 'visibleKeys') { byId[id].visibleKeys = parseObj(val); continue; }\r\n    if (keyName === 'alarm_severity') { byId[id].alarm_severity = val; continue; }\r\n    if (keyName === 'alarm_type') { byId[id].alarm_type = val; continue; }\r\n\r\n    // Tipo (superset key)\r\n    if (keyName === 'Tipo' || keyName === 'tipo' || keyName === 'type' || keyName === 'deviceType') {\r\n      byId[id].typeRaw = (val == null ? '' : String(val));\r\n      byId[id].typeLc = lcTrim(byId[id].typeRaw);\r\n      continue;\r\n    }\r\n\r\n    byId[id].values[keyName] = val;\r\n  }\r\n\r\n  var out = [];\r\n  for (var k in byId) out.push(byId[k]);\r\n  return out;\r\n}\r\n\r\n/* ---------- Index de tipos + panel ---------- */\r\nfunction buildTypeIndex(devices){\r\n  var map = {}; // lc -> display\r\n  for (var i=0; i<devices.length; i++){\r\n    var lc = String(devices[i].typeLc || '');\r\n    if (!lc) lc = 'default';\r\n    if (!map.hasOwnProperty(lc)) map[lc] = getDisplayType(devices[i].typeRaw);\r\n  }\r\n\r\n  var keys = Object.keys(map).sort(function(a,b){\r\n    var la = String(map[a]||a).toLowerCase();\r\n    var lb = String(map[b]||b).toLowerCase();\r\n    if (la < lb) return -1;\r\n    if (la > lb) return 1;\r\n    return 0;\r\n  });\r\n\r\n  self._typeDisplayByLc = map;\r\n  self._typesLcSorted = keys;\r\n\r\n  // si no hay estado previo, default = todos activos\r\n  if (self._activeTypes == null) {\r\n    self._activeTypes = {};\r\n    for (var j=0; j<keys.length; j++) self._activeTypes[keys[j]] = true;\r\n  } else {\r\n    // mantener selección anterior pero limpiando tipos que ya no existen\r\n    var next = {};\r\n    for (var j2=0; j2<keys.length; j2++){\r\n      var k2 = keys[j2];\r\n      next[k2] = !!self._activeTypes[k2];\r\n    }\r\n    self._activeTypes = next;\r\n  }\r\n}\r\n\r\nfunction renderFilterPanel(){\r\n  if (!self.$panel) return;\r\n\r\n  var keys = self._typesLcSorted || [];\r\n  var map  = self._typeDisplayByLc || {};\r\n\r\n  // master checked si todos chequeados\r\n  var allChecked = true;\r\n  for (var i=0; i<keys.length; i++){\r\n    if (!self._activeTypes[keys[i]]) { allChecked = false; break; }\r\n  }\r\n\r\n  var html = '';\r\n  html += '<div class=\"grid\">';\r\n  html += optHtml('__master__', 'Seleccionar todo', allChecked, true);\r\n\r\n  for (var j=0; j<keys.length; j++){\r\n    var lc = keys[j];\r\n    var label = map[lc] || lc;\r\n    html += optHtml(lc, label, !!self._activeTypes[lc], false);\r\n  }\r\n  html += '</div>';\r\n\r\n  self.$panel.innerHTML = html;\r\n}\r\n\r\nfunction optHtml(lc, text, checked, isMaster){\r\n  return ''\r\n    + '<label class=\"tb-dd-opt\">'\r\n    +   '<input type=\"checkbox\" ' + (checked ? 'checked ' : '')\r\n    +          'data-role=\"'+(isMaster?'master':'type')+'\" '\r\n    +          'data-type=\"'+esc(lc)+'\">'\r\n    +   '<span class=\"tb-dd-check\"><span class=\"tick\"></span></span>'\r\n    +   '<span class=\"tb-dd-text\">'+esc(text)+'</span>'\r\n    + '</label>';\r\n}\r\n\r\nfunction onFilterPanelEvent(e){\r\n  if (!e || !e.target) return;\r\n  var role = e.target.getAttribute('data-role');\r\n  if (!role) return;\r\n\r\n  // master\r\n  if (role === 'master') {\r\n    var checked = !!e.target.checked;\r\n    var keys = self._typesLcSorted || [];\r\n    for (var i=0; i<keys.length; i++) self._activeTypes[keys[i]] = checked;\r\n\r\n    // reflejar checkboxes en UI\r\n    var boxes = self.$panel.querySelectorAll('input[type=checkbox][data-role=type]');\r\n    for (var b=0; b<boxes.length; b++) boxes[b].checked = checked;\r\n\r\n    applyFilterToDom();\r\n    return;\r\n  }\r\n\r\n  // type\r\n  if (role === 'type') {\r\n    var lc = String(e.target.getAttribute('data-type') || '');\r\n    self._activeTypes[lc] = !!e.target.checked;\r\n\r\n    // actualizar master\r\n    var allChecked = true;\r\n    var keys2 = self._typesLcSorted || [];\r\n    for (var k=0; k<keys2.length; k++){\r\n      if (!self._activeTypes[keys2[k]]) { allChecked = false; break; }\r\n    }\r\n    var master = self.$panel.querySelector('input[type=checkbox][data-role=master]');\r\n    if (master) master.checked = allChecked;\r\n\r\n    applyFilterToDom();\r\n  }\r\n}\r\n\r\nfunction applyFilterToDom(){\r\n  // si no hay tipos, nada\r\n  var keys = self._typesLcSorted || [];\r\n  if (!keys.length) return;\r\n\r\n  // si ninguno seleccionado => ocultar todo (como tu MD/HTML)\r\n  var active = [];\r\n  for (var i=0; i<keys.length; i++){\r\n    if (self._activeTypes[keys[i]]) active.push(keys[i]);\r\n  }\r\n\r\n  var cards = self.$cards.querySelectorAll('.flex-item');\r\n  for (var c=0; c<cards.length; c++){\r\n    var t = String(cards[c].getAttribute('data-type-lc') || 'default');\r\n    cards[c].style.display = (active.length === 0) ? 'none' : (active.indexOf(t) > -1 ? '' : 'none');\r\n  }\r\n}\r\n\r\n/* ---------- Render HTML (SIN wrapper extra) ---------- */\r\nfunction renderHtml(devices){\r\n  var html = '';\r\n\r\n  for (var i=0; i<devices.length; i++){\r\n    var it = devices[i];\r\n\r\n    var sev = String(it.alarm_severity || 'off').trim().toLowerCase();\r\n    var alarmOn = isAlarmActive(sev);\r\n\r\n    var typeLc = it.typeLc ? String(it.typeLc) : 'default';\r\n    if (!typeLc) typeLc = 'default';\r\n    var typeDisplay = getDisplayType(it.typeRaw);\r\n\r\n    // chip alarma (solo si hay alarma)\r\n    var alarmChip = '';\r\n    if (alarmOn) {\r\n      var txt = it.alarm_type ? (String(it.alarm_type)) : sev;\r\n      alarmChip = '<i class=\"chip chip--sev sev--'+esc(sev)+'\">'+esc(txt)+'</i>';\r\n    }\r\n\r\n    // rows desde visibleKeys\r\n    var infoHtml = '';\r\n    if (it.visibleKeys && typeof it.visibleKeys === 'object') {\r\n      var keys = Object.keys(it.visibleKeys);\r\n      keys.sort(function(a,b){\r\n        var la = (it.visibleKeys[a] && it.visibleKeys[a].label) ? String(it.visibleKeys[a].label).toLowerCase() : a.toLowerCase();\r\n        var lb = (it.visibleKeys[b] && it.visibleKeys[b].label) ? String(it.visibleKeys[b].label).toLowerCase() : b.toLowerCase();\r\n        if (la < lb) return -1; if (la > lb) return 1; return 0;\r\n      });\r\n\r\n      for (var k=0; k<keys.length; k++){\r\n        var key = keys[k];\r\n        var meta = it.visibleKeys[key] || {};\r\n        var label = meta.label || key;\r\n        var unit  = meta.unit || '';\r\n        var raw   = it.values[key];\r\n        var vStr  = fmtValue(raw);\r\n        if (unit && vStr !== 'N/A') vStr = vStr + ' ' + unit;\r\n\r\n        infoHtml += ''\r\n          + '<div class=\"kv\">'\r\n          +   '<div class=\"k\">'+esc(label)+'</div>'\r\n          +   '<div class=\"v\">'+esc(vStr)+'</div>'\r\n          + '</div>';\r\n      }\r\n    } else {\r\n      infoHtml = '<div class=\"kv\"><div class=\"k\">visibleKeys</div><div class=\"v\">No configurado</div></div>';\r\n    }\r\n\r\n    html += ''\r\n      + '<div class=\"flex-item\" data-id=\"'+esc(it.id)+'\" data-type-lc=\"'+esc(typeLc)+'\">'\r\n      + '  <div class=\"card\" data-sev=\"'+esc(alarmOn ? sev : 'off')+'\">'\r\n      + '    <div class=\"content\">'\r\n      + '      <h2 class=\"device-title title--lg\">'+esc(it.label)+'</h2>'\r\n      + '      <div class=\"device-subtitle\">'+esc(typeDisplay)+'</div>'\r\n      + '      <div class=\"chips\">'+alarmChip+'</div>'\r\n      + '      <div class=\"info-block\">'+infoHtml+'</div>'\r\n      + '    </div>'\r\n      + '    <div class=\"card-buttons\">'\r\n      + '      <button class=\"button\" type=\"button\" data-action=\"goToDetails\" data-entity-id=\"'+esc(it.id)+'\" data-entity-label=\"'+esc(it.label)+'\">VER DETALLES</button>'\r\n      + '    </div>'\r\n      + '  </div>'\r\n      + '</div>';\r\n  }\r\n\r\n  return html;\r\n}",
      "settingsForm" : [ ],
      "dataKeySettingsForm" : [ ],
      "defaultConfig" : "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Attributes card\",\"decimals\":null}"
    },
    "externalId" : null,
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "f317ce20-1260-11f1-8fce-55f815a3848a"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}