{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "test",
    "name" : "console test",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "latest",
      "sizeX" : 4,
      "sizeY" : 2,
      "resources" : [ ],
      "templateHtml" : "<div class=\"console-wrap\">\r\n  <div class=\"row\">\r\n    <input class=\"cmd\"\r\n           placeholder=\"Command (e.g. TelePeriod 60 | TelePeriod | WebPassword pepe)\"\r\n           [(ngModel)]=\"cmd\"\r\n           (keyup.enter)=\"send()\"/>\r\n    <button mat-raised-button color=\"primary\" (click)=\"send()\">Send</button>\r\n    <button mat-button (click)=\"clear()\">Clear</button>\r\n  </div>\r\n\r\n  <div class=\"hint\">\r\n    Sends one-way RPC via <code>controlApi.sendOneWayCommand()</code> using Gateway built-in <code>set</code>.\r\n  </div>\r\n\r\n  <pre class=\"log\">{{log}}</pre>\r\n</div>",
      "templateCss" : ".console-wrap {\r\n  height: 100%;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n}\r\n\r\n.row {\r\n  display: flex;\r\n  gap: 8px;\r\n  align-items: center;\r\n}\r\n\r\n.cmd {\r\n  flex: 1;\r\n  padding: 10px 12px;\r\n  border: 1px solid rgba(0,0,0,.2);\r\n  border-radius: 8px;\r\n  font-size: 14px;\r\n}\r\n\r\n.hint {\r\n  font-size: 12px;\r\n  opacity: 0.75;\r\n}\r\n\r\n.log {\r\n  flex: 1;\r\n  margin: 0;\r\n  padding: 12px;\r\n  border-radius: 10px;\r\n  background: rgba(0,0,0,.04);\r\n  overflow: auto;\r\n  white-space: pre-wrap;\r\n}",
      "controllerScript" : "self.onInit = function () {\r\n  self.ctx.$scope.cmd = \"\";\r\n  self.ctx.$scope.log = \"\";\r\n\r\n  function append(line) {\r\n    const ts = new Date().toISOString();\r\n    self.ctx.$scope.log = `[${ts}] ${line}\\n` + self.ctx.$scope.log;\r\n    self.ctx.detectChanges();\r\n  }\r\n\r\n  function parseSingleCommand(s) {\r\n    // Soporta:\r\n    // - \"TelePeriod 35\"\r\n    // - \"TelePeriod=35\"\r\n    // - \"TelePeriod: 35\"\r\n    // - \"TelePeriod\" (GET)\r\n    // - \"Power ON\"\r\n    s = (s || \"\").trim();\r\n    if (!s) return null;\r\n\r\n    let m = s.match(/^([^=:\\s]+)\\s*(?:=|:)\\s*(.*)$/);\r\n    if (m) {\r\n      return { cmd: (m[1] || \"\").trim(), value: (m[2] || \"\").trim() };\r\n    }\r\n\r\n    const parts = s.split(/\\s+/);\r\n    const cmd = (parts.shift() || \"\").trim();\r\n    const value = parts.join(\" \").trim(); // value puede tener espacios\r\n    return { cmd, value };\r\n  }\r\n\r\n  function buildSetParams(cmd, valueOrEmpty) {\r\n    // GET: tu gateway requiere value=\" \" (espacio)\r\n    const v = (valueOrEmpty && valueOrEmpty.length) ? String(valueOrEmpty) : \" \";\r\n    return `requestTopicExpression=cmnd/\\${deviceName}/${cmd};value=${v};`;\r\n  }\r\n\r\n  function splitBySemicolon(input) {\r\n    // Divide por ';' y limpia vacíos\r\n    // Ej: \"Power ON; TelePeriod 60; WebPassword pepe;\" -> [\"Power ON\", \"TelePeriod 60\", \"WebPassword pepe\"]\r\n    return String(input)\r\n      .split(\";\")\r\n      .map(p => p.trim())\r\n      .filter(Boolean);\r\n  }\r\n\r\n  self.ctx.$scope.clear = function () {\r\n    self.ctx.$scope.log = \"\";\r\n    self.ctx.detectChanges();\r\n  };\r\n\r\n  self.ctx.$scope.send = function () {\r\n    const timeout = (self.ctx.settings && self.ctx.settings.timeout) || 5000;\r\n    const method = \"set\";\r\n\r\n    const raw = (self.ctx.$scope.cmd || \"\").trim();\r\n    if (!raw) {\r\n      append(\"Nothing to send.\");\r\n      return;\r\n    }\r\n\r\n    // Si el usuario puso ';', lo tratamos como “multi-comando”\r\n    const parts = splitBySemicolon(raw);\r\n\r\n    // Si no hay ';', igual parts va a tener 1 item\r\n    if (!parts.length) {\r\n      append(\"Nothing to send.\");\r\n      return;\r\n    }\r\n\r\n    append(`> ${method} (${parts.length} command${parts.length > 1 ? \"s\" : \"\"})`);\r\n\r\n    // Mandamos un set por cada comando\r\n    parts.forEach((piece, idx) => {\r\n      const parsed = parseSingleCommand(piece);\r\n      if (!parsed || !parsed.cmd) {\r\n        append(`ERROR in part #${idx + 1}: \"${piece}\"`);\r\n        return;\r\n      }\r\n\r\n      const cmd = parsed.cmd;\r\n      const value = parsed.value; // \"\" => GET\r\n      const params = buildSetParams(cmd, value);\r\n\r\n      append(value && value.length\r\n        ? `  [${idx + 1}] ${cmd} ${value}`\r\n        : `  [${idx + 1}] ${cmd} (GET)`\r\n      );\r\n      append(`  RAW: ${params}`);\r\n\r\n      const obs = self.ctx.controlApi.sendOneWayCommand(method, params, timeout);\r\n      obs.subscribe(\r\n        function () { append(`  [${idx + 1}] OK`); },\r\n        function (rej) { append(`  [${idx + 1}] ERROR: ${rej.status} ${rej.statusText || \"\"}`.trim()); }\r\n      );\r\n    });\r\n  };\r\n};",
      "dataKeySettingsForm" : [ ],
      "settingsDirective" : "tb-gpio-control-widget-settings",
      "defaultConfig" : "{\"targetDeviceAliases\":[],\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"parseGpioStatusFunction\":\"return body[pin] === true;\",\"gpioStatusChangeRequest\":{\"method\":\"setGpioStatus\",\"paramsBody\":\"{\\n   \\\"pin\\\": \\\"{$pin}\\\",\\n   \\\"enabled\\\": \\\"{$enabled}\\\"\\n}\"},\"requestTimeout\":500,\"switchPanelBackgroundColor\":\"#b71c1c\",\"gpioStatusRequest\":{\"method\":\"getGpioStatus\",\"paramsBody\":\"{}\"},\"gpioList\":[{\"pin\":1,\"label\":\"GPIO 1\",\"row\":0,\"col\":0,\"_uniqueKey\":0},{\"pin\":2,\"label\":\"GPIO 2\",\"row\":0,\"col\":1,\"_uniqueKey\":1},{\"pin\":3,\"label\":\"GPIO 3\",\"row\":1,\"col\":0,\"_uniqueKey\":2}]},\"title\":\"Basic GPIO Control\",\"datasources\":[],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}}}"
    },
    "externalId" : null,
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "9b62ac20-0d17-11f1-8fce-55f815a3848a"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}